<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>图网络在健康监测中的应用</title>
      <link href="/2024/01/05/jian-kang-jian-ce/"/>
      <url>/2024/01/05/jian-kang-jian-ce/</url>
      
        <content type="html"><![CDATA[<h1 id="第十七章-图网络在健康监测中的应用"><a href="#第十七章-图网络在健康监测中的应用" class="headerlink" title="第十七章 图网络在健康监测中的应用"></a>第十七章 图网络在健康监测中的应用</h1><p>本章将带您探索构图方法以及图网络在健康监测中的应用实例。我们将学习如何创建自己的图数据，并深入了解图数据与其他类型数据最大的不同之处。在实践中，我们将使用PyTorch和PyG（PyTorch Geometric Library）。PyG是一个基于PyTorch的库，专门用图数据，同时也是一个用于快速实现表征学习的框架。</p><p><strong>Requirments:</strong></p><ul><li>Python 3</li><li>PyTorch</li><li>PyTorch Geometric</li></ul><h2 id="17-1-图数据的创建"><a href="#17-1-图数据的创建" class="headerlink" title="17.1 图数据的创建"></a>17.1 图数据的创建</h2><p>PyTorch Geometric是一个用于图神经网络的库，它的数据类型包括节点和边。如果要构建图，需要使<code>torch_geometric.data.Data</code>类。该类包含了5个属性，但不是所有属性都必须的，可以根据实际需要进行组合：</p><ul><li><code>data.x</code>用于存储每个节点的特征，形状为[num_nodes, num_node_features]；</li><li><code>data.edge_index</code>用于存储节点之间的边，形状为[2, num_edges]；</li><li><code>data.pos</code>用于存储节点的坐标，形状为[num_nodes, num_dimensions]；</li><li><code>data.y</code>用于存储样本标签。如果每个节点都有标签，则形状为[num_nodes, *]；如果整张图只有一个标签，则形状为[1, *]；</li><li><code>data.edge_attr</code>用于存储边的特征，形状为[num_edges, num_edge_features]。</li></ul><p>现在，我们来创建一个图数据示例：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token keyword">from</span> torch_geometric<span class="token punctuation">.</span>data <span class="token keyword">import</span> Data<span class="token comment"># 创建节点特征</span>x <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token comment"># 创建边索引</span>edge_index <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                    <span class="token comment"># 起始点</span>                           <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span> <span class="token comment"># 终止点</span><span class="token comment"># 创建节点坐标</span>pos <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token comment"># 创建标签</span>y <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token comment"># 创建边特征</span>edge_attr <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.8</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token comment"># 创建一张图</span>data <span class="token operator">=</span> Data<span class="token punctuation">(</span>x<span class="token operator">=</span>x<span class="token punctuation">,</span> edge_index<span class="token operator">=</span>edge_index<span class="token punctuation">,</span> pos<span class="token operator">=</span>pos<span class="token punctuation">,</span> y<span class="token operator">=</span>y<span class="token punctuation">,</span> edge_attr<span class="token operator">=</span>edge_attr<span class="token punctuation">)</span><span class="token comment"># 创建图数据集</span>dataset<span class="token operator">=</span><span class="token punctuation">[</span>data<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上述代码创建了一个包含3个节点和4条边的图数据。每个节点有2个特征，每条边有2个特征。可以根据需要调整节点数量、特征数量以及边的连接关系。</p><p>现在看看我们创建的图数据的结构吧。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Dataset:</span><span class="token interpolation"><span class="token punctuation">{</span>dataset<span class="token punctuation">}</span></span><span class="token string">:'</span></span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Number of graphs:</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>dataset<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Number of nodes:</span><span class="token interpolation"><span class="token punctuation">{</span>data<span class="token punctuation">.</span>num_nodes<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Number of edges:</span><span class="token interpolation"><span class="token punctuation">{</span>data<span class="token punctuation">.</span>num_edges<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token keyword">import</span> networkx <span class="token keyword">as</span> nx<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt<span class="token keyword">from</span> torch_geometric<span class="token punctuation">.</span>utils <span class="token keyword">import</span> to_networkx<span class="token comment"># 画图函数</span><span class="token keyword">def</span> <span class="token function">visualize_graph</span><span class="token punctuation">(</span>G<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">:</span>    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    plt<span class="token punctuation">.</span>xticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    plt<span class="token punctuation">.</span>yticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    nx<span class="token punctuation">.</span>draw_networkx<span class="token punctuation">(</span>G<span class="token punctuation">,</span> pos<span class="token operator">=</span>nx<span class="token punctuation">.</span>spring_layout<span class="token punctuation">(</span>G<span class="token punctuation">,</span> seed<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">,</span> with_labels<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>                     node_color<span class="token operator">=</span>color<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">"Set2"</span><span class="token punctuation">)</span>    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 使用networkx进行可视化展示</span>G <span class="token operator">=</span> to_networkx<span class="token punctuation">(</span>data<span class="token punctuation">,</span> to_undirected<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>visualize_graph<span class="token punctuation">(</span>G<span class="token punctuation">,</span> color<span class="token operator">=</span>data<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python">Dataset<span class="token punctuation">:</span><span class="token punctuation">[</span>Data<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> edge_index<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> edge_attr<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pos<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">:</span>Number of graphs<span class="token punctuation">:</span><span class="token number">1</span>Number of nodes<span class="token punctuation">:</span><span class="token number">3</span>Number of edges<span class="token punctuation">:</span><span class="token number">4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><img src="D:\file_folder\图网络实战17\可视化图.png" alt="可视化图" style="zoom:50%;"><h2 id="17-2-构图方法"><a href="#17-2-构图方法" class="headerlink" title="17.2 构图方法"></a>17.2 构图方法</h2><p>在旋转机械健康监测的场景中，将欧几里得结构的时序信号转换为非欧几里得结构的图数据结构十分重要。具体而言，即给本身没有连接关系的时序信号赋予连接关系。目前常用的方法主要分为基于先验知识、基于优化算法和基于统计量的构图方法。</p><ul><li>基于先验知识的构图方法： 依靠领域专家的经验和先验知识，将时序信号之间的连接关系构建成图结构。这种方法在某些领域中特别有效，因为节点之间的连接关系可以通过相关领域的专业知识来辅助确定。</li><li>基于统计量的构图方法：这是目前应用最广泛的构图方法之一，它利用时序信号之间的相似性来构建图结构。</li><li>基于优化算法的构图方法： 该方法使用各种优化算法（例如遗传算法）来寻找最佳的连接方式，以构建图结构。通过优化算法的迭代过程，可以自动学习节点之间的联系。然而，由于计算复杂度较高，这种方法需要大量的计算资源。</li></ul><p>本章主要介绍三种基于统计量的构图方法：基于K临近构图，基于余弦相似度构图和基于路径构图。这些方法的目标是根据数据之间的统计量来构建图结构。</p><h3 id="17-2-1基于K邻近的构图方法"><a href="#17-2-1基于K邻近的构图方法" class="headerlink" title="17.2.1基于K邻近的构图方法"></a>17.2.1基于K邻近的构图方法</h3><p>基于K邻近的图构建方法：是一种将数据点之间的相似性转化为图结构的方法。它通过选择一个合适的距离度量方法和计算每个数据点与其他所有数据点之间的距离或相似度，来确定每个数据点的K个最近邻居，并构建一个无向加权图，以此更好地捕捉数据点之间的关系。常用的距离度量有欧氏距离、曼哈顿距离、切比雪夫距离、堪培拉距离等，其中，在旋转机械故障诊断中，欧氏距离是最常用的且表现较好。欧式距离的计算公式如下式所示。<br>$$<br>\quad D(x, y)=\sqrt{\left(\sum_{\mu=1}^n\left|x_\mu-y_\mu\right|^2\right)}<br>$$</p><p>基于K邻近的构图方法，每个节点之间的边缘权重可以通过高斯核权重函数来估计，该函数定义为：<br>$$<br>e_{i j}=\exp \left(-\frac{\left|\left(\boldsymbol{x}_i, \boldsymbol{x}_j\right)\right|^2}{2 \zeta^2}\right), \quad \boldsymbol{x}_j \in \mathrm{Ne}\left(\boldsymbol{x}<em>i\right)<br>$$<br>其中$e</em>{i j}$表示节点${x}_i$和节点${x}_j$之间的边缘权重。$\zeta$是高斯核的带宽。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token keyword">from</span> math <span class="token keyword">import</span> sqrt<span class="token keyword">from</span> scipy<span class="token punctuation">.</span>spatial<span class="token punctuation">.</span>distance <span class="token keyword">import</span> pdist<span class="token keyword">def</span> <span class="token function">KNN_classify</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> X_set<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    K最近邻分类    :param k: 邻居的数量    :param X_set: 数据集    :param x: 要查找最近邻居的数据点    :return: node_index, topK_x    """</span>    <span class="token comment"># 计算x与X_set中所有其他点之间的距离</span>    distances <span class="token operator">=</span> <span class="token punctuation">[</span>sqrt<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x_compare <span class="token operator">-</span> x<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x_compare <span class="token keyword">in</span> X_set<span class="token punctuation">]</span>    nearest <span class="token operator">=</span> np<span class="token punctuation">.</span>argsort<span class="token punctuation">(</span>distances<span class="token punctuation">)</span>              <span class="token comment"># 找到最近邻居的索引</span>    node_index <span class="token operator">=</span> <span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> nearest<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>     <span class="token comment"># 排除最近的邻居本身</span>    topK_x <span class="token operator">=</span> <span class="token punctuation">[</span>X_set<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> nearest<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 获取最近邻居的坐标</span>    <span class="token keyword">return</span> node_index<span class="token punctuation">,</span> topK_x<span class="token keyword">def</span> <span class="token function">KNN_weigt</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> topK_x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    计算K最近邻的权重    :param x: 数据点    :param topK_x: K个最近邻居的坐标    :return: w    """</span>    distance <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    v_1 <span class="token operator">=</span> x    data_2 <span class="token operator">=</span> topK_x    <span class="token comment"># 计算x与每个邻居之间的距离</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data_2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        v_2 <span class="token operator">=</span> data_2<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        combine <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">[</span>v_1<span class="token punctuation">,</span> v_2<span class="token punctuation">]</span><span class="token punctuation">)</span>        likely <span class="token operator">=</span> pdist<span class="token punctuation">(</span>combine<span class="token punctuation">,</span> <span class="token string">'euclidean'</span><span class="token punctuation">)</span>  <span class="token comment"># 计算了数据集 combine 中各个点之间的欧几里得距离</span>        distance<span class="token punctuation">.</span>append<span class="token punctuation">(</span>likely<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment"># 使用高斯核函数计算权重</span>    beata <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>distance<span class="token punctuation">)</span>    w <span class="token operator">=</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>distance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>beata <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> w<span class="token keyword">def</span> <span class="token function">KNN_attr</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''    构建K最近邻图    :param data: 数据集    :param k: 邻居的数量    :return: edge_index, edge_fea    '''</span>    edge_raw0 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    edge_raw1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    edge_fea <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token comment"># 遍历每个数据点</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        x <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        <span class="token comment"># 找到最近邻居及其权重</span>        node_index<span class="token punctuation">,</span> topK_x <span class="token operator">=</span> KNN_classify<span class="token punctuation">(</span>k<span class="token punctuation">,</span> data<span class="token punctuation">,</span> x<span class="token punctuation">)</span>        loal_weigt <span class="token operator">=</span> KNN_weigt<span class="token punctuation">(</span>x<span class="token punctuation">,</span> topK_x<span class="token punctuation">)</span>        <span class="token comment"># 创建本地索引并添加到边的列表中</span>        local_index <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">+</span> i        edge_raw0 <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>edge_raw0<span class="token punctuation">,</span> local_index<span class="token punctuation">)</span><span class="token punctuation">)</span>        edge_raw1 <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>edge_raw1<span class="token punctuation">,</span> node_index<span class="token punctuation">)</span><span class="token punctuation">)</span>        edge_fea <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>edge_fea<span class="token punctuation">,</span> loal_weigt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 创建边权重特征</span>    edge_index <span class="token operator">=</span> <span class="token punctuation">[</span>edge_raw0<span class="token punctuation">,</span> edge_raw1<span class="token punctuation">]</span>  <span class="token comment"># 创建边连接关系</span>    <span class="token keyword">return</span> edge_index<span class="token punctuation">,</span> edge_fea<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>代码中的函数 <code>KNN_classify</code> 主要用于执行K最近邻分类，函数 <code>KNN_weigt</code> 用于计算K最近邻的权重，函数 <code>KNN_attr</code> 用于构建K最近邻图的边索引和特征。</p><p>函数 <code>KNN_classify</code> 的具体流程如下：</p><ul><li>首先，计算数据点 <code>x</code> 与数据集 <code>X_set</code> 中所有其他点之间的距离，并将结果保存在 <code>distances</code> 列表中。</li><li>使用 <code>np.argsort</code> 函数找到 <code>distances</code> 中距离最近的邻居的索引，并保存在 <code>nearest</code> 中。</li><li>根据参数 <code>k</code>，排除最近的邻居本身，将其余的邻居索引保存在 <code>node_index</code> 中。</li><li>获取最近邻居的坐标，将其保存在 <code>topK_x</code> 中。</li><li>最后，返回邻居的索引 <code>node_index</code> 和最近邻居的坐标 <code>topK_x</code>。</li></ul><p>函数 <code>KNN_weigt</code> 的具体流程如下：</p><ul><li>首先，初始化一个空列表 <code>distance</code>。</li><li>获取数据点 <code>x</code> 和 K个最近邻居的坐标 <code>topK_x</code>。</li><li>遍历 <code>topK_x</code> 中的每个邻居坐标 <code>v_2</code>。</li><li>将数据点 <code>x</code> 和邻居坐标 <code>v_2</code> 合并为一个矩阵 <code>combine</code>。</li><li>使用 <code>pdist</code> 函数计算合并后的矩阵中各个点之间的欧几里得距离，并保存在 <code>likely</code> 中。</li><li>将计算得到的距离添加到 <code>distance</code> 列表中。</li><li>计算平均距离 <code>beata</code>。</li><li>使用高斯核函数计算权重 <code>w</code>，其中权重值根据距离计算而来。</li><li>最后，返回权重 <code>w</code>。</li></ul><p>函数 <code>KNN_attr</code> 的具体流程如下：</p><ul><li>首先，初始化三个空数组 <code>edge_raw0</code>、<code>edge_raw1</code> 和 <code>edge_fea</code>，用于存储边的索引和特征。</li><li>遍历数据集 <code>data</code> 中的每个数据点 <code>x</code>。</li><li>调用 <code>KNN_classify</code> 函数找到最近邻居的索引 <code>node_index</code> 和最近邻居的坐标 <code>topK_x</code>。</li><li>调用 <code>KNN_weigt</code> 函数计算最近邻的权重 <code>loal_weigt</code>。</li><li>创建本地索引 <code>local_index</code>，并将其添加到边的列表 <code>edge_raw0</code> 中。</li><li>将最近邻的索引 <code>node_index</code> 添加到边的列表 <code>edge_raw1</code> 中。</li><li>将最近邻的权重 <code>loal_weigt</code> 添加到边的列表 <code>edge_fea</code> 中。</li><li>最后，将边的索引 <code>edge_raw0</code> 和 <code>edge_raw1</code> 合并为一个列表 <code>edge_index</code>，并返回边的索引和特征 <code>edge_index</code>、<code>edge_fea</code>。</li></ul><h3 id="17-2-2-基于余弦相似度的构图方法"><a href="#17-2-2-基于余弦相似度的构图方法" class="headerlink" title="17.2.2 基于余弦相似度的构图方法"></a>17.2.2 基于余弦相似度的构图方法</h3><p>基于余弦相似度的图构建方法与K邻近有一定的相似性，它们都是通过数据点之间的相似性来构建图结构的方法。然而，它们在具体实现上存在一些关键差异。基于余弦相似度的图构建方法使用余弦相似度作为相似性度量标准。该方法首先计算数据点之间的余弦相似度，然后选择相似度最高的K个邻居来构建图结构。当两个节点的特征向量夹角余弦值越大时，表示它们的相似性越高，关联性也更强。两个变量与的余弦相似度计算公式如下式所示。相似度的取值范围在[-1,1]。通过这种方式，可以将相似性转化为图中的连接关系，并利用图算法进行进一步的分析和处理。<br>$$<br>\cos (x, y)=\frac{\sum_{i=1}^n x_i y_i}{\sqrt{\sum_{i=1}^n x_i^2} \sqrt{\sum_{i=1}^n y_i^2}}<br>$$</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token keyword">from</span> scipy<span class="token punctuation">.</span>spatial<span class="token punctuation">.</span>distance <span class="token keyword">import</span> pdist<span class="token keyword">import</span> copy<span class="token keyword">def</span> <span class="token function">cal_sim</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''    计算两个样本之间的相似性并生成边的索引和特征    :param data: 数据集    :param s1: 样本1的索引    :param s2: 样本2的索引    :return: 边索引，边特征    '''</span>    edge_index <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 边的索引</span>    edge_feature <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 边的特征</span>    <span class="token keyword">if</span> s1 <span class="token operator">!=</span> s2<span class="token punctuation">:</span>  <span class="token comment"># 排除自环边</span>        v_1 <span class="token operator">=</span> data<span class="token punctuation">[</span>s1<span class="token punctuation">]</span>  <span class="token comment"># 获取样本1的特征向量</span>        v_2 <span class="token operator">=</span> data<span class="token punctuation">[</span>s2<span class="token punctuation">]</span>  <span class="token comment"># 获取样本2的特征向量</span>        combine <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">[</span>v_1<span class="token punctuation">,</span> v_2<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 将两个特征向量合并为一个矩阵</span>        likely <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> pdist<span class="token punctuation">(</span>combine<span class="token punctuation">,</span> <span class="token string">'cosine'</span><span class="token punctuation">)</span>  <span class="token comment"># 计算两个样本之间的余弦相似度，使用1减去余弦相似度来得到相似性</span>        <span class="token keyword">if</span> likely<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># 如果相似性大于等于0（即两个样本相似），则生成一条边</span>            w <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment"># 边的权重</span>            edge_index<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>s1<span class="token punctuation">)</span>  <span class="token comment"># 记录边的起始节点</span>            edge_index<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>s2<span class="token punctuation">)</span>  <span class="token comment"># 记录边的结束节点</span>            edge_feature<span class="token punctuation">.</span>append<span class="token punctuation">(</span>w<span class="token punctuation">)</span>  <span class="token comment"># 记录边的权重作为特征</span>    <span class="token keyword">return</span> edge_index<span class="token punctuation">,</span> edge_feature<span class="token keyword">def</span> <span class="token function">Radius_attr</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''    构建基于半径的图的边索引和特征    :param data: 数据集    :return: 边的索引和特征    '''</span>    s1 <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 样本索引范围</span>    s2 <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>s1<span class="token punctuation">)</span>  <span class="token comment"># 深拷贝样本索引范围</span>    edge_index <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 边的索引</span>    edge_fe <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 边的特征</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> s1<span class="token punctuation">:</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> s2<span class="token punctuation">:</span>            local_edge<span class="token punctuation">,</span> w <span class="token operator">=</span> cal_sim<span class="token punctuation">(</span>data<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">)</span>  <span class="token comment"># 计算两个样本之间的相似性并生成边的索引和权重特征</span>            edge_index <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>edge_index<span class="token punctuation">,</span> local_edge<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 将局部边的索引添加到总体边的索引中</span>            <span class="token keyword">if</span> <span class="token builtin">any</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 如果边的特征不为空</span>                edge_fe<span class="token punctuation">.</span>append<span class="token punctuation">(</span>w<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 添加边的特征</span>    <span class="token keyword">return</span> edge_index<span class="token punctuation">,</span> edge_fe<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>代码中的函数 <code>cal_sim</code> 主要用于计算两个样本之间的余弦相似度，并根据余弦相似度生成边的索引和特征。函数 <code>Radius_attr</code> 则是构建基于半径的图的边索引和特征。</p><p>函数 <code>cal_sim</code> 的具体流程如下：</p><ul><li>首先，根据给定的样本索引 <code>s1</code> 和 <code>s2</code>，获取对应的样本特征向量 <code>v_1</code> 和 <code>v_2</code>。</li><li>将两个特征向量合并为一个矩阵 <code>combine</code>。</li><li>使用余弦相似度度量（1减去余弦相似度），计算两个样本之间的相似性 <code>likely</code>。</li><li>如果相似性大于等于0，则生成一条边，其中边的权重 <code>w</code> 设置为1。</li><li>最后，返回边的索引和特征。</li></ul><p>函数 <code>Radius_attr</code> 的具体流程如下：</p><ul><li>首先，定义样本索引范围 <code>s1</code> 和 <code>s2</code>。</li><li>初始化边的索引和特征为空数组。</li><li>遍历所有可能的样本对 <code>(i, j)</code>，其中 <code>i</code> 为 <code>s1</code> 中的索引，<code>j</code> 为 <code>s2</code> 中的索引。</li><li>对于每个样本对 <code>(i, j)</code>，调用 <code>cal_sim</code> 函数计算两个样本之间的相似性并生成边的索引和特征。</li><li>将局部边的索引添加到总体边的索引中。</li><li>如果边的特征不为空，则将边的特征添加到总体边的特征中。</li><li>返回最终的边的索引和特征。</li></ul><h3 id="17-2-3-基于有向路径图的构图方法"><a href="#17-2-3-基于有向路径图的构图方法" class="headerlink" title="17.2.3 基于有向路径图的构图方法"></a>17.2.3 基于有向路径图的构图方法</h3><p>有向路径图是用于描述节点之间有向关系的图形表示方法。在有向路径图中，每个节点代表一个实体或概念，每条有向边表示一种特定的关系。有向路径图通常需要足够的先验知识或者专家经验，以流程图建模法构建图结构，并保持与故障特征的良好对应关系。常用的算法包括最短路径算法、最长路径算法和环检测算法等，可以通过这些算法来解决相关的问题。最简单的有向路径图就是按照时间顺序相连，而边缘权重可以通过高斯核权重函数</p><p>$$<br>e_{i j}=\exp \left(-\frac{\left|\left(\boldsymbol{x}_i, \boldsymbol{x}_j\right)\right|^2}{2 \zeta^2}\right), \quad \boldsymbol{x}_j \in \mathrm{Ne}\left(\boldsymbol{x}<em>i\right)<br>$$<br>其中$e</em>{i j}$表示节点${x}_i$和节点${x}_j$之间的边缘权重。$\zeta$是高斯核的带宽。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token keyword">from</span> scipy<span class="token punctuation">.</span>spatial<span class="token punctuation">.</span>distance <span class="token keyword">import</span> pdist<span class="token keyword">def</span> <span class="token function">Path_attr</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''    定义函数 Path_attr，用于计算路径属性。    参数：data：输入数据    返回值：edge_index：边索引    w：权重    '''</span>    <span class="token comment"># 初始化边索引</span>    edge_index <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span>    <span class="token comment"># 构建边索引</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        edge_index<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>        edge_index<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token comment"># 计算相邻节点之间的欧氏距离</span>    distance <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        v_1 <span class="token operator">=</span> data<span class="token punctuation">[</span>j<span class="token punctuation">]</span>        v_2 <span class="token operator">=</span> data<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>        combine <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">[</span>v_1<span class="token punctuation">,</span> v_2<span class="token punctuation">]</span><span class="token punctuation">)</span>        likely <span class="token operator">=</span> pdist<span class="token punctuation">(</span>combine<span class="token punctuation">,</span> <span class="token string">'euclidean'</span><span class="token punctuation">)</span>        distance<span class="token punctuation">.</span>append<span class="token punctuation">(</span>likely<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment"># 计算高斯核权重</span>    beata <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>distance<span class="token punctuation">)</span>    w <span class="token operator">=</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>distance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>beata <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">#Gussion kernel高斯核</span>    <span class="token keyword">return</span> edge_index<span class="token punctuation">,</span> w<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>代码中函数 <code>Path_attr</code> ，用于计算路径属性。该函数接受一个参数 <code>data</code>，表示输入的数据。</p><p>该函数主要实现以下功能：</p><ol><li>初始化边索引 <code>edge_index</code>，用于表示节点之间的连接关系。</li><li>根据输入的数据计算相邻节点间的欧氏距离，保存在列表 <code>distance</code> 中。</li><li>根据计算得到的欧氏距离和高斯核公式计算权重，并将结果保存在变量 <code>w</code> 里。</li><li>返回两个值，分别是边索引 <code>edge_index</code> 和权重 <code>w</code>。</li></ol><h2 id="17-3-故障诊断中的图网络应用案例"><a href="#17-3-故障诊断中的图网络应用案例" class="headerlink" title="17.3 故障诊断中的图网络应用案例"></a>17.3 故障诊断中的图网络应用案例</h2><p>故障诊断是通过检测、分析和判断，识别出设备或系统中出现的故障，并提供相应的解决方案或建议的过程。在现代工业生产中，故障诊断至关重要，它能够显著提高设备运行效率，减少生产线停机时间，从而降低生产成本。随着图网络的发展，其在故障诊断领域的应用日益受到重视，本章将深入探讨如何利用图网络构建一个基础的旋转机械故障诊断应用案例。从数据出发，通过分析和预测，实现旋转机械健康状态的故障诊断。</p><p>在实际的工业环境中，由于大量的传感器被用于监测系统状态，因此故障诊断领域的数据集十分丰富。为更好地适应这些数据的特点并提高模型的准确性，本章将采用图级分类任务。</p><h3 id="17-3-1-数据集简介"><a href="#17-3-1-数据集简介" class="headerlink" title="17.3.1 数据集简介"></a>17.3.1 数据集简介</h3><p>凯斯西储大学的轴承数据集（Case Western Reserve University Bearing Data Set）是一个公开的机器学习与故障诊断研究数据集。此数据集由凯斯西储大学的机械工程系与轴承制造商联手创建，旨在为轴承故障诊断算法的研究与开发提供一个标准化的数据集。该数据集涵盖了各种不同故障模式与工作条件下的轴承振动数据。</p><img src="D:\file_folder\图网络实战17\凯斯西储大学轴承试验台.png" style="zoom:60%;"><p>数据集的原始链接为<a href="https://engineering.case.edu/bearingdatacenter/welcome">此处</a>。这个数据集主要涉及旋转机械系统中轴承的振动信号数据。轴承在旋转机械中扮演着关键角色，通常在高速、高负荷的环境下运作，因此容易发生故障。这些故障可能是由轴承内部的各种缺陷引起，如加工或组装过程中的形变。外部环境因素也可能导致各种故障，如变形、磨损或裂纹。通过监测轴承的振动信号，我们可以获取轴承运行状态的信息，进而进行故障诊断和预测。</p><p>为了方便赘述，对原始数据集进行了重构，<a href="https://pan.baidu.com/s/1IoyQQB_8zuPDD2IP-ILb5g">链接地址</a>，提取码：xcdx</p><p>其中CRWU凯斯西储大学轴承数据下，包含4个文件夹</p><p><img src="D:\file_folder\图网络实战17\数据集路径.png" alt="数据集路径"></p><p>分别表示<strong>12k 驱动端轴承故障数据，12k风扇端轴承故障数据,48k 驱动端轴承故障数据，正常基线数据</strong></p><p>前三个文件夹主要包括三个子文件夹,分别代表三种故障部位，Ball：滚珠圈的振动数据；Inner Race：内圈的振动数据；Outer Race：外圈的振动数据；</p><p><img src="D:\file_folder\图网络实战17\子目录数据集路径.png" alt="子目录数据集路径"></p><p>每个故障部位的子文件夹包括多个故障直径，通常用来描述故障的大小和程度，单位为英寸，1英寸=25.4mm</p><ul><li>0.007英寸=7 mils =0.1778 mm</li><li>0.014英寸=14 mils =0.3556 mm</li><li>0.021英寸=21 mils =0.5334 mm</li><li>0.028英寸=28 mils =1.016 mm</li></ul><p><img src="D:\file_folder\图网络实战17\故障程度.png" alt="故障程度"></p><p>每个故障等级下，根据不同的电机负载情况，划分了0/1/2/3等多种负载情况下的数据。</p><p><img src="D:\file_folder\图网络实战17\故障负载.png" alt="故障负载"></p><h3 id="17-3-2-数据预处理"><a href="#17-3-2-数据预处理" class="headerlink" title="17.3.2 数据预处理"></a>17.3.2 数据预处理</h3><p>由于Matlab具有高效的数据处理能力，并且可以处理原始的.m文件格式，因此我们将使用Matlab来处理数据集。</p><pre class="line-numbers language-matlab" data-language="matlab"><code class="language-matlab"><span class="token comment">%============Arrange data ===========%</span><span class="token comment">% 1、清除</span>clear<span class="token punctuation">;</span>    <span class="token comment">% 从工作区中删除项目，释放系统内存  </span>clc<span class="token punctuation">;</span>      <span class="token comment">% 清理命令窗口</span>close all <span class="token comment">% 移除指定绘画</span><span class="token comment">% 2、保存路径</span>savepath <span class="token operator">=</span> <span class="token string">'D:\file_folder\联邦图网络\code\data\CWRU\'</span><span class="token punctuation">;</span><span class="token comment">% 3、数据来源路径</span>Datapath<span class="token operator">=</span><span class="token string">'D:\file_folder\联邦图网络\code\data\CWRU\'</span><span class="token punctuation">;</span><span class="token comment">% %=====Label-1 Data----负载L0=====%%</span><span class="token comment">% 4、加载数据--负载L0</span>a1<span class="token operator">=</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Datapath<span class="token punctuation">,</span><span class="token string">'B007.mat'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">% 故障模式B007</span>a2<span class="token operator">=</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Datapath<span class="token punctuation">,</span><span class="token string">'B014.mat'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">% 故障模式B014</span>a3<span class="token operator">=</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Datapath<span class="token punctuation">,</span><span class="token string">'B021.mat'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">% 故障模式B021</span>b1<span class="token operator">=</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Datapath<span class="token punctuation">,</span><span class="token string">'IR007.mat'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">% 故障模式IR007</span>b2<span class="token operator">=</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Datapath<span class="token punctuation">,</span><span class="token string">'IR014.mat'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">% 故障模式IR014</span>b3<span class="token operator">=</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Datapath<span class="token punctuation">,</span><span class="token string">'IR021.mat'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">% 故障模式IR021</span>c1<span class="token operator">=</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Datapath<span class="token punctuation">,</span><span class="token string">'OR007_6.mat'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">% 故障模式OR007_6</span>c2<span class="token operator">=</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Datapath<span class="token punctuation">,</span><span class="token string">'OR014_6.mat'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">% 故障模式OR014_6</span>c3<span class="token operator">=</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Datapath<span class="token punctuation">,</span><span class="token string">'OR021_6.mat'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">% 故障模式OR021_6</span>d1<span class="token operator">=</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Datapath<span class="token punctuation">,</span><span class="token string">'Normal.mat'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">% 正常运行状态</span><span class="token comment">% 5、数据切片</span>L<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token number">i</span><span class="token operator">=</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">450</span>    <span class="token function">Data0</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span> <span class="token operator">=</span> d1<span class="token punctuation">.</span><span class="token function">X099_DE_time</span><span class="token punctuation">(</span><span class="token punctuation">(</span>L<span class="token operator">-</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span>L<span class="token operator">*</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">250</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">Data1</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span> <span class="token operator">=</span> a1<span class="token punctuation">.</span><span class="token function">X107_DE_time</span><span class="token punctuation">(</span><span class="token punctuation">(</span>L<span class="token operator">-</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span>L<span class="token operator">*</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">250</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">Data2</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span> <span class="token operator">=</span> a2<span class="token punctuation">.</span><span class="token function">X187_DE_time</span><span class="token punctuation">(</span><span class="token punctuation">(</span>L<span class="token operator">-</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span>L<span class="token operator">*</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">250</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">Data3</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span> <span class="token operator">=</span> a3<span class="token punctuation">.</span><span class="token function">X224_DE_time</span><span class="token punctuation">(</span><span class="token punctuation">(</span>L<span class="token operator">-</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span>L<span class="token operator">*</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">250</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">Data4</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span> <span class="token operator">=</span> b1<span class="token punctuation">.</span><span class="token function">X120_DE_time</span><span class="token punctuation">(</span><span class="token punctuation">(</span>L<span class="token operator">-</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span>L<span class="token operator">*</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">250</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">Data5</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span> <span class="token operator">=</span> b2<span class="token punctuation">.</span><span class="token function">X171_DE_time</span><span class="token punctuation">(</span><span class="token punctuation">(</span>L<span class="token operator">-</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span>L<span class="token operator">*</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">250</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">Data6</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span> <span class="token operator">=</span> b3<span class="token punctuation">.</span><span class="token function">X211_DE_time</span><span class="token punctuation">(</span><span class="token punctuation">(</span>L<span class="token operator">-</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span>L<span class="token operator">*</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">250</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">Data7</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span> <span class="token operator">=</span> c1<span class="token punctuation">.</span><span class="token function">X132_DE_time</span><span class="token punctuation">(</span><span class="token punctuation">(</span>L<span class="token operator">-</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span>L<span class="token operator">*</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">250</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">Data8</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span> <span class="token operator">=</span> c2<span class="token punctuation">.</span><span class="token function">X199_DE_time</span><span class="token punctuation">(</span><span class="token punctuation">(</span>L<span class="token operator">-</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span>L<span class="token operator">*</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">250</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">Data9</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span> <span class="token operator">=</span> c3<span class="token punctuation">.</span><span class="token function">X236_DE_time</span><span class="token punctuation">(</span><span class="token punctuation">(</span>L<span class="token operator">-</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span>L<span class="token operator">*</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">250</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">end</span><span class="token comment">% 6、标签设定</span><span class="token function">Data0</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">513</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token function">Data1</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">513</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token function">Data2</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">513</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token function">Data3</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">513</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span><span class="token function">Data4</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">513</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span><span class="token function">Data5</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">513</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span><span class="token function">Data6</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">513</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">;</span><span class="token function">Data7</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">513</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">;</span><span class="token function">Data8</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">513</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span><span class="token function">Data9</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">513</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">;</span><span class="token comment">% 7、整合数据</span>Data <span class="token operator">=</span> <span class="token punctuation">[</span>Data0<span class="token punctuation">;</span>Data1<span class="token punctuation">;</span>Data2<span class="token punctuation">;</span>Data3<span class="token punctuation">;</span>Data4<span class="token punctuation">;</span>Data5<span class="token punctuation">;</span>Data6<span class="token punctuation">;</span>Data7<span class="token punctuation">;</span>Data8<span class="token punctuation">;</span>Data9<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">% 8、保存文件</span>savepath1<span class="token operator">=</span><span class="token punctuation">[</span>savepath<span class="token punctuation">,</span><span class="token string">'L1750.mat'</span><span class="token punctuation">]</span><span class="token function">save</span><span class="token punctuation">(</span>savepath1<span class="token punctuation">,</span><span class="token string">'Data'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="17-3-3-构造图级别图数据"><a href="#17-3-3-构造图级别图数据" class="headerlink" title="17.3.3 构造图级别图数据"></a>17.3.3 构造图级别图数据</h3><p>数据整合结束后，我们将采用上述构图方法去构造图数据。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> torch_geometric<span class="token punctuation">.</span>data <span class="token keyword">import</span> Data  <span class="token comment"># 导入Data模块，用于构造图数据</span><span class="token keyword">from</span> scipy<span class="token punctuation">.</span>io <span class="token keyword">import</span> loadmat  <span class="token comment"># 导入loadmat函数，用于加载.mat文件</span><span class="token keyword">import</span> torch  <span class="token comment"># 导入torch模块，用于张量操作和构造数据集</span><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> train_test_split  <span class="token comment"># 导入train_test_split函数，用于划分训练集和测试集</span><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np  <span class="token comment"># 导入numpy模块，用于构造数据集</span><span class="token keyword">from</span> math <span class="token keyword">import</span> sqrt <span class="token comment"># 导入sqrt模块，用于构造图数据集</span><span class="token keyword">from</span> scipy<span class="token punctuation">.</span>spatial<span class="token punctuation">.</span>distance <span class="token keyword">import</span> pdist <span class="token comment"># 计算数据集各个点之间的欧几里得距离</span><span class="token keyword">def</span> <span class="token function">KNN_classify</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> X_set<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    K最近邻分类    :param k: 邻居的数量    :param X_set: 数据集    :param x: 要查找最近邻居的数据点    :return: node_index, topK_x    """</span>    <span class="token comment"># 计算x与X_set中所有其他点之间的距离</span>    distances <span class="token operator">=</span> <span class="token punctuation">[</span>sqrt<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x_compare <span class="token operator">-</span> x<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x_compare <span class="token keyword">in</span> X_set<span class="token punctuation">]</span>    nearest <span class="token operator">=</span> np<span class="token punctuation">.</span>argsort<span class="token punctuation">(</span>distances<span class="token punctuation">)</span>              <span class="token comment"># 找到最近邻居的索引</span>    node_index <span class="token operator">=</span> <span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> nearest<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>     <span class="token comment"># 排除最近的邻居本身</span>    topK_x <span class="token operator">=</span> <span class="token punctuation">[</span>X_set<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> nearest<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 获取最近邻居的坐标</span>    <span class="token keyword">return</span> node_index<span class="token punctuation">,</span> topK_x<span class="token keyword">def</span> <span class="token function">KNN_weigt</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> topK_x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    计算K最近邻的权重    :param x: 数据点    :param topK_x: K个最近邻居的坐标    :return: w    """</span>    distance <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    v_1 <span class="token operator">=</span> x    data_2 <span class="token operator">=</span> topK_x    <span class="token comment"># 计算x与每个邻居之间的距离</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data_2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        v_2 <span class="token operator">=</span> data_2<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        combine <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">[</span>v_1<span class="token punctuation">,</span> v_2<span class="token punctuation">]</span><span class="token punctuation">)</span>        likely <span class="token operator">=</span> pdist<span class="token punctuation">(</span>combine<span class="token punctuation">,</span> <span class="token string">'euclidean'</span><span class="token punctuation">)</span>  <span class="token comment"># 计算数据集 combine 中各个点之间的欧几里得距离</span>        distance<span class="token punctuation">.</span>append<span class="token punctuation">(</span>likely<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment"># 使用高斯核函数计算权重</span>    beata <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>distance<span class="token punctuation">)</span>    w <span class="token operator">=</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>distance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>beata <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> w<span class="token keyword">def</span> <span class="token function">KNN_attr</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''    构建K最近邻图    :param data: 数据集    :param k: 邻居的数量    :return: edge_index, edge_fea    '''</span>    edge_raw0 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    edge_raw1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    edge_fea <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token comment"># 遍历每个数据点</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        x <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        <span class="token comment"># 找到最近邻居及其权重</span>        node_index<span class="token punctuation">,</span> topK_x <span class="token operator">=</span> KNN_classify<span class="token punctuation">(</span>k<span class="token punctuation">,</span> data<span class="token punctuation">,</span> x<span class="token punctuation">)</span>        loal_weigt <span class="token operator">=</span> KNN_weigt<span class="token punctuation">(</span>x<span class="token punctuation">,</span> topK_x<span class="token punctuation">)</span>        <span class="token comment"># 创建本地索引并添加到边的列表中</span>        local_index <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">+</span> i        edge_raw0 <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>edge_raw0<span class="token punctuation">,</span> local_index<span class="token punctuation">)</span><span class="token punctuation">)</span>        edge_raw1 <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>edge_raw1<span class="token punctuation">,</span> node_index<span class="token punctuation">)</span><span class="token punctuation">)</span>        edge_fea <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>edge_fea<span class="token punctuation">,</span> loal_weigt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 创建边权重特征</span>    edge_index <span class="token operator">=</span> <span class="token punctuation">[</span>edge_raw0<span class="token punctuation">,</span> edge_raw1<span class="token punctuation">]</span>  <span class="token comment"># 创建边连接关系</span>    <span class="token keyword">return</span> edge_index<span class="token punctuation">,</span> edge_fea<span class="token keyword">def</span> <span class="token function">data_graph</span><span class="token punctuation">(</span><span class="token builtin">dir</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    构造图数据    :param dir: 路径    :return: train_dataset, test_dataset    """</span>    m2 <span class="token operator">=</span> loadmat<span class="token punctuation">(</span><span class="token builtin">dir</span> <span class="token operator">+</span> <span class="token string">"L1750.mat"</span><span class="token punctuation">)</span>  <span class="token comment"># 加载L1750.mat文件到变量m2</span>    s <span class="token operator">=</span> m2<span class="token punctuation">[</span><span class="token string">"Data"</span><span class="token punctuation">]</span>  <span class="token comment"># 从m2中获取名为"Data_1"的变量，赋值给s</span>    x <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">512</span><span class="token punctuation">]</span>  <span class="token comment"># 提取s的前512列作为特征x</span>    y <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">]</span>  <span class="token comment"># 提取s的第512列作为标签y</span>    data_x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 用于存储数据的列表</span>    label_y <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 用于存储标签的列表</span>    Edge_index <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 用于存储边索引的列表</span>    dataset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 用于存储最终的数据集的列表</span>        <span class="token comment"># 循环处理数据，每10行为一组</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        data_x<span class="token punctuation">.</span>append<span class="token punctuation">(</span>x<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">:</span>i <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 将特征x的每10行作为一个数据点，添加到data_x中</span>        label_y<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>y<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 将标签y的每10行的第一个元素添加到label中</span>        edge_index<span class="token punctuation">,</span> edge_fea <span class="token operator">=</span> KNN_attr<span class="token punctuation">(</span>data_x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>  <span class="token comment"># 调用KNN_attr函数计算边索引和边特征</span>        Edge_index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>edge_index<span class="token punctuation">)</span>  <span class="token comment"># 将边索引添加到Edge_index中</span>        data_x <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>data_x<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span>  <span class="token comment"># 将data_x转换为torch张量</span>    label_y <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>label_y<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span>  <span class="token comment"># 将label转换为torch张量</span>    Edge_index <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>Edge_index<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>  <span class="token comment"># 将Edge_index转换为torch张量</span>        <span class="token comment"># 循环创建Data对象，并添加到dataset中</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        data <span class="token operator">=</span> Data<span class="token punctuation">(</span>x<span class="token operator">=</span>data_x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> y<span class="token operator">=</span>label_y<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> edge_index<span class="token operator">=</span>Edge_index<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 创建Data对象，包含特征x、标签y和边索引edge_index</span>        dataset<span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># 将data添加到dataset中</span>        train_dataset<span class="token punctuation">,</span> test_dataset <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># 划分训练集和测试集</span>        <span class="token keyword">return</span> train_dataset<span class="token punctuation">,</span> test_dataset  <span class="token comment"># 返回训练集和测试集</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    <span class="token comment"># 获取数据集</span>    <span class="token builtin">dir</span><span class="token operator">=</span><span class="token string">r"D:\file_folder\联邦图网络\code\data\CWRU\\"</span>    train_dataset<span class="token punctuation">,</span> test_dataset<span class="token operator">=</span>data_graph<span class="token punctuation">(</span><span class="token builtin">dir</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="17-3-4-图数据可视化"><a href="#17-3-4-图数据可视化" class="headerlink" title="17.3.4 图数据可视化"></a>17.3.4 图数据可视化</h3><p>为了更进一步看到生成的图数据，本章将进行可视化操作，清晰看到生成的图数据</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> networkx <span class="token keyword">as</span> nx<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt<span class="token keyword">from</span> torch_geometric<span class="token punctuation">.</span>utils <span class="token keyword">import</span> to_networkx<span class="token comment"># 画图函数</span><span class="token keyword">def</span> <span class="token function">visualize_graph</span><span class="token punctuation">(</span>G<span class="token punctuation">)</span><span class="token punctuation">:</span>    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span><span class="token punctuation">)</span>    plt<span class="token punctuation">.</span>xticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    plt<span class="token punctuation">.</span>yticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    nx<span class="token punctuation">.</span>draw_networkx<span class="token punctuation">(</span>G<span class="token punctuation">,</span> pos<span class="token operator">=</span>nx<span class="token punctuation">.</span>spring_layout<span class="token punctuation">(</span>G<span class="token punctuation">,</span> seed<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">,</span> with_labels<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>                      cmap<span class="token operator">=</span><span class="token string">"Set2"</span><span class="token punctuation">)</span>    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 使用networkx进行可视化展示</span>G <span class="token operator">=</span> to_networkx<span class="token punctuation">(</span>train_dataset<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> to_undirected<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>visualize_graph<span class="token punctuation">(</span>G<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="D:\file_folder\图网络实战17\图级的数据可视化.png" alt="图级的数据可视化"></p><h3 id="17-3-5-构造图网络"><a href="#17-3-5-构造图网络" class="headerlink" title="17.3.5 构造图网络"></a>17.3.5 构造图网络</h3><p>图数据构造结束之后，接下来，我们构造图网络，采用PyTorch Geometric的GCNConv层构建</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F<span class="token keyword">from</span> torch_geometric<span class="token punctuation">.</span>nn <span class="token keyword">import</span> GCNConv<span class="token keyword">import</span> torch_geometric<span class="token punctuation">.</span>nn <span class="token keyword">as</span> pyg_nn<span class="token keyword">import</span> torch<span class="token keyword">class</span> <span class="token class-name">Net</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Net<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">520</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> GCNConv<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span>  <span class="token comment"># 第一个图卷积层，输入特征维度为512，输出特征维度为300</span>        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> GCNConv<span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>  <span class="token comment"># 第二个图卷积层，输入特征维度为300，输出特征维度为200</span>        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>  <span class="token comment"># 全连接层，输入特征维度为200，输出特征维度为100</span>        self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>GELU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>GELU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 多层全连接层</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>        x<span class="token punctuation">,</span> edge_index<span class="token punctuation">,</span> batch <span class="token operator">=</span> data<span class="token punctuation">.</span>x<span class="token punctuation">,</span> data<span class="token punctuation">.</span>edge_index<span class="token punctuation">,</span> data<span class="token punctuation">.</span>batch         x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">,</span> edge_index<span class="token punctuation">)</span>        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        x <span class="token operator">=</span> F<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>x<span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> training<span class="token operator">=</span>self<span class="token punctuation">.</span>training<span class="token punctuation">)</span> <span class="token comment"># Dropout层，防止过拟合</span>        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>x<span class="token punctuation">,</span> edge_index<span class="token punctuation">)</span>        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        x <span class="token operator">=</span> pyg_nn<span class="token punctuation">.</span>global_max_pool<span class="token punctuation">(</span>x<span class="token punctuation">,</span> batch<span class="token punctuation">)</span> <span class="token comment"># 全局最大池化</span>        x <span class="token operator">=</span> self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        x <span class="token operator">=</span> self<span class="token punctuation">.</span>fc2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        <span class="token keyword">return</span> F<span class="token punctuation">.</span>log_softmax<span class="token punctuation">(</span>x<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># 输出层使用log_softmax进行分类</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="17-3-6-模型训练与预测"><a href="#17-3-6-模型训练与预测" class="headerlink" title="17.3.6 模型训练与预测"></a>17.3.6 模型训练与预测</h3><p>图数据构造结束之后，接下来，我们将利用图网络进行数据分析和预测。通过对图网络的深入挖掘，我们可以发现数据中的异常模式和趋势，进而利用图网络进行故障诊断，代码如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> torch_geometric<span class="token punctuation">.</span>data <span class="token keyword">import</span> Data  <span class="token comment"># 导入Data模块，用于构造图数据</span><span class="token keyword">from</span> scipy<span class="token punctuation">.</span>io <span class="token keyword">import</span> loadmat  <span class="token comment"># 导入loadmat函数，用于加载.mat文件</span><span class="token keyword">import</span> torch  <span class="token comment"># 导入torch模块，用于张量操作和构造数据集</span><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> train_test_split  <span class="token comment"># 导入train_test_split函数，用于划分训练集和测试集</span><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np <span class="token keyword">from</span> math <span class="token keyword">import</span> sqrt  <span class="token keyword">from</span> scipy<span class="token punctuation">.</span>spatial<span class="token punctuation">.</span>distance <span class="token keyword">import</span> pdist <span class="token keyword">from</span> torch_geometric<span class="token punctuation">.</span>loader <span class="token keyword">import</span> DataLoader<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F<span class="token keyword">from</span> torch_geometric<span class="token punctuation">.</span>nn <span class="token keyword">import</span> GCNConv<span class="token keyword">import</span> torch_geometric<span class="token punctuation">.</span>nn <span class="token keyword">as</span> pyg_nn<span class="token comment"># 定义K最近邻分类函数</span><span class="token keyword">def</span> <span class="token function">KNN_classify</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> X_set<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    K最近邻分类    :param k: 邻居的数量    :param X_set: 数据集    :param x: 要查找最近邻居的数据点    :return: node_index, topK_x    """</span>    <span class="token comment"># 计算x与X_set中所有其他点之间的距离</span>    distances <span class="token operator">=</span> <span class="token punctuation">[</span>sqrt<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x_compare <span class="token operator">-</span> x<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x_compare <span class="token keyword">in</span> X_set<span class="token punctuation">]</span>    nearest <span class="token operator">=</span> np<span class="token punctuation">.</span>argsort<span class="token punctuation">(</span>distances<span class="token punctuation">)</span>  <span class="token comment"># 找到最近邻居的索引</span>    node_index <span class="token operator">=</span> <span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> nearest<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span>k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 排除最近的邻居本身</span>    topK_x <span class="token operator">=</span> <span class="token punctuation">[</span>X_set<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> nearest<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span>k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 获取最近邻居的坐标</span>    <span class="token keyword">return</span> node_index<span class="token punctuation">,</span> topK_x<span class="token comment"># 定义计算K最近邻权重函数</span><span class="token keyword">def</span> <span class="token function">KNN_weigt</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> topK_x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    计算K最近邻的权重    :param x: 数据点    :param topK_x: K个最近邻居的坐标    :return: w    """</span>    distance <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    v_1 <span class="token operator">=</span> x    data_2 <span class="token operator">=</span> topK_x    <span class="token comment"># 计算x与每个邻居之间的距离</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data_2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        v_2 <span class="token operator">=</span> data_2<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        combine <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">[</span>v_1<span class="token punctuation">,</span> v_2<span class="token punctuation">]</span><span class="token punctuation">)</span>        likely <span class="token operator">=</span> pdist<span class="token punctuation">(</span>combine<span class="token punctuation">,</span> <span class="token string">'euclidean'</span><span class="token punctuation">)</span>  <span class="token comment"># 计算数据集 combine 中各个点之间的欧几里得距离</span>        distance<span class="token punctuation">.</span>append<span class="token punctuation">(</span>likely<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment"># 使用高斯核函数计算权重</span>    beata <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>distance<span class="token punctuation">)</span>    w <span class="token operator">=</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>distance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>beata <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> w<span class="token comment"># 定义构建K最近邻图函数</span><span class="token keyword">def</span> <span class="token function">KNN_attr</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''    构建K最近邻图    :param data: 数据集    :param k: 邻居的数量    :return: edge_index, edge_fea    '''</span>    edge_raw0 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    edge_raw1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    edge_fea <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token comment"># 遍历每个数据点</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        x <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        <span class="token comment"># 找到最近邻居及其权重</span>        node_index<span class="token punctuation">,</span> topK_x <span class="token operator">=</span> KNN_classify<span class="token punctuation">(</span>k<span class="token punctuation">,</span> data<span class="token punctuation">,</span> x<span class="token punctuation">)</span>        loal_weigt <span class="token operator">=</span> KNN_weigt<span class="token punctuation">(</span>x<span class="token punctuation">,</span> topK_x<span class="token punctuation">)</span>        <span class="token comment"># 创建本地索引并添加到边的列表中</span>        local_index <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">+</span> i        edge_raw0 <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>edge_raw0<span class="token punctuation">,</span> local_index<span class="token punctuation">)</span><span class="token punctuation">)</span>        edge_raw1 <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>edge_raw1<span class="token punctuation">,</span> node_index<span class="token punctuation">)</span><span class="token punctuation">)</span>        edge_fea <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>edge_fea<span class="token punctuation">,</span> loal_weigt<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 创建边权重特征</span>    edge_index <span class="token operator">=</span> <span class="token punctuation">[</span>edge_raw0<span class="token punctuation">,</span> edge_raw1<span class="token punctuation">]</span>  <span class="token comment"># 创建边连接关系</span>    <span class="token keyword">return</span> edge_index<span class="token punctuation">,</span> edge_fea<span class="token comment"># 定义构造图数据函数</span><span class="token keyword">def</span> <span class="token function">data_graph</span><span class="token punctuation">(</span><span class="token builtin">dir</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    构造图数据    :param dir: 路径    :return: train_dataset, test_dataset    """</span>    m2 <span class="token operator">=</span> loadmat<span class="token punctuation">(</span><span class="token builtin">dir</span> <span class="token operator">+</span> <span class="token string">"L1750.mat"</span><span class="token punctuation">)</span>  <span class="token comment"># 加载L1750.mat文件到变量m2</span>    s <span class="token operator">=</span> m2<span class="token punctuation">[</span><span class="token string">"Data"</span><span class="token punctuation">]</span>  <span class="token comment"># 从m2中获取名为"Data_1"的变量，赋值给s</span>    x <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">512</span><span class="token punctuation">]</span>  <span class="token comment"># 提取s的前512列作为特征x</span>    y <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">]</span>  <span class="token comment"># 提取s的第512列作为标签y</span>    data_x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 用于存储数据的列表</span>    label_y <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 用于存储标签的列表</span>    Edge_index <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 用于存储边索引的列表</span>    dataset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 用于存储最终的数据集的列表</span>    <span class="token comment"># 循环处理数据，每10行为一组</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        data_x<span class="token punctuation">.</span>append<span class="token punctuation">(</span>x<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">:</span>i <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 将特征x的每10行作为一个数据点，添加到data_x中</span>        label_y<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>y<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 将标签y的每10行的第一个元素添加到label中</span>        edge_index<span class="token punctuation">,</span> edge_fea <span class="token operator">=</span> KNN_attr<span class="token punctuation">(</span>data_x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>  <span class="token comment"># 调用KNN_attr函数计算边索引和边特征</span>        Edge_index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>edge_index<span class="token punctuation">)</span>  <span class="token comment"># 将边索引添加到Edge_index中</span>    data_x <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>data_x<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span>  <span class="token comment"># 将data_x转换为torch张量</span>    label_y <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>label_y<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span>  <span class="token comment"># 将label转换为torch张量</span>    Edge_index <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>Edge_index<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>  <span class="token comment"># 将Edge_index转换为torch张量</span>    <span class="token comment"># 循环创建Data对象，并添加到dataset中</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        data <span class="token operator">=</span> Data<span class="token punctuation">(</span>x<span class="token operator">=</span>data_x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> y<span class="token operator">=</span>label_y<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> edge_index<span class="token operator">=</span>Edge_index<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 创建Data对象，包含特征x、标签y和边索引edge_index</span>        dataset<span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># 将data添加到dataset中</span>    train_dataset<span class="token punctuation">,</span> test_dataset <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># 划分训练集和测试集</span>    <span class="token keyword">return</span> train_dataset<span class="token punctuation">,</span> test_dataset  <span class="token comment"># 返回训练集和测试集</span><span class="token comment"># 定义GCN模型</span><span class="token keyword">class</span> <span class="token class-name">Net</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Net<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">520</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> GCNConv<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span>  <span class="token comment"># 第一个图卷积层，输入特征维度为512，输出特征维度为300</span>        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> GCNConv<span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>  <span class="token comment"># 第二个图卷积层，输入特征维度为300，输出特征维度为200</span>        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>  <span class="token comment"># 全连接层，输入特征维度为200，输出特征维度为100</span>        self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>GELU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>GELU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 多层全连接层</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>        x<span class="token punctuation">,</span> edge_index<span class="token punctuation">,</span> batch <span class="token operator">=</span> data<span class="token punctuation">.</span>x<span class="token punctuation">,</span> data<span class="token punctuation">.</span>edge_index<span class="token punctuation">,</span> data<span class="token punctuation">.</span>batch        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">,</span> edge_index<span class="token punctuation">)</span>        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        x <span class="token operator">=</span> F<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>x<span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> training<span class="token operator">=</span>self<span class="token punctuation">.</span>training<span class="token punctuation">)</span> <span class="token comment"># Dropout层，防止过拟合</span>        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>x<span class="token punctuation">,</span> edge_index<span class="token punctuation">)</span>        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        x <span class="token operator">=</span> pyg_nn<span class="token punctuation">.</span>global_max_pool<span class="token punctuation">(</span>x<span class="token punctuation">,</span> batch<span class="token punctuation">)</span> <span class="token comment"># 全局最大池化</span>        x <span class="token operator">=</span> self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        x <span class="token operator">=</span> self<span class="token punctuation">.</span>fc2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        <span class="token keyword">return</span> F<span class="token punctuation">.</span>log_softmax<span class="token punctuation">(</span>x<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># 输出层使用log_softmax进行分类</span>    <span class="token comment"># 定义训练函数</span><span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">,</span> train_dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    训练模型    :param train_loader: 训练数据加载器    :param train_dataset: 训练数据集    :return: 平均损失值 (loss_all / len(train_dataset))    """</span>    model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 设置模型为训练模式</span>    loss_all <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># 初始化总损失为0</span>    <span class="token keyword">for</span> data <span class="token keyword">in</span> train_loader<span class="token punctuation">:</span>  <span class="token comment"># 遍历训练数据集</span>        data <span class="token operator">=</span> data<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># 将数据移动到指定设备（如GPU）</span>        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 清零优化器的梯度</span>        output <span class="token operator">=</span> model<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># 运行模型获取输出</span>        label <span class="token operator">=</span> data<span class="token punctuation">.</span>y<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># 获取标签并移动到指定设备</span>        loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>output<span class="token punctuation">,</span> label<span class="token punctuation">)</span>  <span class="token comment"># 计算损失</span>        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 反向传播计算梯度</span>        loss_all <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 累加损失</span>        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 根据梯度更新模型参数</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>loss_all <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_dataset<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 返回平均损失值</span><span class="token comment"># 定义测试函数</span><span class="token keyword">def</span> <span class="token function">evaluate</span><span class="token punctuation">(</span>test_loader<span class="token punctuation">,</span> test_dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    评估模型    :param test_loader: 测试数据加载器    :param test_dataset: 测试数据集    :return: 准确率    """</span>    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 设置模型为评估模式</span>    correct <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># 初始化正确预测数量为0</span>    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 禁用梯度计算</span>        <span class="token keyword">for</span> data <span class="token keyword">in</span> test_loader<span class="token punctuation">:</span>  <span class="token comment"># 遍历测试数据集</span>            data <span class="token operator">=</span> data<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># 将数据移动到指定设备（如GPU）</span>            out <span class="token operator">=</span> model<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># 获取模型输出</span>            pred <span class="token operator">=</span> out<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 获取预测标签</span>            correct <span class="token operator">+=</span> pred<span class="token punctuation">.</span>eq<span class="token punctuation">(</span>data<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 统计正确预测数量</span>        accuracy <span class="token operator">=</span> correct <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>test_dataset<span class="token punctuation">)</span>  <span class="token comment"># 计算准确率</span>    <span class="token keyword">return</span> accuracy  <span class="token comment"># 返回准确率</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    <span class="token comment"># 1.获取数据集</span>    <span class="token builtin">dir</span> <span class="token operator">=</span> <span class="token string">r"D:\file_folder\联邦图网络\code\data\CWRU\\"</span>    train_dataset<span class="token punctuation">,</span> test_dataset <span class="token operator">=</span> data_graph<span class="token punctuation">(</span><span class="token builtin">dir</span><span class="token punctuation">)</span>  <span class="token comment"># 获取训练集和测试集</span>    train_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>train_dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">24</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># 创建训练数据加载器</span>    test_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>test_dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>test_dataset<span class="token punctuation">)</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># 创建测试数据加载器</span>    <span class="token comment"># 2.模型建立</span>    device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cuda'</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">'cpu'</span><span class="token punctuation">)</span>  <span class="token comment"># 设置设备（GPU或CPU）</span>    model <span class="token operator">=</span> Net<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># 创建模型并将其移动到指定设备上</span>    criterion <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>NLLLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 定义损失函数</span>    optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">8e-5</span><span class="token punctuation">,</span> betas<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token number">0.99</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 定义优化器</span>    <span class="token comment"># 3.迭代训练</span>    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 迭代训练</span>        loss <span class="token operator">=</span> train<span class="token punctuation">(</span>train_loader<span class="token punctuation">,</span> train_dataset<span class="token punctuation">)</span>  <span class="token comment"># 训练模型并获取平均损失值</span>        <span class="token keyword">if</span> epoch <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># 每10个epoch输出一次训练信息</span>            acc <span class="token operator">=</span> evaluate<span class="token punctuation">(</span>test_loader<span class="token punctuation">,</span> test_dataset<span class="token punctuation">)</span>  <span class="token comment"># 测试模型并获取准确率</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Epoch:%d|train loss:%.4f|test accuracy:%.4f"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> acc<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 输出结果信息</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="17-4-寿命预测中的图网络应用案例"><a href="#17-4-寿命预测中的图网络应用案例" class="headerlink" title="17.4 寿命预测中的图网络应用案例"></a>17.4 寿命预测中的图网络应用案例</h2><p>寿命预测是一种基于设备或系统的历史数据和运行状态，利用模型对其未来寿命或剩余寿命进行预测的技术。这种预测可以帮助企业制定更为精准的设备维护计划，提前预防可能出现的故障，降低维修成本，延长设备使用寿命，提高生产效率。随着工业设备日益复杂化，对设备寿命预测的准确性要求也越来越高。图网络作为一种强大的数据处理工具，在寿命预测领域的应用也日益受到关注。在本章中，我们将深入探讨如何利用图网络构建一个基础的旋转机械寿命预测应用案例。通过这一应用案例，我们将从实际数据出发，利用图网络进行数据分析和预测，从而实现旋转机械健康状态的寿命预测。</p><p>在实际的工业环境中，由于全寿命数据的获取条件极为严格，因此全寿命的数据集十分稀缺。为了更好地适应这些数据的特性并提高模型的准确性，本章将采用节点级分类任务。</p><h3 id="17-4-1-数据集简介"><a href="#17-4-1-数据集简介" class="headerlink" title="17.4.1 数据集简介"></a>17.4.1 数据集简介</h3><p>IEEE PHM 2012 数据挑战赛有IEEE 可靠性协会和 FEMTO-ST 研究所组织，该挑战赛提供了<strong>轴承的剩余寿命预测</strong>的数据集，实验平台如下：</p><img src="D:\file_folder\图网络实战17\IEEE PHM 2012挑战赛.png" style="zoom:80%;"><p><a href="https://github.com/wkzs111/phm-ieee-2012-data-challenge-dataset">数据集获取</a>，有三种工况，具体训练集和测试集特征如下所示：</p><p>①：负载4000N，转速1800rpm;</p><p>②：负载4200N，转速1650rpm;</p><p>③：负载5000N，转速1500rpm；</p><img src="D:\file_folder\图网络实战17\phn2012数据集.png" alt="phm2012" style="zoom:70%;"><p>振动文件为acc_xxxxx.csv，温度文件为temp_xxxxx.csv</p><p><strong>振动信号(水平方向和垂直方向)：</strong></p><p>1.采样频率：25.6KHz；<br>2.采集设置：10秒采集一次，一次采集0.1s，即一次采集2560个点；示意图如下 温度信号 采样频率：10Hz;采集设置：每分钟采集600点</p><p><strong>每个文件的列标签：</strong></p><p><img src="D:\file_folder\图网络实战17\iee2012数据解释.png"></p><p><strong>温度信号：</strong></p><p>1.采样频率：10Hz;</p><p>2.采集设置：每分钟采集600点；</p><p><strong>注意：该数据为比赛数据，所有存放数据的文件夹有三个，一个是训练数据(Learning_set)，一个是比赛时采用的截断数据(Test_set)，一个是全寿命数据(Full_Test_set)，这个Full_Test_set是Test_set的完整版。</strong></p><h3 id="17-4-2-数据预处理"><a href="#17-4-2-数据预处理" class="headerlink" title="17.4.2 数据预处理"></a>17.4.2 数据预处理</h3><p>由于Matlab具有高效的数据处理能力，并且可以处理原始的.m文件格式，因此我们将使用Matlab来处理数据集，考虑到荷载是在水平方向上施加的情况，故选择了水平振动信号来反映轴承退化信息。</p><pre class="line-numbers language-matlab" data-language="matlab"><code class="language-matlab"><span class="token comment">%% 批量读取IEEE PHM 2012轴承全寿命数据</span>clcclear allclose all<span class="token comment">%% 1、设置文件路径</span>file_path <span class="token operator">=</span>  <span class="token string">'G:\联邦图网络\code\data\phm2012\原始数据\phm-ieee-2012-data-challenge-dataset\Full_Test_Set\Bearing1_5\'</span><span class="token punctuation">;</span> <span class="token comment">% 文件夹路径</span>savepath <span class="token operator">=</span> <span class="token string">'G:\联邦图网络\code\data\phm2012\带标签特征\'</span><span class="token punctuation">;</span><span class="token comment">%% 2、整合全寿命水平振动加速度信号</span>csv_acc_path_list <span class="token operator">=</span> <span class="token function">dir</span><span class="token punctuation">(</span><span class="token function">strcat</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span><span class="token string">'acc*.csv'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">% 获取该文件夹中所有csv格式的文件</span>csv_acc_num <span class="token operator">=</span> <span class="token function">length</span><span class="token punctuation">(</span>csv_acc_path_list<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">% 获取文件总数量</span><span class="token keyword">if</span> csv_acc_num <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token comment">% 有满足条件的文件</span>    <span class="token keyword">for</span> <span class="token number">j</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span>csv_acc_num <span class="token comment">% 逐一读取文件</span>        csv_acc_name <span class="token operator">=</span> <span class="token function">csv_acc_path_list</span><span class="token punctuation">(</span><span class="token number">j</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span> <span class="token comment">% 文件名</span>        csv_acc <span class="token operator">=</span>  <span class="token function">csvread</span><span class="token punctuation">(</span><span class="token function">strcat</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span>csv_acc_name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">% 读取csv文件中的数据</span>        <span class="token function">csv_acc_data</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">j</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token function">csv_acc</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">% 存储读取的数据水平加速度信号到csv_acc_data变量中</span>        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token string">'%d %d %s\n'</span><span class="token punctuation">,</span>csv_acc_num<span class="token punctuation">,</span><span class="token number">j</span><span class="token punctuation">,</span><span class="token function">strcat</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span>csv_acc_name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">% 显示正在处理的文件名</span>    <span class="token keyword">end</span><span class="token keyword">end</span><span class="token comment">%% 3、全寿命振动信号的时域图</span>csv_temp_data<span class="token operator">=</span><span class="token function">reshape</span><span class="token punctuation">(</span>csv_acc_data<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token function">prod</span><span class="token punctuation">(</span><span class="token function">size</span><span class="token punctuation">(</span>csv_acc_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">'</span><span class="token punctuation">;</span> <span class="token comment">% 重塑矩阵形状</span>figure<span class="token punctuation">;</span><span class="token function">plot</span><span class="token punctuation">(</span>csv_temp_data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">title</span><span class="token punctuation">(</span><span class="token string">'水平振动信号'</span><span class="token punctuation">)</span><span class="token comment">%% 4、数据特征提取</span><span class="token punctuation">[</span><span class="token operator">~</span><span class="token punctuation">,</span> cols<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">size</span><span class="token punctuation">(</span>csv_acc_data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">%获取数据形状</span>Time<span class="token operator">=</span><span class="token number">1</span><span class="token operator">:</span>cols<span class="token punctuation">;</span><span class="token comment">%时间戳</span>Max<span class="token operator">=</span><span class="token function">max</span><span class="token punctuation">(</span>csv_acc_data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">%1.最大值</span>Min<span class="token operator">=</span><span class="token function">min</span><span class="token punctuation">(</span>csv_acc_data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">%2.最小值</span>Peak<span class="token operator">=</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>csv_acc_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">%3.峰值</span>P2p<span class="token operator">=</span><span class="token function">max</span><span class="token punctuation">(</span>csv_acc_data<span class="token punctuation">)</span><span class="token operator">-</span><span class="token function">min</span><span class="token punctuation">(</span>csv_acc_data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">%4.峰峰值</span>Mean<span class="token operator">=</span><span class="token function">mean</span><span class="token punctuation">(</span>csv_acc_data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">%5.均值</span>AverageAmplitude<span class="token operator">=</span><span class="token function">mean</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>csv_acc_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">%6.绝对平均值（平均幅值）</span>RootAmplitude<span class="token operator">=</span><span class="token function">mean</span><span class="token punctuation">(</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>csv_acc_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">.^</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">%7.方根幅值</span>Var<span class="token operator">=</span><span class="token function">var</span><span class="token punctuation">(</span>csv_acc_data<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">%8.方差  有偏</span>Std<span class="token operator">=</span><span class="token function">std</span><span class="token punctuation">(</span>csv_acc_data<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">%9.标准差</span>Rms<span class="token operator">=</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>csv_acc_data<span class="token operator">.^</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">./</span><span class="token function">length</span><span class="token punctuation">(</span>csv_acc_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">%10.有效值（均方根）</span>Kurtosis<span class="token operator">=</span><span class="token function">kurtosis</span><span class="token punctuation">(</span>csv_acc_data<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">%11.峭度</span>Skewness<span class="token operator">=</span><span class="token function">skewness</span><span class="token punctuation">(</span>csv_acc_data<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">%12.偏度</span>ShapeFactor<span class="token operator">=</span>Rms<span class="token operator">./</span>AverageAmplitude<span class="token punctuation">;</span><span class="token comment">%13.波形因子</span>PeakingFactor<span class="token operator">=</span>Peak<span class="token operator">./</span>Rms<span class="token punctuation">;</span><span class="token comment">%14.峰值因子（波峰因子）</span>PulseFactor<span class="token operator">=</span>Peak<span class="token operator">./</span>AverageAmplitude<span class="token punctuation">;</span><span class="token comment">%15.脉冲因子</span>MarginFactor<span class="token operator">=</span>Peak<span class="token operator">./</span>RootAmplitude<span class="token punctuation">;</span><span class="token comment">%16.裕度因子</span>ClearanceFactor<span class="token operator">=</span>Peak<span class="token operator">./</span>Rms<span class="token operator">.^</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">%17.余隙因子</span>feature_RUL<span class="token operator">=</span><span class="token punctuation">[</span>Time<span class="token punctuation">;</span>Max<span class="token punctuation">;</span>Min<span class="token punctuation">;</span>Peak<span class="token punctuation">;</span>P2p<span class="token punctuation">;</span>Mean<span class="token punctuation">;</span>AverageAmplitude<span class="token punctuation">;</span>RootAmplitude<span class="token punctuation">;</span>Var<span class="token punctuation">;</span>Std<span class="token punctuation">;</span>Rms<span class="token punctuation">;</span>Kurtosis<span class="token punctuation">;</span>Skewness<span class="token punctuation">;</span>ShapeFactor<span class="token punctuation">;</span>PeakingFactor<span class="token punctuation">;</span>PulseFactor<span class="token punctuation">;</span>MarginFactor<span class="token punctuation">;</span>ClearanceFactor<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">%垂直拼接</span>feature_RUL<span class="token operator">=</span><span class="token function">permute</span><span class="token punctuation">(</span>feature_RUL<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">2</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">% 调整维度顺序</span><span class="token comment">%% 5、变点检测并建立剩余寿命标签</span>changePoints <span class="token operator">=</span> <span class="token function">findchangepts</span><span class="token punctuation">(</span>Rms<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">%寻找变点</span>labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token function">ones</span><span class="token punctuation">(</span>changePoints<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">linspace</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cols<span class="token operator">-</span>changePoints<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">% 生成标签</span><span class="token punctuation">[</span><span class="token operator">~</span><span class="token punctuation">,</span> cols1<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">size</span><span class="token punctuation">(</span>feature_RUL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">%获取数据形状</span><span class="token function">feature_RUL</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token operator">=</span>labels<span class="token punctuation">;</span> <span class="token comment">%增添标签</span><span class="token comment">%% 6、保存文件</span>savepath1<span class="token operator">=</span><span class="token punctuation">[</span>savepath<span class="token punctuation">,</span><span class="token string">'负载4000_5_5.mat'</span><span class="token punctuation">]</span><span class="token function">save</span><span class="token punctuation">(</span>savepath1<span class="token punctuation">,</span><span class="token string">'feature_RUL'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="17-4-3-构造节点级图数据"><a href="#17-4-3-构造节点级图数据" class="headerlink" title="17.4.3 构造节点级图数据"></a>17.4.3 构造节点级图数据</h3><p>处理后的<a href="https://pan.baidu.com/s/13V-hY1qQVtSlQz0_1Cgsgg">数据集链接</a>，提取码：phm2，分为带标签时域和带标签特征两个文件夹，每个文件又包括如下：</p><p><img src="D:\file_folder\图网络实战17\phm2012数据.png" alt="带标签特征"></p><p>本章使用带标签特征数据，妙地利用数据本身所蕴含的时序关系，将相邻时刻的信号进行有机连接，进而生成具有丰富信息的时序路径图。在这种图结构中，每个节点都代表着特定的时序信号，而节点的特征则是从原始的时序数据中精心筛选的时域统计指标，如图所示：</p><img src="D:\file_folder\图网络实战17\时域指标.png" style="zoom:100%;"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> torch_geometric<span class="token punctuation">.</span>data <span class="token keyword">import</span> Data  <span class="token comment"># 导入Data模块，用于构造图数据</span><span class="token keyword">from</span> scipy<span class="token punctuation">.</span>io <span class="token keyword">import</span> loadmat  <span class="token comment"># 导入loadmat函数，用于加载.mat文件</span><span class="token keyword">import</span> torch  <span class="token comment"># 导入torch模块，用于张量操作和构造数据集</span><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np  <span class="token comment"># 导入numpy模块，用于构造数据集</span><span class="token keyword">from</span> scipy<span class="token punctuation">.</span>spatial<span class="token punctuation">.</span>distance <span class="token keyword">import</span> pdist <span class="token comment"># 计算数据集各个点之间的欧几里得距离</span><span class="token keyword">def</span> <span class="token function">Path_attr</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''    定义函数 Path_attr，用于计算路径属性。    参数：data：输入数据    返回值：edge_index：边索引    w：权重    '''</span>    <span class="token comment"># 初始化边索引</span>    edge_index <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span>    <span class="token comment"># 构建边索引</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        edge_index<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>        edge_index<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token comment"># 计算相邻节点之间的欧氏距离</span>    distance <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        v_1 <span class="token operator">=</span> data<span class="token punctuation">[</span>j<span class="token punctuation">]</span>        v_2 <span class="token operator">=</span> data<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>        combine <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">[</span>v_1<span class="token punctuation">,</span> v_2<span class="token punctuation">]</span><span class="token punctuation">)</span>        likely <span class="token operator">=</span> pdist<span class="token punctuation">(</span>combine<span class="token punctuation">,</span> <span class="token string">'euclidean'</span><span class="token punctuation">)</span>        distance<span class="token punctuation">.</span>append<span class="token punctuation">(</span>likely<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment"># 计算高斯核权重</span>    beata <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>distance<span class="token punctuation">)</span>    w <span class="token operator">=</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>distance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>beata <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">#Gussion kernel高斯核</span>    <span class="token keyword">return</span> edge_index<span class="token punctuation">,</span> w<span class="token keyword">def</span> <span class="token function">data_graph</span><span class="token punctuation">(</span><span class="token builtin">dir</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    构造图数据    :param dir: 路径    :return: train1_dataset, train2_dataset, train3_dataset, train4_dataset, test_dataset    """</span>    <span class="token comment"># 加载训练数据1</span>    m1 <span class="token operator">=</span> loadmat<span class="token punctuation">(</span><span class="token builtin">dir</span> <span class="token operator">+</span> <span class="token string">"负载4000_1_5.mat"</span><span class="token punctuation">)</span>    train_s1 <span class="token operator">=</span> m1<span class="token punctuation">[</span><span class="token string">"feature_RUL_time"</span><span class="token punctuation">]</span>    train_x1 <span class="token operator">=</span> train_s1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">]</span>  <span class="token comment"># 左闭右开</span>    train_y1 <span class="token operator">=</span> train_s1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">]</span>    <span class="token comment"># 加载训练数据2</span>    m2 <span class="token operator">=</span> loadmat<span class="token punctuation">(</span><span class="token builtin">dir</span> <span class="token operator">+</span> <span class="token string">"负载4000_4_5.mat"</span><span class="token punctuation">)</span>    train_s2 <span class="token operator">=</span> m2<span class="token punctuation">[</span><span class="token string">"feature_RUL_time"</span><span class="token punctuation">]</span>    train_x2 <span class="token operator">=</span> train_s2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">]</span>  <span class="token comment"># 左闭右开</span>    train_y2 <span class="token operator">=</span> train_s2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">]</span>    <span class="token comment"># 加载训练数据3</span>    m3 <span class="token operator">=</span> loadmat<span class="token punctuation">(</span><span class="token builtin">dir</span> <span class="token operator">+</span> <span class="token string">"负载4000_5_5.mat"</span><span class="token punctuation">)</span>    train_s3 <span class="token operator">=</span> m3<span class="token punctuation">[</span><span class="token string">"feature_RUL_time"</span><span class="token punctuation">]</span>    train_x3 <span class="token operator">=</span> train_s3<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">]</span>  <span class="token comment"># 左闭右开</span>    train_y3 <span class="token operator">=</span> train_s3<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">]</span>    <span class="token comment"># 加载训练数据4</span>    m4 <span class="token operator">=</span> loadmat<span class="token punctuation">(</span><span class="token builtin">dir</span> <span class="token operator">+</span> <span class="token string">"负载4000_7_5.mat"</span><span class="token punctuation">)</span>    train_s4 <span class="token operator">=</span> m4<span class="token punctuation">[</span><span class="token string">"feature_RUL_time"</span><span class="token punctuation">]</span>    train_x4 <span class="token operator">=</span> train_s4<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">]</span>  <span class="token comment"># 左闭右开</span>    train_y4 <span class="token operator">=</span> train_s4<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">]</span>    <span class="token comment"># 加载测试数据</span>    m7 <span class="token operator">=</span> loadmat<span class="token punctuation">(</span><span class="token builtin">dir</span> <span class="token operator">+</span> <span class="token string">"负载4000_3_5.mat"</span><span class="token punctuation">)</span>    test_s1 <span class="token operator">=</span> m7<span class="token punctuation">[</span><span class="token string">"feature_RUL_time"</span><span class="token punctuation">]</span>    test_x1 <span class="token operator">=</span> test_s1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">]</span>  <span class="token comment"># 左闭右开</span>    test_y1 <span class="token operator">=</span> test_s1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">]</span>        <span class="token comment"># 生成边的索引和特征</span>    edge_index1<span class="token punctuation">,</span> edge_fea1 <span class="token operator">=</span> Path_attr<span class="token punctuation">(</span>train_x1<span class="token punctuation">)</span>    edge_index2<span class="token punctuation">,</span> edge_fea2 <span class="token operator">=</span> Path_attr<span class="token punctuation">(</span>train_x2<span class="token punctuation">)</span>    edge_index3<span class="token punctuation">,</span> edge_fea3 <span class="token operator">=</span> Path_attr<span class="token punctuation">(</span>train_x3<span class="token punctuation">)</span>    edge_index4<span class="token punctuation">,</span> edge_fea4 <span class="token operator">=</span> Path_attr<span class="token punctuation">(</span>train_x4<span class="token punctuation">)</span>    edge_index7<span class="token punctuation">,</span> edge_fea7 <span class="token operator">=</span> Path_attr<span class="token punctuation">(</span>test_x1<span class="token punctuation">)</span>        <span class="token comment"># 将ndarray数据转换为张量，因为pytorch用的数据类型是张量</span>    train_x1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>train_x1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">)</span>    train_y1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>train_y1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">)</span>    train_x2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>train_x2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">)</span>    train_y2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>train_y2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">)</span>    train_x3 <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>train_x3<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">)</span>    train_y3 <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>train_y3<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">)</span>    train_x4 <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>train_x4<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">)</span>    train_y4 <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>train_y4<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">)</span>    test_x1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>test_x1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">)</span>    test_y1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>test_y1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">)</span>    <span class="token comment"># 生成图数据</span>    train1_dataset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    edge_index <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>edge_index1<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span>    train_data <span class="token operator">=</span> Data<span class="token punctuation">(</span>x<span class="token operator">=</span>train_x1<span class="token punctuation">,</span> y<span class="token operator">=</span>train_y1<span class="token punctuation">,</span> edge_index<span class="token operator">=</span>edge_index<span class="token punctuation">)</span>    train1_dataset<span class="token punctuation">.</span>append<span class="token punctuation">(</span>train_data<span class="token punctuation">)</span>    train2_dataset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    edge_index <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>edge_index2<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span>    train_data <span class="token operator">=</span> Data<span class="token punctuation">(</span>x<span class="token operator">=</span>train_x2<span class="token punctuation">,</span> y<span class="token operator">=</span>train_y2<span class="token punctuation">,</span> edge_index<span class="token operator">=</span>edge_index<span class="token punctuation">)</span>    train2_dataset<span class="token punctuation">.</span>append<span class="token punctuation">(</span>train_data<span class="token punctuation">)</span>    train3_dataset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    edge_index <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>edge_index3<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span>    train_data <span class="token operator">=</span> Data<span class="token punctuation">(</span>x<span class="token operator">=</span>train_x3<span class="token punctuation">,</span> y<span class="token operator">=</span>train_y3<span class="token punctuation">,</span> edge_index<span class="token operator">=</span>edge_index<span class="token punctuation">)</span>    train3_dataset<span class="token punctuation">.</span>append<span class="token punctuation">(</span>train_data<span class="token punctuation">)</span>    train4_dataset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    edge_index <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>edge_index4<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span>    train_data <span class="token operator">=</span> Data<span class="token punctuation">(</span>x<span class="token operator">=</span>train_x4<span class="token punctuation">,</span> y<span class="token operator">=</span>train_y4<span class="token punctuation">,</span> edge_index<span class="token operator">=</span>edge_index<span class="token punctuation">)</span>    train4_dataset<span class="token punctuation">.</span>append<span class="token punctuation">(</span>train_data<span class="token punctuation">)</span>    test_dataset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    edge_index <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>edge_index7<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span>    test_data <span class="token operator">=</span> Data<span class="token punctuation">(</span>x<span class="token operator">=</span>test_x1<span class="token punctuation">,</span> y<span class="token operator">=</span>test_y1<span class="token punctuation">,</span> edge_index<span class="token operator">=</span>edge_index<span class="token punctuation">)</span>    test_dataset<span class="token punctuation">.</span>append<span class="token punctuation">(</span>test_data<span class="token punctuation">)</span>    <span class="token keyword">return</span> train1_dataset<span class="token punctuation">,</span> train2_dataset<span class="token punctuation">,</span> train3_dataset<span class="token punctuation">,</span> train4_dataset<span class="token punctuation">,</span> test_dataset  <span class="token comment"># 返回训练集和测试集</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="17-4-4-图数据可视化"><a href="#17-4-4-图数据可视化" class="headerlink" title="17.4.4 图数据可视化"></a>17.4.4 图数据可视化</h3><p>为了更进一步看到生成的图数据，本章将进行可视化操作，清晰看到生成的图数据</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> networkx <span class="token keyword">as</span> nx<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt<span class="token keyword">from</span> torch_geometric<span class="token punctuation">.</span>utils <span class="token keyword">import</span> to_networkx<span class="token comment"># 画图函数</span><span class="token keyword">def</span> <span class="token function">visualize_graph</span><span class="token punctuation">(</span>G<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">:</span>    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span><span class="token punctuation">)</span>    plt<span class="token punctuation">.</span>xticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    plt<span class="token punctuation">.</span>yticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    nx<span class="token punctuation">.</span>draw_networkx<span class="token punctuation">(</span>G<span class="token punctuation">,</span> pos<span class="token operator">=</span>nx<span class="token punctuation">.</span>spring_layout<span class="token punctuation">(</span>G<span class="token punctuation">,</span> seed<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">,</span> with_labels<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>                     node_color<span class="token operator">=</span>color<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">"Set2"</span><span class="token punctuation">)</span>    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 使用networkx进行可视化展示</span>G <span class="token operator">=</span> to_networkx<span class="token punctuation">(</span>train_dataset3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> to_undirected<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>visualize_graph<span class="token punctuation">(</span>G<span class="token punctuation">,</span> color<span class="token operator">=</span>train_dataset3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="D:\file_folder\图网络实战17\图数据可视化.png" alt="图数据可视化"></p><h3 id="17-4-5-构造图网络"><a href="#17-4-5-构造图网络" class="headerlink" title="17.4.5 构造图网络"></a>17.4.5 构造图网络</h3><p>图数据构造结束之后，接下来，我们构造图网络，采用PyTorch Geometric的GCNConv层以及PyTorch的LSTM层去构建</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn<span class="token keyword">from</span> torch_geometric<span class="token punctuation">.</span>nn <span class="token keyword">import</span> GCNConv<span class="token keyword">import</span> torch  <span class="token comment"># 导入torch模块，用于张量操作和构造数据集</span><span class="token keyword">class</span> <span class="token class-name">GCN</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>GCN<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">520</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>lstm1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>LSTM<span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># LSTM层1，输入维度为18，隐藏状态维度为100，LSTM层数为2</span>        self<span class="token punctuation">.</span>norm1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm1d<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token comment"># 批标准化层1</span>        self<span class="token punctuation">.</span>gcnconv <span class="token operator">=</span> GCNConv<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>  <span class="token comment"># GCNConv层，输入特征维度为100，输出特征维度为50</span>        self<span class="token punctuation">.</span>norm2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm1d<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>  <span class="token comment"># 批标准化层2</span>        self<span class="token punctuation">.</span>lstm2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>LSTM<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># LSTM层2，输入维度为50，隐藏状态维度为25，LSTM层数为2</span>        self<span class="token punctuation">.</span>norm3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm1d<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span>  <span class="token comment"># 批标准化层3</span>        self<span class="token punctuation">.</span>layer3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>   <span class="token comment"># 线性层，输入维度为25，输出维度为1</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> edge_index<span class="token punctuation">)</span><span class="token punctuation">:</span>        a<span class="token punctuation">,</span>c <span class="token operator">=</span> x<span class="token punctuation">.</span>shape              <span class="token comment"># 获取输入数据x的形状信息</span>        x<span class="token punctuation">,</span> _ <span class="token operator">=</span> self<span class="token punctuation">.</span>lstm1<span class="token punctuation">(</span>x<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 应用批标准化层和ReLU激活函数</span>        x <span class="token operator">=</span> self<span class="token punctuation">.</span>norm1<span class="token punctuation">(</span>x<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        h <span class="token operator">=</span> self<span class="token punctuation">.</span>gcnconv<span class="token punctuation">(</span>x<span class="token punctuation">,</span> edge_index<span class="token punctuation">)</span> <span class="token comment"># 将特征向量x输入到GCNConv层中</span>        h <span class="token operator">=</span> self<span class="token punctuation">.</span>norm2<span class="token punctuation">(</span>h<span class="token punctuation">)</span>  <span class="token comment"># 应用批标准化层和ReLU激活函数</span>        h <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>h<span class="token punctuation">)</span>        x<span class="token punctuation">,</span> _ <span class="token operator">=</span> self<span class="token punctuation">.</span>lstm2<span class="token punctuation">(</span>h<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> h<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 经过LSTM层2处理</span>        x <span class="token operator">=</span> self<span class="token punctuation">.</span>norm3<span class="token punctuation">(</span>x<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 应用批标准化层和ReLU激活函数</span>        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        out <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>self<span class="token punctuation">.</span>layer3<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 将特征向量x输入到线性层中，并应用Sigmoid激活函数得到输出结果</span>        <span class="token keyword">return</span> out<span class="token punctuation">,</span> h<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="17-4-6-模型训练与预测"><a href="#17-4-6-模型训练与预测" class="headerlink" title="17.4.6 模型训练与预测"></a>17.4.6 模型训练与预测</h3><p>图数据构造结束之后，接下来，我们将利用图网络进行数据分析和预测。通过对图网络的深入挖掘，我们可以发现数据中的异常模式和趋势，进而利用图网络进行寿命预测，代码如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> torch_geometric<span class="token punctuation">.</span>data <span class="token keyword">import</span> Data  <span class="token comment"># 导入Data模块，用于构造图数据</span><span class="token keyword">from</span> scipy<span class="token punctuation">.</span>io <span class="token keyword">import</span> loadmat  <span class="token comment"># 导入loadmat函数，用于加载.mat文件</span><span class="token keyword">import</span> torch  <span class="token comment"># 导入torch模块，用于张量操作和构造数据集</span><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np  <span class="token comment"># 导入numpy模块，用于构造数据集</span><span class="token keyword">from</span> scipy<span class="token punctuation">.</span>spatial<span class="token punctuation">.</span>distance <span class="token keyword">import</span> pdist <span class="token comment"># 计算数据集各个点之间的欧几里得距离</span><span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn<span class="token keyword">from</span> torch_geometric<span class="token punctuation">.</span>nn <span class="token keyword">import</span> GCNConv<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F<span class="token keyword">def</span> <span class="token function">Path_attr</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''    定义函数 Path_attr，用于计算路径属性。    参数：data：输入数据    返回值：edge_index：边索引    w：权重    '''</span>    <span class="token comment"># 初始化边索引</span>    edge_index <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span>    <span class="token comment"># 构建边索引</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        edge_index<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>        edge_index<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token comment"># 计算相邻节点之间的欧氏距离</span>    distance <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        v_1 <span class="token operator">=</span> data<span class="token punctuation">[</span>j<span class="token punctuation">]</span>        v_2 <span class="token operator">=</span> data<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>        combine <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">[</span>v_1<span class="token punctuation">,</span> v_2<span class="token punctuation">]</span><span class="token punctuation">)</span>        likely <span class="token operator">=</span> pdist<span class="token punctuation">(</span>combine<span class="token punctuation">,</span> <span class="token string">'euclidean'</span><span class="token punctuation">)</span>        distance<span class="token punctuation">.</span>append<span class="token punctuation">(</span>likely<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment"># 计算高斯核权重</span>    beata <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>distance<span class="token punctuation">)</span>    w <span class="token operator">=</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>distance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>beata <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">#Gussion kernel高斯核</span>    <span class="token keyword">return</span> edge_index<span class="token punctuation">,</span> w<span class="token keyword">def</span> <span class="token function">data_graph</span><span class="token punctuation">(</span><span class="token builtin">dir</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    构造图数据    :param dir: 路径    :return: train1_dataset, train2_dataset, train3_dataset, train4_dataset, test_dataset    """</span>    <span class="token comment"># 加载训练数据1</span>    m1 <span class="token operator">=</span> loadmat<span class="token punctuation">(</span><span class="token builtin">dir</span> <span class="token operator">+</span> <span class="token string">"负载4000_1_5.mat"</span><span class="token punctuation">)</span>    train_s1 <span class="token operator">=</span> m1<span class="token punctuation">[</span><span class="token string">"feature_RUL_time"</span><span class="token punctuation">]</span>    train_x1 <span class="token operator">=</span> train_s1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">]</span>  <span class="token comment"># 左闭右开</span>    train_y1 <span class="token operator">=</span> train_s1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">]</span>    <span class="token comment"># 加载训练数据2</span>    m2 <span class="token operator">=</span> loadmat<span class="token punctuation">(</span><span class="token builtin">dir</span> <span class="token operator">+</span> <span class="token string">"负载4000_4_5.mat"</span><span class="token punctuation">)</span>    train_s2 <span class="token operator">=</span> m2<span class="token punctuation">[</span><span class="token string">"feature_RUL_time"</span><span class="token punctuation">]</span>    train_x2 <span class="token operator">=</span> train_s2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">]</span>  <span class="token comment"># 左闭右开</span>    train_y2 <span class="token operator">=</span> train_s2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">]</span>    <span class="token comment"># 加载训练数据3</span>    m3 <span class="token operator">=</span> loadmat<span class="token punctuation">(</span><span class="token builtin">dir</span> <span class="token operator">+</span> <span class="token string">"负载4000_5_5.mat"</span><span class="token punctuation">)</span>    train_s3 <span class="token operator">=</span> m3<span class="token punctuation">[</span><span class="token string">"feature_RUL_time"</span><span class="token punctuation">]</span>    train_x3 <span class="token operator">=</span> train_s3<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">]</span>  <span class="token comment"># 左闭右开</span>    train_y3 <span class="token operator">=</span> train_s3<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">]</span>    <span class="token comment"># 加载训练数据4</span>    m4 <span class="token operator">=</span> loadmat<span class="token punctuation">(</span><span class="token builtin">dir</span> <span class="token operator">+</span> <span class="token string">"负载4000_7_5.mat"</span><span class="token punctuation">)</span>    train_s4 <span class="token operator">=</span> m4<span class="token punctuation">[</span><span class="token string">"feature_RUL_time"</span><span class="token punctuation">]</span>    train_x4 <span class="token operator">=</span> train_s4<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">]</span>  <span class="token comment"># 左闭右开</span>    train_y4 <span class="token operator">=</span> train_s4<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">]</span>    <span class="token comment"># 加载测试数据</span>    m7 <span class="token operator">=</span> loadmat<span class="token punctuation">(</span><span class="token builtin">dir</span> <span class="token operator">+</span> <span class="token string">"负载4000_3_5.mat"</span><span class="token punctuation">)</span>    test_s1 <span class="token operator">=</span> m7<span class="token punctuation">[</span><span class="token string">"feature_RUL_time"</span><span class="token punctuation">]</span>    test_x1 <span class="token operator">=</span> test_s1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">]</span>  <span class="token comment"># 左闭右开</span>    test_y1 <span class="token operator">=</span> test_s1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">]</span>    edge_index1<span class="token punctuation">,</span> edge_fea1 <span class="token operator">=</span> Path_attr<span class="token punctuation">(</span>train_x1<span class="token punctuation">)</span>    edge_index2<span class="token punctuation">,</span> edge_fea2 <span class="token operator">=</span> Path_attr<span class="token punctuation">(</span>train_x2<span class="token punctuation">)</span>    edge_index3<span class="token punctuation">,</span> edge_fea3 <span class="token operator">=</span> Path_attr<span class="token punctuation">(</span>train_x3<span class="token punctuation">)</span>    edge_index4<span class="token punctuation">,</span> edge_fea4 <span class="token operator">=</span> Path_attr<span class="token punctuation">(</span>train_x4<span class="token punctuation">)</span>    edge_index7<span class="token punctuation">,</span> edge_fea7 <span class="token operator">=</span> Path_attr<span class="token punctuation">(</span>test_x1<span class="token punctuation">)</span>    <span class="token comment"># 将ndarray数据转换为张量，因为pytorch用的数据类型是张量</span>    train_x1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>train_x1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">)</span>    train_y1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>train_y1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>LongTensor<span class="token punctuation">)</span>    train_x2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>train_x2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">)</span>    train_y2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>train_y2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>LongTensor<span class="token punctuation">)</span>    train_x3 <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>train_x3<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">)</span>    train_y3 <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>train_y3<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>LongTensor<span class="token punctuation">)</span>    train_x4 <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>train_x4<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">)</span>    train_y4 <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>train_y4<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>LongTensor<span class="token punctuation">)</span>    test_x1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>test_x1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">)</span>    test_y1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>test_y1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>LongTensor<span class="token punctuation">)</span>    train1_dataset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    edge_index <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>edge_index1<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span>    train_data <span class="token operator">=</span> Data<span class="token punctuation">(</span>x<span class="token operator">=</span>train_x1<span class="token punctuation">,</span> y<span class="token operator">=</span>train_y1<span class="token punctuation">,</span> edge_index<span class="token operator">=</span>edge_index<span class="token punctuation">)</span>    train1_dataset<span class="token punctuation">.</span>append<span class="token punctuation">(</span>train_data<span class="token punctuation">)</span>    train2_dataset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    edge_index <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>edge_index2<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span>    train_data <span class="token operator">=</span> Data<span class="token punctuation">(</span>x<span class="token operator">=</span>train_x2<span class="token punctuation">,</span> y<span class="token operator">=</span>train_y2<span class="token punctuation">,</span> edge_index<span class="token operator">=</span>edge_index<span class="token punctuation">)</span>    train2_dataset<span class="token punctuation">.</span>append<span class="token punctuation">(</span>train_data<span class="token punctuation">)</span>    train3_dataset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    edge_index <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>edge_index3<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span>    train_data <span class="token operator">=</span> Data<span class="token punctuation">(</span>x<span class="token operator">=</span>train_x3<span class="token punctuation">,</span> y<span class="token operator">=</span>train_y3<span class="token punctuation">,</span> edge_index<span class="token operator">=</span>edge_index<span class="token punctuation">)</span>    train3_dataset<span class="token punctuation">.</span>append<span class="token punctuation">(</span>train_data<span class="token punctuation">)</span>    train4_dataset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    edge_index <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>edge_index4<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span>    train_data <span class="token operator">=</span> Data<span class="token punctuation">(</span>x<span class="token operator">=</span>train_x4<span class="token punctuation">,</span> y<span class="token operator">=</span>train_y4<span class="token punctuation">,</span> edge_index<span class="token operator">=</span>edge_index<span class="token punctuation">)</span>    train4_dataset<span class="token punctuation">.</span>append<span class="token punctuation">(</span>train_data<span class="token punctuation">)</span>    test_dataset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    edge_index <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>edge_index7<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span>    test_data <span class="token operator">=</span> Data<span class="token punctuation">(</span>x<span class="token operator">=</span>test_x1<span class="token punctuation">,</span> y<span class="token operator">=</span>test_y1<span class="token punctuation">,</span> edge_index<span class="token operator">=</span>edge_index<span class="token punctuation">)</span>    test_dataset<span class="token punctuation">.</span>append<span class="token punctuation">(</span>test_data<span class="token punctuation">)</span>    <span class="token keyword">return</span> train1_dataset<span class="token punctuation">,</span> train2_dataset<span class="token punctuation">,</span> train3_dataset<span class="token punctuation">,</span> train4_dataset<span class="token punctuation">,</span> test_dataset  <span class="token comment"># 返回训练集和测试集</span><span class="token keyword">class</span> <span class="token class-name">GCN</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>GCN<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">520</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>lstm1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>LSTM<span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># LSTM层1，输入维度为18，隐藏状态维度为100，LSTM层数为2</span>        self<span class="token punctuation">.</span>norm1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm1d<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token comment"># 批标准化层1</span>        self<span class="token punctuation">.</span>gcnconv <span class="token operator">=</span> GCNConv<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>  <span class="token comment"># GCNConv层，输入特征维度为100，输出特征维度为50</span>        self<span class="token punctuation">.</span>norm2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm1d<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>  <span class="token comment"># 批标准化层2</span>        self<span class="token punctuation">.</span>lstm2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>LSTM<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># LSTM层2，输入维度为50，隐藏状态维度为25，LSTM层数为2</span>        self<span class="token punctuation">.</span>norm3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm1d<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span>  <span class="token comment"># 批标准化层3</span>        self<span class="token punctuation">.</span>layer3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>   <span class="token comment"># 线性层，输入维度为25，输出维度为1</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> edge_index<span class="token punctuation">)</span><span class="token punctuation">:</span>        a<span class="token punctuation">,</span>c <span class="token operator">=</span> x<span class="token punctuation">.</span>shape              <span class="token comment"># 获取输入数据x的形状信息</span>        x<span class="token punctuation">,</span> _ <span class="token operator">=</span> self<span class="token punctuation">.</span>lstm1<span class="token punctuation">(</span>x<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 应用批标准化层和ReLU激活函数</span>        x <span class="token operator">=</span> self<span class="token punctuation">.</span>norm1<span class="token punctuation">(</span>x<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        h <span class="token operator">=</span> self<span class="token punctuation">.</span>gcnconv<span class="token punctuation">(</span>x<span class="token punctuation">,</span> edge_index<span class="token punctuation">)</span> <span class="token comment"># 将特征向量x输入到GCNConv层中</span>        h <span class="token operator">=</span> self<span class="token punctuation">.</span>norm2<span class="token punctuation">(</span>h<span class="token punctuation">)</span>  <span class="token comment"># 应用批标准化层和ReLU激活函数</span>        h <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>h<span class="token punctuation">)</span>        x<span class="token punctuation">,</span> _ <span class="token operator">=</span> self<span class="token punctuation">.</span>lstm2<span class="token punctuation">(</span>h<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> h<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 经过LSTM层2处理</span>        x <span class="token operator">=</span> self<span class="token punctuation">.</span>norm3<span class="token punctuation">(</span>x<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 应用批标准化层和ReLU激活函数</span>        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        out <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>self<span class="token punctuation">.</span>layer3<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 将特征向量x输入到线性层中，并应用Sigmoid激活函数得到输出结果</span>        <span class="token keyword">return</span> out<span class="token punctuation">,</span> h<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>train_dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    训练模型    :param train_dataset: 训练数据集    :return: loss    """</span>    model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 设置模型为训练模式</span>    <span class="token keyword">for</span> data <span class="token keyword">in</span> train_dataset<span class="token punctuation">:</span>        data <span class="token operator">=</span> data<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># 将数据移动到指定设备（如GPU）</span>        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 清零优化器的梯度</span>        out<span class="token punctuation">,</span> h <span class="token operator">=</span>model<span class="token punctuation">(</span>data<span class="token punctuation">.</span>x<span class="token punctuation">,</span> data<span class="token punctuation">.</span>edge_index<span class="token punctuation">)</span> <span class="token comment"># 运行模型获取输出</span>        loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>out<span class="token punctuation">,</span> data<span class="token punctuation">.</span>y<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 计算损失</span>        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 反向传播计算梯度</span>        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 根据梯度更新模型参数</span>    <span class="token keyword">return</span> loss<span class="token comment"># 两个评价指标</span><span class="token keyword">def</span> <span class="token function">rmse</span><span class="token punctuation">(</span>predictions<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    计算均方根误差(Root Mean Squared Error, RMSE)    :param predictions: 预测值    :param targets: 实际值    :return: 返回RMSE值    """</span>    <span class="token keyword">return</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>predictions <span class="token operator">-</span> targets<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">mae</span><span class="token punctuation">(</span>predictions<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    计算平均绝对误差(Mean Absolute Error, MAE)    :param predictions: 预测值    :param targets: 实际值    :return: 返回MAE值    """</span>    <span class="token keyword">return</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>absolute<span class="token punctuation">(</span>predictions <span class="token operator">-</span> targets<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>predictions<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">evaluate</span><span class="token punctuation">(</span>test_dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    评估模型    :param test_dataset: 测试数据集    :return: pred_rmse,pred_mae    """</span>    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 设置模型为评估模式</span>    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 禁用梯度计算</span>        <span class="token keyword">for</span> test_data <span class="token keyword">in</span> test_dataset<span class="token punctuation">:</span>            test_data <span class="token operator">=</span> test_data<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># 将数据移动到指定设备（如GPU）</span>            pred<span class="token punctuation">,</span> h <span class="token operator">=</span> model<span class="token punctuation">(</span>test_data<span class="token punctuation">.</span>x<span class="token punctuation">,</span> test_data<span class="token punctuation">.</span>edge_index<span class="token punctuation">)</span> <span class="token comment"># 获取模型输出</span>            pred_test <span class="token operator">=</span> pred<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 获取预测值</span>            pred_rmse <span class="token operator">=</span> rmse<span class="token punctuation">(</span>pred_test<span class="token punctuation">,</span> test_data<span class="token punctuation">.</span>y<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 计算rmse</span>            pred_mae <span class="token operator">=</span> mae<span class="token punctuation">(</span>pred_test<span class="token punctuation">,</span> test_data<span class="token punctuation">.</span>y<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 计算mae</span>    <span class="token keyword">return</span> pred_rmse<span class="token punctuation">,</span>pred_mae<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    <span class="token comment"># 获取数据集</span>    <span class="token builtin">dir</span> <span class="token operator">=</span> <span class="token string">r"G:\联邦图网络\code\data\phm2012\带标签特征\\"</span>    train_dataset1<span class="token punctuation">,</span>train_dataset2<span class="token punctuation">,</span>train_dataset3<span class="token punctuation">,</span>train_dataset4<span class="token punctuation">,</span>test_dataset <span class="token operator">=</span> data_graph<span class="token punctuation">(</span><span class="token builtin">dir</span><span class="token punctuation">)</span>    device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cuda'</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">'cpu'</span><span class="token punctuation">)</span>  <span class="token comment"># 设置设备（GPU或CPU）</span>    model <span class="token operator">=</span> GCN<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>    <span class="token comment"># 损失函数</span>    criterion <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>SmoothL1Loss<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 定义优化器和初始学习率</span>    optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.0008</span><span class="token punctuation">)</span>    <span class="token comment"># 3.迭代训练</span>    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 迭代训练</span>        loss <span class="token operator">=</span> train<span class="token punctuation">(</span>train_dataset1<span class="token punctuation">)</span>  <span class="token comment"># 训练模型并获取xunlian损失值</span>        <span class="token keyword">if</span> epoch <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># 每10个epoch输出一次训练信息</span>            pred_rmse<span class="token punctuation">,</span> pred_mae <span class="token operator">=</span> evaluate<span class="token punctuation">(</span>test_dataset<span class="token punctuation">)</span>  <span class="token comment"># 测试模型并获取rmse,mae</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Epoch:%d|train loss:%.4f|test_rmse:%.4f|test_mae:%.4f"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pred_rmse<span class="token punctuation">,</span> pred_mae<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 输出结果信息</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://pytorch-geometric.readthedocs.io/en/latest/" title="最好的PYG教程网站">PYG官方文档</a><br><a href="https://zhuanlan.zhihu.com/p/448210993">凯斯西储轴承数据集解读与整理</a><br>Li T, Zhou Z, Li S, et al. The emerging graph neural networks for intelligent fault diagnostics and prognostics: A guideline and a benchmark study[J]. Mechanical Systems and Signal Processing, 2022, 168: 108653.</p>]]></content>
      
      
      <categories>
          
          <category> 图神经网络 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据挖掘 </tag>
            
            <tag> 深度学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cnn-分类代码保存</title>
      <link href="/2023/03/28/cnn-fen-lei-dai-ma-bao-cun/"/>
      <url>/2023/03/28/cnn-fen-lei-dai-ma-bao-cun/</url>
      
        <content type="html"><![CDATA[<p><img src="https://img-blog.csdnimg.cn/48083de194394694aaa4fed0c15a8ddd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP55m95a2m5Lmg6K6w5b2V,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><h2 id="卷积层尺寸的计算原理"><a href="#卷积层尺寸的计算原理" class="headerlink" title="卷积层尺寸的计算原理"></a>卷积层尺寸的计算原理</h2><p>输入矩阵格式：四个维度，依次为：样本数、图像高度、图像宽度、图像通道数</p><p>输出矩阵格式：与输出矩阵的维度顺序和含义相同，但是后三个维度（图像高度、图像宽度、图像通道数）的尺寸发生变化。</p><p>权重矩阵（卷积核）格式：同样是四个维度，但维度的含义与上面两者都不同，为：卷积核高度、卷积核宽度、输入通道数、输出通道数（卷积核个数）</p><h2 id="输入矩阵、权重矩阵、输出矩阵这三者之间的相互决定关系"><a href="#输入矩阵、权重矩阵、输出矩阵这三者之间的相互决定关系" class="headerlink" title="输入矩阵、权重矩阵、输出矩阵这三者之间的相互决定关系"></a>输入矩阵、权重矩阵、输出矩阵这三者之间的相互决定关系</h2><p>卷积核的输入通道数（in depth）由输入矩阵的通道数所决定。（红色标注）</p><p>输出矩阵的通道数（out depth）由卷积核的输出通道数所决定。（绿色标注）</p><p>输出矩阵的高度和宽度（height, width）这两个维度的尺寸由输入矩阵、卷积核、扫描方式所共同决定。计算公式如下。（蓝色标注）<br><img src="https://img-blog.csdnimg.cn/9241296193734fa093991524c19947a6.png#pic_center" alt="在这里插入图片描述"><br>卷积后输出图片大小：N = （W-F+2P）/ S +1<br>W:输入图片，F:卷积核尺寸，S：步长, P: 填充</p><h2 id="标准卷积计算举例"><a href="#标准卷积计算举例" class="headerlink" title="标准卷积计算举例"></a>标准卷积计算举例</h2><p>以 AlexNet 模型的第一个卷积层为例，</p><p>输入图片的尺寸统一为 227 x 227 x 3 （高度 x 宽度 x 颜色通道数），<br>本层一共具有96个卷积核，<br>每个卷积核的尺寸都是 11 x 11 x 3。<br>已知 stride = 4， padding = 0，<br>假设 batch_size = 256，<br>则输出矩阵的高度/宽度为 (227 - 11) / 4 + 1 = 55<br><img src="https://img-blog.csdnimg.cn/4e4cab6059ce4a2293d0f9d8445d6904.png#pic_center" alt="在这里插入图片描述"></p><h2 id="1-x-1-卷积计算举例"><a href="#1-x-1-卷积计算举例" class="headerlink" title="1 x 1 卷积计算举例"></a>1 x 1 卷积计算举例</h2><p>后期 GoogLeNet、ResNet 等经典模型中普遍使用一个像素大小的卷积核作为降低参数复杂度的手段。<br>从下面的运算可以看到，其实 1 x 1 卷积没有什么神秘的，其作用就是将输入矩阵的通道数量缩减后输出（512 降为 32），并保持它在宽度和高度维度上的尺寸（227 x 227）。</p><ul><li><strong>原理</strong>是什么？卷积核的个数决定了输出的特征图的个数，也就是特征图的通道数，或者说是卷积后的输出的通道数，因此可以使用远小于原来的输入特征图通道数个1×1卷积核来压缩通道数。<br><img src="https://img-blog.csdnimg.cn/dd6e216d091a4a178553abaff709ee65.png#pic_center" alt="在这里插入图片描述"></li></ul><h2 id="全连接层计算举例"><a href="#全连接层计算举例" class="headerlink" title="全连接层计算举例"></a>全连接层计算举例</h2><p>实际上，全连接层也可以被视为是一种极端情况的卷积层，其卷积核尺寸就是输入矩阵尺寸，因此输出矩阵的高度和宽度尺寸都是1。<br><img src="https://img-blog.csdnimg.cn/4609be833d9744ac9736227c89a46a0a.png#pic_center" alt="在这里插入图片描述"></p><h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><p>其实只需要认识到，虽然输入的每一张图像本身具有三个维度，但是对于卷积核来讲依然只是一个一维向量。</p><ul><li>卷积核做的，其实就是与感受野范围内的像素点进行点积（而不是矩阵乘法）。</li><li>输入 x：[batch, height, width, in_channel]</li><li>权重 w：[height, width, in_channel, out_channel]</li><li>输出 y：[batch, height, width, out_channel]</li></ul><h2 id="相关代码使用"><a href="#相关代码使用" class="headerlink" title="相关代码使用"></a>相关代码使用</h2><p>**1 torch.nn.LSTM() **</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>LSTM<span class="token punctuation">(</span>input_size，hidden_size，num_layers，bias<span class="token operator">=</span><span class="token boolean">True</span>，batch_first<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>input_size</strong>： 输入数据的特征维数，通常就是embedding_dim(词向量的维度)<br><strong>hidden_size</strong>　：LSTM中隐层的维度<br><strong>num_layers</strong>　：循环神经网络的层数<br><strong>bias</strong>　：用不用偏置，default=True<br><strong>batch_first</strong> ：如果是True，则input为(batch, seq, input_size)【batch大小，序列长度，特征数目】。默认值为：False（seq_len, batch, input_size）<br><strong>dropout</strong>：　默认是0，代表不用dropout<br><strong>bidirectional</strong>：默认是false，代表不用双向LSTM<br> <strong>2 torch.nn.Conv2d()</strong><br> <strong>参数dilation——扩张卷积（也叫空洞卷积）</strong><br> 扩张操作(dilation)：控制kernel点（卷积核点）的间距，默认值:1。<br>dilation操作动图演示如下：<br>Dilated Convolution with a 3 x 3 kernel and dilation rate 2<br>扩张卷积核为3×3，扩张率为2<br><img src="https://img-blog.csdnimg.cn/7fc0a6d913bd4fa5a0b356447f977960.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP55m95a2m5Lmg6K6w5b2V,size_10,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p><pre class="line-numbers language-python" data-language="python"><code class="language-python">torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> groups<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p> <strong>3 torch.nn.MaxPool2d()</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python">torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token punctuation">,</span>stride<span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">0</span>，ceil_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>kernel_size ：表示做最大池化的窗口大小，可以是单个值，也可以是tuple元组（例如3-&gt;(3,3)，或者（2，3））<br>stride ：步长，可以是单个值，也可以是tuple元组<br><strong>默认步长跟最大池化窗口大小一致</strong>。<br>padding ：填充，可以是单个值，也可以是tuple元组<br>dilation ：控制窗口中元素步幅<br>return_indices ：布尔类型，返回最大值位置索引<br>ceil_mode ：布尔类型，为True，用向上取整的方法，计算输出形状；默认是向下取整。<br><strong>4 torch.nn.Linear()</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python">torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token punctuation">,</span>out_features<span class="token punctuation">,</span>bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>in_features: 上层神经元个数【每个输入样本的大小】</p><p>2）out_features： 本层神经元个数【每个输出样本的大小】<br>3）bias: 偏置，形状[out_features]。网络层是否有偏置，默认存在，且维度为[out_features ]；若bias=False,则该网络层无偏置，图层不会学习附加偏差<br><strong>5 torch.nn.Dropout(0.1)</strong><br>设置 Dropout 时，torch.nn.Dropout(0.9), 参数表示要丢弃的比例，这里的 0.1 是指该层（layer）的神经元在每次迭代训练时会随机有 10% 的可能性被丢弃<br><strong>6 batch_normalization 1D</strong></p><p>可以使用batch_normalization对隐藏层的数据进行正态分布标准化，由于标准化后可能影响神经网络的表达能力。 normalize 后的数据再使用缩放系数γ和平移系数β进行缩放和平移。其中γ和 β参数需要进行进行反向传播学习，使得处理后的数据达到最佳的使用效果。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>BatchNorm1d<span class="token punctuation">(</span>num_features<span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">1e-05</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> affine<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> track_running_stats<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>BatchNorm1d接收一个二维的输入with维度(batch_size,num_features)。<br>num_features：通道数<br>momentum： 计算running_mean和running_var的滑动平均系数。采用下列的公式<br>affine：bool值，True表示使用γ和 β参数<br>track_running_stats：bool值，如果为True，训练阶段采用实时的batch均值和方差， 同时采用滑动平均来计算全局的running_mean和running_var，测试阶段采用当前的running_mean和running_var；如果是False，则训练阶段和测试阶段都采用实时的batch均值和方差。</p><p><strong>好处：</strong><br>（1）BN使得网络中每层输入数据的分布相对稳定，加速模型学习速度<br>BN通过规范化与线性变换使得每一层网络的输入数据的均值与方差都在一定范围内，使得后一层网络不必不断去适应底层网络中输入的变化，从而实现了网络中层与层之间的解耦，更加有利于优化的过程,提高整个神经网络的学习速度。<br>（2）BN使得模型对初始化方法和网络中的参数不那么敏感，简化调参过程，使得网络学习更加稳定</p><p>（3）BN允许网络使用饱和性激活函数（例如sigmoid，tanh等），缓解梯度消失问题<br><strong>7 torch.optim.Adam</strong><br>torch.optim.Adam(params, lr=0.001, betas=(0.9, 0.999), eps=1e-08, weight_decay=0)<br>参数：</p><ul><li>params (iterable) – 待优化参数的iterable或者是定义了参数组的dict</li><li>lr (float, 可选) – 学习率（默认：1e-3）</li><li>betas (Tuple[float, float], 可选) – 用于计算梯度以及梯度平方的运行平均值的系数（默认：0.9，0.999）,betas = （beta1，beta2）<br>beta1：一阶矩估计的指数衰减率（如 0.9）。<br>beta2：二阶矩估计的指数衰减率（如 0.999）。</li><li>eps (float, 可选) – 为了增加数值计算的稳定性而加到分母里的项（默认：1e-8）,epsilon：该参数是非常小的数，其为了防止在实现中除以零（如 10E-8）。</li><li>weight_decay (float, 可选) – 权重衰减（L2惩罚）（默认: 0），<strong>选择0.01比较好</strong></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># CNN</span><span class="token comment"># 0、导入工具包</span><span class="token keyword">import</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">as</span> Data <span class="token comment">#导入data数据集</span><span class="token keyword">from</span> torch<span class="token punctuation">.</span>autograd <span class="token keyword">import</span> Variable<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn<span class="token keyword">import</span> torch<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim<span class="token keyword">import</span> data_load<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np                               <span class="token comment"># 1、载入数据集</span>train_x<span class="token punctuation">,</span>train_y<span class="token punctuation">,</span>_<span class="token punctuation">,</span>_<span class="token operator">=</span>data_load<span class="token punctuation">.</span>data_load1_FFT<span class="token punctuation">(</span><span class="token punctuation">)</span>_<span class="token punctuation">,</span>_<span class="token punctuation">,</span>test_x<span class="token punctuation">,</span>test_y<span class="token operator">=</span>data_load<span class="token punctuation">.</span>data_load3_FFT<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>m<span class="token punctuation">,</span>n<span class="token punctuation">]</span><span class="token operator">=</span>np<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>train_x<span class="token punctuation">)</span><span class="token punctuation">[</span>m_test<span class="token punctuation">,</span>_<span class="token punctuation">]</span><span class="token operator">=</span>np<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>test_x<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>train_x<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token comment"># 2、设置超参数</span>EPOCH <span class="token operator">=</span> <span class="token number">500</span>BATCH_SIZE <span class="token operator">=</span> <span class="token number">20</span>LR <span class="token operator">=</span> <span class="token number">4e-6</span><span class="token comment"># 3、DataLoader获取迭代数据</span>train_x<span class="token operator">=</span>torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>train_x<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">[</span>m<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>train_y<span class="token operator">=</span>torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>train_y<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>test_x<span class="token operator">=</span>torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>test_x<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">[</span>m_test<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>test_y<span class="token operator">=</span>torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>test_y<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">## TensorDataset-用于tensor打包，类似zip功能</span>train_set <span class="token operator">=</span> Data<span class="token punctuation">.</span>TensorDataset<span class="token punctuation">(</span>train_x<span class="token punctuation">,</span>train_y<span class="token punctuation">)</span><span class="token comment">## 定义迭代器，获取迭代数据</span>train_loader<span class="token operator">=</span>Data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>dataset<span class="token operator">=</span>train_set<span class="token punctuation">,</span>batch_size<span class="token operator">=</span>BATCH_SIZE<span class="token punctuation">,</span>shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token comment"># 4、定义模型</span><span class="token keyword">class</span> <span class="token class-name">Model</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Model<span class="token punctuation">,</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>layer1<span class="token operator">=</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>                nn<span class="token punctuation">.</span>Conv1d<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                nn<span class="token punctuation">.</span>MaxPool1d<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#输出为[50,100,24]</span>        self<span class="token punctuation">.</span>layer2<span class="token operator">=</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>                nn<span class="token punctuation">.</span>Conv1d<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                nn<span class="token punctuation">.</span>MaxPool1d<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>fc<span class="token operator">=</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">,</span>nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                              nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">,</span>nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                              nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">,</span>nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                              nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                              <span class="token punctuation">)</span>        self<span class="token punctuation">.</span>fc2<span class="token operator">=</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>nn<span class="token punctuation">.</span>Softmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>        out<span class="token operator">=</span>self<span class="token punctuation">.</span>layer1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        out<span class="token operator">=</span>self<span class="token punctuation">.</span>layer2<span class="token punctuation">(</span>out<span class="token punctuation">)</span>        out<span class="token operator">=</span>out<span class="token punctuation">.</span>view<span class="token punctuation">(</span>out<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">#       print(out.size())#显示当前输出的维度</span>        out<span class="token operator">=</span>self<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>out<span class="token punctuation">)</span>        out<span class="token operator">=</span>self<span class="token punctuation">.</span>fc2<span class="token punctuation">(</span>out<span class="token punctuation">)</span>        <span class="token keyword">return</span> out<span class="token comment"># 5、模型实例化，定义优化器、损失函数</span>model<span class="token operator">=</span>Model<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span>optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>LR<span class="token punctuation">)</span><span class="token comment">#定义优化器</span>loss_function <span class="token operator">=</span>nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#定义损失函数</span><span class="token comment"># 6、训练模型</span><span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>EPOCH<span class="token punctuation">)</span><span class="token punctuation">:</span>        model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 在训练模型时会在前面加上：</span>    <span class="token keyword">for</span> step<span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>         batch_x <span class="token operator">=</span> Variable<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        batch_y <span class="token operator">=</span> Variable<span class="token punctuation">(</span>y<span class="token punctuation">)</span>        batch_x<span class="token operator">=</span>batch_x<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        output <span class="token operator">=</span> model<span class="token punctuation">(</span>batch_x<span class="token punctuation">)</span>                      <span class="token comment"># 输入训练数据</span>        loss <span class="token operator">=</span> loss_function<span class="token punctuation">(</span>output<span class="token punctuation">,</span> batch_y<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 计算误差</span>        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>                        <span class="token comment"># 清空上一次梯度</span>        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>                              <span class="token comment"># 误差反向传递</span>        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>                             <span class="token comment"># 优化器参数更新</span>            model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 在测试模型时会在前面加上：</span>    <span class="token keyword">if</span> epoch<span class="token operator">%</span><span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>        test_output<span class="token operator">=</span>model<span class="token punctuation">(</span>test_x<span class="token punctuation">)</span>        pred_y<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>test_output<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>        accuracy<span class="token operator">=</span><span class="token punctuation">(</span>pred_y<span class="token operator">==</span>test_y<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># accuracy=sum(pred_y==test_y.numpy())/test_y.size(0)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Epoch:'</span><span class="token punctuation">,</span>epoch<span class="token punctuation">,</span><span class="token string">'|Step:'</span><span class="token punctuation">,</span>step<span class="token punctuation">,</span><span class="token string">'|train loss:%.4f'</span><span class="token operator">%</span>loss<span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>              <span class="token string">'|test accuracy:%.4f'</span><span class="token operator">%</span>accuracy<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 深度学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pytorch </tag>
            
            <tag> 神经网络 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cnn pytorch实现（从获取数据到训练模型)</title>
      <link href="/2023/03/26/cnn-pytorch-shi-xian-cong-huo-qu-shu-ju-dao-xun-lian-mo-xing/"/>
      <url>/2023/03/26/cnn-pytorch-shi-xian-cong-huo-qu-shu-ju-dao-xun-lian-mo-xing/</url>
      
        <content type="html"><![CDATA[<h2 id="cnn整体框架（从获取数据到训练模型"><a href="#cnn整体框架（从获取数据到训练模型" class="headerlink" title="cnn整体框架（从获取数据到训练模型)"></a>cnn整体框架（从获取数据到训练模型)</h2><h3 id="1、导入必要包"><a href="#1、导入必要包" class="headerlink" title="1、导入必要包"></a>1、导入必要包</h3><pre class="line-numbers language-none"><code class="language-none">from torch.utils.data import DataLoaderimport torchvision.transforms as transformsfrom torchvision.utils import save_imagefrom scipy.io import loadmat import torch.utils.data as Data #导入data数据集from torch.autograd import Variableimport matplotlib.pyplot as pltimport torchvision  #数据库模块import numpy as npimport torch.nn as nnimport torch.nn.init as initimport torchimport torch.optimimport random<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2、获取数据"><a href="#2、获取数据" class="headerlink" title="2、获取数据"></a>2、获取数据</h3><pre class="line-numbers language-none"><code class="language-none"># 设置路径path='C:/Users/Desktop/fuse/代码/vibration data/' # 自己的路径，直接黏贴过来(注意反斜杠)epoch=500 # 运行的次数Batch_size=40 # 一次打包40个数据# 加载m文件的获取数据方法def data_load():    # 训练集    m=loadmat(path+'train1')   # m文件名    train_s=m['train']  # m文件里的变量名    train_x=train_s[:,0:400]  #我的m文件是（2400，401）加载前400行，数据    train_y=train_s[:,400]-1  #第401列为标签（0到400=401），标签名从0开始，这里减一是因为我的数据集标签从1开始    # 测试集    m=loadmat(path+'test1')   # test1为m文件名    test_s=m['test']  # m文件里的变量名    test_x=test_s[:,0:400]       test_y=test_s[:,400]-1        return train_x,train_y,test_x,test_y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3、数据处理"><a href="#3、数据处理" class="headerlink" title="3、数据处理"></a>3、数据处理</h3><pre class="line-numbers language-none"><code class="language-none"># 加载数据train_x_s1,train_y_s1,test_x_s1,test_y_s1=data_load()# 打包生成浮点数张量data=Data.TensorDataset(torch.FloatTensor(train_x_s1.reshape([2400,1,400])),                        torch.FloatTensor(train_y_s1))   # 为了一维卷积，所以要变换类型[2400,1,400],每个批次的装载数据都是3维的，维度构成batch_size,channel,height(N,C,H)# 进行数据封装train_loader=Data.DataLoader(dataset=data,batch_size=Batch_size,shuffle=True)test_x=Varible(torch.FloatTensor(test_x_s1.reshape([1200,1,400]))) # 转换为浮点型张量test_y=Variable(torch.LongTensor(test_y_s1))    # 转换为长实数张量<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="1、生成张量"><a href="#1、生成张量" class="headerlink" title="1、生成张量"></a>1、生成张量</h4><p><strong>TensorDataset</strong> 可以用来对 tensor 进行打包，就好像 python 中的 zip 功能。</p><p>函数传入的参数必须是tensor类型，</p><p>即：data=Data.TensorDataset(tensor类型，tensor类型)</p><p>**torch.FloatTensor()**默认生成32位浮点数张量，dtype 为 <code>torch.float32</code> 或 <code>torch.float</code></p><p>必须转化为浮点数，否则无法计算</p><h4 id="2、数据装载"><a href="#2、数据装载" class="headerlink" title="2、数据装载"></a>2、数据装载</h4><p>数据载入后，我们还需要对数据进行装载；</p><p>理解：数据载入后，我们需要将这些图片打包好送给我们的模型进行训练，装载就是个打包的过程</p><p>train_loader=Data.DataLoader(dataset=data,batch_size=Batch_size,shuffle=True)</p><p>装载时通过batch_size的值来确认每个包的大小，通过shuffle（重新洗牌）的值确认是否在装载的过程中<strong>打乱图片</strong>的顺序(utils(常用工具))</p><h4 id="3、数据预处理"><a href="#3、数据预处理" class="headerlink" title="3、数据预处理"></a>3、数据预处理</h4><p><strong>pytorch两个基本对象：Tensor（张量）和Variable（变量）</strong></p><p>其中，tensor不能反向传播，variable可以反向传播。</p><p><strong>pytorch都是由tensor计算的，而tensor里面的参数是variable形式。</strong></p><p><strong>Variable</strong>：一种可以不断变化的变量，符合反向传播，参数更新的属性。pytorch的variable是一个存放会变化值的地理位置，里面的值会不停变化。</p><h3 id="4、定义模型"><a href="#4、定义模型" class="headerlink" title="4、定义模型"></a>4、定义模型</h3><pre class="line-numbers language-none"><code class="language-none"># 定义网络结构class Model(nn.Module):    def __init__(self):        super(Model,self).__init__()        self.layer1=nn.Sequential(                nn.Conv1d(1,8,5), # 1代表1维                nn.ReLU(),                nn.MaxPool1d(5))#输出为[50,100,24]        self.layer2=nn.Sequential(                nn.Conv1d(8,16,3),                nn.ReLU(),                nn.MaxPool1d(3))  #这层的输出需要与下一层输入相同        self.fc=nn.Sequential(nn.Linear(16*25,280),nn.ReLU(), # print(out.size())，显示当前输出的维度这里的结果是400，16维，25长                              nn.Linear(280,180),nn.ReLU(),                              nn.Linear(180,60),nn.ReLU(),                              nn.Linear(60,30),nn.ReLU(),                              )        self.fc2=nn.Sequential(nn.Linear(30,12),nn.Softmax(dim=1)) # 12代表12类标签（0到11）    def forward(self,x):        out=self.layer1(x)        out=self.layer2(out)        out=out.view(out.size(0),-1)        # print(out.size())#显示当前输出的维度        out=self.fc(out)        out=self.fc2(out)        return out<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>除了上述的卷积开始的1以及之后全连接层的400以及全连接层的12以外，其他全部自定。</p><p><strong>卷积后输出图片大小：N = （W-F+2P）/ S +1</strong></p><p>W:输入图片，F:卷积核尺寸，S：步长, P: 填充</p><h4 id="0、nn-Sequential容器"><a href="#0、nn-Sequential容器" class="headerlink" title="0、nn.Sequential容器"></a>0、nn.Sequential容器</h4><pre class="line-numbers language-none"><code class="language-none">torch.nn.Sequential(            torch.nn.Conv2d(1,64,kernel_size=3,stride=1,padding=1),            torch.nn.ReLU(),            torch.nn.Conv2d(64,128,kernel_size=3,stride=1,padding=1),            torch.nn.ReLU(),            torch.nn.MaxPool2d(stride=2,kernel_size=2)        )<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一个有序的容器，<strong>神经网络模块将按照在传入构造器的顺序依次被添加到计算图中执行</strong>，同时以神经网络模块为元素的有序字典也可以作为传入参数。</p><h4 id="1、卷积"><a href="#1、卷积" class="headerlink" title="1、卷积"></a>1、卷积</h4><pre class="line-numbers language-none"><code class="language-none">torch.nn.Conv1d(in_channels, out_channels, kernel_size, stride=1, padding=0, dilation=1, groups=1, bias=True)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>out_channels(int) – 卷积产生的通道。有多少个out_channels，就需要多少个1维卷积 kernel_size(int or tuple) - 卷积核的尺寸，卷积核的大小为(k,)，第二个维度是由in_channels来决定的，所以实际上卷积大小为kernel_size*in_channels stride(int or tuple, optional) - 卷积步长 padding (int or tuple, optional)- 输入的每一条边补充0的层数 bias(bool, optional) - 如果bias=True，添加偏置</p><h4 id="2、激活"><a href="#2、激活" class="headerlink" title="2、激活"></a>2、激活</h4><pre class="line-numbers language-none"><code class="language-none">torch.nn.ReLU(inplace=False)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>inplace = False 时,<strong>不会修改输入对象的值,而是返回一个新创建的对象</strong>,所以打印出对象存储地址不同,类似于C语言的<strong>值传递</strong></li><li>inplace = True 时,会修改输入对象的值,所以打印出对象存储地址相同,类似于C语言的<strong>址传递</strong></li></ul><h4 id="3、最大池化"><a href="#3、最大池化" class="headerlink" title="3、最大池化"></a>3、最大池化</h4><pre class="line-numbers language-none"><code class="language-none">torch.nn.MaxPool2d(kernel_size, stride=None, padding=0, dilation=1, return_indices=False, ceil_mode=False)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>kernel_size(int or tuple)</strong> - max pooling的窗口大小，</p><p><strong>stride(int or tuple, optional)</strong> - max pooling的窗口移动的步长。默认值是kernel_size</p><p><strong>padding(int or tuple, optional)</strong> - 输入的每一条边补充0的层数</p><p><strong>ceil_mode</strong> - 如果等于True，计算输出信号大小的时候，会使用向上取整，代替默认的向下取整的操作</p><h4 id="4、全连接层"><a href="#4、全连接层" class="headerlink" title="4、全连接层"></a>4、全连接层</h4><pre class="line-numbers language-none"><code class="language-none">torch.nn.Linear(in_features,out_features,bias=True)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>in_features–池化后的张量大小（c * h * w相乘)</p><p>out_features–全连接层的神经元个数</p><h4 id="5、Dropout层"><a href="#5、Dropout层" class="headerlink" title="5、Dropout层"></a>5、Dropout层</h4><pre class="line-numbers language-none"><code class="language-none">torch.nn.Dropout(input, p=0.5, training=True, inplace=False)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>其作用是，在 training 模式下，基于伯努利分布抽样，以概率 p 对张量 input 的值随机置0</p><p><strong>input：</strong>输入张量</p><p><strong>p：</strong>默认 0.5，张量元素被置0的概率；</p><p><strong>training：</strong>默认 True，为 Ture 时执行dropout，为 False 时不执行，与<a href="https://blog.csdn.net/xiaoxiao_ziteng/article/details/114551912">模块模式</a>设置相关；</p><p><strong>inplace：</strong>默认 False，是否原地执行；</p><h4 id="6、softmax层"><a href="#6、softmax层" class="headerlink" title="6、softmax层"></a>6、softmax层</h4><pre class="line-numbers language-none"><code class="language-none">torch.nn.Softmax(dim=1)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://latex.codecogs.com/gif.latex?x=%5B1,2,3%5D%5C%5C%20softmax(x)=%5B%5Cfrac%7Be%5E1%7D%7Be%5E1+e%5E2+e%5E3%7D,%5Cfrac%7Be%5E2%7D%7Be%5E1+e%5E2+e%5E3%7D,%5Cfrac%7Be%5E3%7D%7Be%5E1+e%5E2+e%5E3%7D%5D" alt="x=[1,2,3]\\ softmax(x)=[\frac{e^1}{e^1+e^2+e^3},\frac{e^2}{e^1+e^2+e^3},\frac{e^3}{e^1+e^2+e^3}]"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">编辑</p><h4 id="7、前向传播"><a href="#7、前向传播" class="headerlink" title="7、前向传播"></a>7、前向传播</h4><p>类内调用——self.xx</p><p>self.conv1(x)，进行卷积处理；</p><p>x.view(-1,14 * 14 * 28)扁平化</p><p>self.dense(x)，全连接层</p><p>return 分类</p><h3 id="5、实例化以及定义"><a href="#5、实例化以及定义" class="headerlink" title="5、实例化以及定义"></a>5、实例化以及定义</h3><pre class="line-numbers language-none"><code class="language-none">model=Model()   # 模型类实例化print(model)optimizer = torch.optim.Adam(model.parameters(), lr=LR)#定义优化器loss_function =nn.CrossEntropyLoss()#定义损失函数，交叉熵损失函数<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="6、模型训练与参数优化"><a href="#6、模型训练与参数优化" class="headerlink" title="6、模型训练与参数优化"></a>6、模型训练与参数优化</h3><pre class="line-numbers language-none"><code class="language-none">for epoch in range(EPOCH):    for step, (x, y) in enumerate(train_loader):         batch_x = Variable(x) # pytorch里有两种数据类型，张量不能反向传播，为了反向传播，需要把张量x转换为variable        batch_y = Variable(y)        batch_x=batch_x.float() # 转换为浮点数        batch_y=batch_y.long()  # 转换为长实数，为了配合底层模型训练以及参数优化        #输入训练数据        output = model(batch_x)        #计算误差        loss = loss_function(output, batch_y)        #清空上一次梯度        optimizer.zero_grad()        #误差反向传递        loss.backward()        #优化器参数更新        optimizer.step() # 用测试集验证模型           if epoch%10 == 0:        test_output=model(test_x)        pred_y=torch.max(test_output,1)[1].data.numpy().squeeze()         accuracy=sum(pred_y==test_y.numpy())/test_y.size(0) # 准确率        # accuracy = torch.max(test_output, 1)[1].numpy() == test_y.numpy()            print('Epoch:',epoch,'|Step:',step,'|train loss:%.4f'%loss.data.numpy(),              '|test accuracy:%.4f'%accuracy)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>torch.max(test_output,1)[1]——取最大的值对应的标签为预测类型</p><p>torch.max(test_output,1)[0]——最大的值，即代表此类为预测类</p><p>取到标签后用转换为numpy类型ndarray，便于后续处理</p><p>输出为：第几次，每次里需要运行多少步，训练集损失率，测试集准确率</p>]]></content>
      
      
      <categories>
          
          <category> 深度学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pytorch </tag>
            
            <tag> 神经网络 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>迁移融合cnn</title>
      <link href="/2023/03/24/qian-yi-rong-he-cnn/"/>
      <url>/2023/03/24/qian-yi-rong-he-cnn/</url>
      
        <content type="html"><![CDATA[<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token triple-quoted-string string">"""Created on Mon Nov  8 21:55:02 2021@author: QB"""</span>  <span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> DataLoader<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> transforms<span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>utils <span class="token keyword">import</span> save_image<span class="token keyword">from</span> scipy<span class="token punctuation">.</span>io <span class="token keyword">import</span> loadmat <span class="token keyword">import</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">as</span> Data <span class="token comment">#导入data数据集</span><span class="token keyword">from</span> torch<span class="token punctuation">.</span>autograd <span class="token keyword">import</span> Variable<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt<span class="token keyword">import</span> torchvision  <span class="token comment">#数据库模块</span><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>init <span class="token keyword">as</span> init<span class="token keyword">import</span> torch<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim<span class="token keyword">import</span> random<span class="token keyword">import</span> os<span class="token keyword">import</span> cv2<span class="token keyword">from</span> numpy<span class="token punctuation">.</span>matlib <span class="token keyword">import</span> repmat<span class="token triple-quoted-string string">''' #设备选择，如果有GPU则用GPU，否则则用CPUMODEL_NAME = 'DANN'DEVICE = torch.device("cuda" if torch.cuda.is_available() else "cpu")'''</span><span class="token comment">#2.三个网络的搭建</span><span class="token comment">#2.1 搭建特征提取器网络</span><span class="token keyword">class</span> <span class="token class-name">Generator</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Generator<span class="token punctuation">,</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>layer1<span class="token operator">=</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>                nn<span class="token punctuation">.</span>Conv1d<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                nn<span class="token punctuation">.</span>BatchNorm1d<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                nn<span class="token punctuation">.</span>MaxPool1d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token comment">#输出为[50,100,24]</span>                <span class="token punctuation">)</span>        self<span class="token punctuation">.</span>layer2<span class="token operator">=</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>                nn<span class="token punctuation">.</span>Conv1d<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                nn<span class="token punctuation">.</span>BatchNorm1d<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                nn<span class="token punctuation">.</span>MaxPool1d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>fc<span class="token operator">=</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">8160</span><span class="token punctuation">,</span><span class="token number">680</span><span class="token punctuation">)</span><span class="token punctuation">,</span>nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                              nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">680</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">,</span>nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                              nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span><span class="token number">56</span><span class="token punctuation">)</span><span class="token punctuation">,</span>nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                              nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">56</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">,</span>nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                              <span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>        out<span class="token operator">=</span>self<span class="token punctuation">.</span>layer1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        <span class="token comment"># print(out.size())</span>        out<span class="token operator">=</span>self<span class="token punctuation">.</span>layer2<span class="token punctuation">(</span>out<span class="token punctuation">)</span>        <span class="token comment"># print(out.size())</span>        out<span class="token operator">=</span>out<span class="token punctuation">.</span>view<span class="token punctuation">(</span>out<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token comment"># print(out.size())#显示当前输出的维度</span>        out<span class="token operator">=</span>self<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>out<span class="token punctuation">)</span>        <span class="token keyword">return</span> out        <span class="token comment">#2.2 搭建分类器网络</span><span class="token keyword">class</span> <span class="token class-name">Classifier</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""        Classifier    """</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Classifier<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>                nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">,</span>num_classes<span class="token punctuation">)</span><span class="token punctuation">,</span>                nn<span class="token punctuation">.</span>Softmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">:</span>        c<span class="token operator">=</span>self<span class="token punctuation">.</span>fc2<span class="token punctuation">(</span>h<span class="token punctuation">)</span>        <span class="token keyword">return</span> c   <span class="token comment">#2.3 搭建域判别网络</span><span class="token keyword">class</span> <span class="token class-name">Discriminator</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""        Simple Discriminator w/ MLP    """</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Discriminator<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>                nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">,</span>                nn<span class="token punctuation">.</span>Softmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">:</span>        y <span class="token operator">=</span> self<span class="token punctuation">.</span>layer<span class="token punctuation">(</span>h<span class="token punctuation">)</span>        <span class="token keyword">return</span> y<span class="token comment"># 读取图片文件</span><span class="token keyword">def</span> <span class="token function">data_load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    vib_data2 <span class="token operator">=</span> vib2_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span>    vib_data3 <span class="token operator">=</span> vib3_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span>    data<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> path1 <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 得到路径path下的所有文件，返回list列表形式，返回的list列表顺序和path路径下的文件顺序是不一致</span>        new_path <span class="token operator">=</span> path<span class="token operator">+</span>path1<span class="token operator">+</span><span class="token string">"/"</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>new_path<span class="token punctuation">)</span>        <span class="token keyword">for</span> img1 <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>new_path<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 得到路径path下的所有文件，返回list列表形式，返回的list列表顺序和path路径下的文件顺序是不一致</span>            img_path <span class="token operator">=</span> new_path<span class="token operator">+</span>img1            image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>   <span class="token comment"># cv2.imread()用于读取图片文件，默认是1，读一副彩色3通道，imread函数有两个参数，第一个参数是图片路径，第二个参数表示读取图片的形式</span>                        <span class="token keyword">print</span><span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>            data<span class="token punctuation">.</span>append<span class="token punctuation">(</span>image<span class="token punctuation">)</span> <span class="token comment"># 尾部插入图片数据</span>    data <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>data<span class="token punctuation">)</span>   <span class="token comment"># 将数据转换为array，便于求平均值</span>    data <span class="token operator">=</span> np<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4000</span><span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment">#################分别打乱两个数据集，划分训练集测试集##############</span>    image_train <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    image_test <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    vib_train2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    vib_test2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    vib_train3 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    vib_test3 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    rate <span class="token operator">=</span> <span class="token number">0.6</span>    num <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">800</span><span class="token operator">*</span>rate<span class="token punctuation">)</span>    num2 <span class="token operator">=</span> <span class="token number">800</span><span class="token operator">-</span>num    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment">#打乱数据集</span>        temp1 <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">800</span><span class="token punctuation">:</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">800</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                temp3 <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>vib_data2<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">800</span><span class="token punctuation">:</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">800</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        temp4 <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>vib_data3<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">800</span><span class="token punctuation">:</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">800</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        index <span class="token operator">=</span> <span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>temp1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>         random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>index<span class="token punctuation">)</span>  <span class="token comment"># 打乱一维数组</span>        temp1 <span class="token operator">=</span> temp1<span class="token punctuation">[</span>index<span class="token punctuation">]</span>                temp3 <span class="token operator">=</span> temp3<span class="token punctuation">[</span>index<span class="token punctuation">]</span>        temp4 <span class="token operator">=</span> temp4<span class="token punctuation">[</span>index<span class="token punctuation">]</span>                <span class="token comment">#划分训练测试集</span>        image_train<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>num<span class="token punctuation">]</span><span class="token punctuation">)</span>        image_test<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp1<span class="token punctuation">[</span>num<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                                vib_train2<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>num<span class="token punctuation">]</span><span class="token punctuation">)</span>        vib_test2<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp3<span class="token punctuation">[</span>num<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                vib_train3<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>num<span class="token punctuation">]</span><span class="token punctuation">)</span>        vib_test3<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp4<span class="token punctuation">[</span>num<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    image_train <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>image_train<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>image_train<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>image_train<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>image_train<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>image_train<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">#  拼接，按垂直方向（行顺序）堆叠数组构成一个新的数组,堆叠的数组需要具有相同的维度</span>    image_test <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>image_test<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>image_test<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>image_test<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>image_test<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>image_test<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                          vib_train2 <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>vib_train2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>vib_train2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>vib_train2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>vib_train2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>vib_train2<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    vib_test2 <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>vib_test2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>vib_test2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>vib_test2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>vib_test2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>vib_test2<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        vib_train3 <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>vib_train3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>vib_train3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>vib_train3<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>vib_train3<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>vib_train3<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    vib_test3 <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>vib_test3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>vib_test3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>vib_test3<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>vib_test3<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>vib_test3<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    label_train <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">[</span>repmat<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>num<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>repmat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>num<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>repmat<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>num<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>repmat<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>num<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>repmat<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span>num<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>     <span class="token comment"># numpy.repeat(a,repeats,axis=None) a等于原数组，repeats：复制次数，axis=0，1，默认为o，axis=1,沿着x轴复制，实际上增加列数</span>    label_test  <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">[</span>repmat<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>num2<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>repmat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>num2<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>repmat<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>num2<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>repmat<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>num2<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>repmat<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span>num2<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                    <span class="token keyword">return</span> image_train<span class="token punctuation">,</span>  vib_train2<span class="token punctuation">,</span> vib_train3<span class="token punctuation">,</span> label_train<span class="token punctuation">,</span> image_test<span class="token punctuation">,</span>  vib_test2<span class="token punctuation">,</span> vib_test3<span class="token punctuation">,</span> label_test<span class="token comment"># 数据处理</span><span class="token keyword">def</span> <span class="token function">dataProcessing</span><span class="token punctuation">(</span>image_train<span class="token punctuation">,</span>  vib_train2<span class="token punctuation">,</span> vib_train3<span class="token punctuation">,</span> label_train<span class="token punctuation">,</span> image_test<span class="token punctuation">,</span> vib_test2<span class="token punctuation">,</span> vib_test3<span class="token punctuation">,</span> label_test<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 打乱训练测试集</span>    np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>  <span class="token comment"># 随机数，随机数种子：12，需要每次调用都seed()一下，表示种子相同，从而生成的随机数相同,打乱方式相同。</span>    np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>image_train<span class="token punctuation">)</span>    np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>    np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>vib_train2<span class="token punctuation">)</span>    np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>    np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>vib_train3<span class="token punctuation">)</span>    np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>    np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>label_train<span class="token punctuation">)</span>    np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span>    np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>image_test<span class="token punctuation">)</span>    np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span>    np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>vib_test2<span class="token punctuation">)</span>    np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span>    np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>vib_test3<span class="token punctuation">)</span>    np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span>    np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>label_test<span class="token punctuation">)</span>    label_train <span class="token operator">=</span> np<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>label_train<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">2400</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'int32'</span><span class="token punctuation">)</span>  <span class="token comment"># 改变数组格式，（2800，1）改变数组为（2800，）</span>    label_test  <span class="token operator">=</span> np<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>label_test<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1600</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'int32'</span><span class="token punctuation">)</span>    <span class="token comment"># TensorDataset对tensor进行打包</span>    train_loader <span class="token operator">=</span> Data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>dataset<span class="token operator">=</span>Data<span class="token punctuation">.</span>TensorDataset<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>image_train<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                                              torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>vib_train2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                                              torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>vib_train3<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                                              torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>label_train<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                   batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>    test_x <span class="token operator">=</span> Variable<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>image_test<span class="token punctuation">,</span> vib_test2<span class="token punctuation">,</span> vib_test3<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    test_y <span class="token operator">=</span> Variable<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>LongTensor<span class="token punctuation">(</span>label_test<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> train_loader <span class="token punctuation">,</span>test_x<span class="token punctuation">,</span>test_y<span class="token comment">#2.4 类实例化，实例化成为具体的一个网络模型</span>F <span class="token operator">=</span> Generator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#类实例化（实例化一个特征提取器）</span>C <span class="token operator">=</span> Classifier<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#类实例化（实例化一个分类器）</span>D <span class="token operator">=</span> Discriminator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#类实例化（实例化一个域判别器）</span><span class="token comment"># 超参数设定</span>max_epoch <span class="token operator">=</span> <span class="token number">100</span>batch_size <span class="token operator">=</span> <span class="token number">20</span>w <span class="token operator">=</span> <span class="token number">64</span>h <span class="token operator">=</span> <span class="token number">32</span><span class="token comment">#第四类学习率</span>LR<span class="token operator">=</span><span class="token number">4e-5</span><span class="token comment">#2.5 设定损失函数和优化函数</span>bce <span class="token operator">=</span> nn<span class="token punctuation">.</span>BCELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>xe <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#2.5 定义三个优化器（优化参数和学习率）</span>F_opt<span class="token operator">=</span>torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>F<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>lr<span class="token operator">=</span>LR<span class="token punctuation">)</span>C_opt<span class="token operator">=</span>torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>C<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>lr<span class="token operator">=</span>LR<span class="token punctuation">)</span>D_opt<span class="token operator">=</span>torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>D<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>lr<span class="token operator">=</span>LR<span class="token punctuation">)</span>n_critic <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment"># for training more k steps about Discriminator</span><span class="token comment">#载入源域</span><span class="token comment">#################读取图片数据和振动数据##########################</span>main_path <span class="token operator">=</span> <span class="token string">"D:/data/migreadte data/Data of elder brother MAO paper"</span>path <span class="token operator">=</span> main_path <span class="token operator">+</span><span class="token string">"/infrared_image_dataToEnhance/L0/"</span>vib2_path <span class="token operator">=</span> main_path<span class="token operator">+</span><span class="token string">"/experimental data_800/fft/频域负载L0.mat"</span>vib2_data <span class="token operator">=</span> loadmat<span class="token punctuation">(</span>vib2_path<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'Data_1_fft'</span><span class="token punctuation">]</span>vib3_path <span class="token operator">=</span> main_path<span class="token operator">+</span><span class="token string">"/experimental data_800/square spectrum/平方谱负载L0.mat"</span>vib3_data <span class="token operator">=</span> loadmat<span class="token punctuation">(</span>vib3_path<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'Data_1_spec'</span><span class="token punctuation">]</span>image_train_s<span class="token punctuation">,</span>  vib_train2_s<span class="token punctuation">,</span> vib_train3_s<span class="token punctuation">,</span> label_train_s<span class="token punctuation">,</span> image_test_s<span class="token punctuation">,</span> vib_test2_s<span class="token punctuation">,</span> vib_test3_s<span class="token punctuation">,</span> label_test_s<span class="token operator">=</span>data_load<span class="token punctuation">(</span><span class="token punctuation">)</span>train_loader_s <span class="token punctuation">,</span>test_x_s<span class="token punctuation">,</span>test_y_s<span class="token operator">=</span>dataProcessing<span class="token punctuation">(</span>image_train_s<span class="token punctuation">,</span>  vib_train2_s<span class="token punctuation">,</span> vib_train3_s<span class="token punctuation">,</span> label_train_s<span class="token punctuation">,</span> image_test_s<span class="token punctuation">,</span> vib_test2_s<span class="token punctuation">,</span> vib_test3_s<span class="token punctuation">,</span> label_test_s<span class="token punctuation">)</span><span class="token comment">#载入目标域</span>path <span class="token operator">=</span> main_path <span class="token operator">+</span><span class="token string">"/infrared_image_dataToEnhance/L70/"</span>vib2_path <span class="token operator">=</span> main_path<span class="token operator">+</span><span class="token string">"/experimental data_800/fft/频域负载L70.mat"</span>vib2_data <span class="token operator">=</span> loadmat<span class="token punctuation">(</span>vib2_path<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'Data_3_fft'</span><span class="token punctuation">]</span>vib3_path <span class="token operator">=</span> main_path<span class="token operator">+</span><span class="token string">"/experimental data_800/square spectrum/平方谱负载L70.mat"</span>vib3_data <span class="token operator">=</span> loadmat<span class="token punctuation">(</span>vib3_path<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'Data_3_spec'</span><span class="token punctuation">]</span>image_train_t<span class="token punctuation">,</span>  vib_train2_t<span class="token punctuation">,</span> vib_train3_t<span class="token punctuation">,</span> label_train_t<span class="token punctuation">,</span> image_test_t<span class="token punctuation">,</span> vib_test2_t<span class="token punctuation">,</span> vib_test3_t<span class="token punctuation">,</span> label_test_t<span class="token operator">=</span>data_load<span class="token punctuation">(</span><span class="token punctuation">)</span>train_loader_t <span class="token punctuation">,</span>test_x_t<span class="token punctuation">,</span>test_y_t<span class="token operator">=</span>dataProcessing<span class="token punctuation">(</span>image_train_t<span class="token punctuation">,</span>  vib_train2_t<span class="token punctuation">,</span> vib_train3_t<span class="token punctuation">,</span> label_train_t<span class="token punctuation">,</span> image_test_t<span class="token punctuation">,</span> vib_test2_t<span class="token punctuation">,</span> vib_test3_t<span class="token punctuation">,</span> label_test_t<span class="token punctuation">)</span><span class="token comment">#4 训练过程 </span><span class="token keyword">def</span> <span class="token function">get_lambda</span><span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> max_epoch<span class="token punctuation">)</span><span class="token punctuation">:</span>    p <span class="token operator">=</span> epoch <span class="token operator">/</span> max_epoch    <span class="token keyword">return</span> <span class="token number">2.</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10.</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1.</span>D_src <span class="token operator">=</span> torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># Discriminator Label to real</span>D_tgt <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># Discriminator Label to fake</span>D_labels <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>D_src<span class="token punctuation">,</span> D_tgt<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> max_epoch<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'第'</span><span class="token punctuation">,</span>epoch<span class="token punctuation">,</span><span class="token string">'次迭代'</span><span class="token punctuation">,</span><span class="token string">'，共'</span><span class="token punctuation">,</span>max_epoch<span class="token punctuation">,</span><span class="token string">'次'</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>step<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>image_x_s<span class="token punctuation">,</span>vib_x2_s<span class="token punctuation">,</span>vib_x3_s<span class="token punctuation">,</span> labels<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>image_x_t<span class="token punctuation">,</span>vib_x2_t<span class="token punctuation">,</span>vib_x3_t<span class="token punctuation">,</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>            <span class="token builtin">zip</span><span class="token punctuation">(</span>train_loader_s<span class="token punctuation">,</span>train_loader_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#        print(step)</span>        <span class="token comment">#对抗第一部分</span>        src<span class="token operator">=</span>Variable<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>image_x_s<span class="token punctuation">,</span>vib_x2_s<span class="token punctuation">,</span>vib_x3_s<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        src<span class="token operator">=</span>src<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>        tgt<span class="token operator">=</span>Variable<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>image_x_t<span class="token punctuation">,</span>vib_x2_t<span class="token punctuation">,</span>vib_x3_t<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        tgt<span class="token operator">=</span>tgt<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>        x<span class="token operator">=</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>src<span class="token punctuation">,</span> tgt<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>        h <span class="token operator">=</span> F<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token comment">#提取到的源域和目标域特征</span>        y <span class="token operator">=</span> D<span class="token punctuation">(</span>h<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#预测的域判别标签</span><span class="token comment">#        print(y)</span>         Ld <span class="token operator">=</span> bce<span class="token punctuation">(</span>y<span class="token punctuation">,</span> D_labels<span class="token punctuation">)</span><span class="token comment">#域判别损失函数</span>                D<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>        Ld<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>        D_opt<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>                 <span class="token comment">#对抗第二部分</span>        c <span class="token operator">=</span> C<span class="token punctuation">(</span>h<span class="token punctuation">[</span><span class="token punctuation">:</span>batch_size<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">#预测分类器标签</span>        y <span class="token operator">=</span> D<span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token comment">#预测的判别器标签</span>        Lc <span class="token operator">=</span> xe<span class="token punctuation">(</span>c<span class="token punctuation">,</span> labels<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#分类损失函数</span>        Ld <span class="token operator">=</span> bce<span class="token punctuation">(</span>y<span class="token punctuation">,</span> D_labels<span class="token punctuation">)</span><span class="token comment">#域判别损失函数</span>        lamda <span class="token operator">=</span> <span class="token number">0.1</span><span class="token operator">*</span>get_lambda<span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> max_epoch<span class="token punctuation">)</span>        <span class="token comment"># Ltot = Lc -lamda*Ld#损失函数</span>        Ltot <span class="token operator">=</span> Lc <span class="token operator">-</span><span class="token number">0.01</span><span class="token operator">*</span>Ld                F<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>        C<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>        D<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>                Ltot<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>                F_opt<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>        C_opt<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token keyword">if</span> step <span class="token operator">%</span> <span class="token number">500</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>            F<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            C<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment">#训练准确率</span>                        c1<span class="token operator">=</span>C<span class="token punctuation">(</span>F<span class="token punctuation">(</span>Variable<span class="token punctuation">(</span>test_x_s<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            _<span class="token punctuation">,</span> preds1 <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>            pred_label1<span class="token operator">=</span>preds1<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>            accu<span class="token operator">=</span><span class="token builtin">sum</span><span class="token punctuation">(</span>pred_label1<span class="token operator">==</span>test_y_s<span class="token punctuation">)</span><span class="token operator">/</span>np<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>test_y_s<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>            accu<span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> test_y_s<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>                        <span class="token comment">#测试准确率</span>                        c1<span class="token operator">=</span>C<span class="token punctuation">(</span>F<span class="token punctuation">(</span>Variable<span class="token punctuation">(</span>test_x_t<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            _<span class="token punctuation">,</span> preds <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>            pred_label<span class="token operator">=</span>preds<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment"># accuracy=sum(pred_label==test_y_t)/np.shape(test_y_t)[0]</span>            accuracy<span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> test_y_t<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span>np<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>test_y_t<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Epoch:'</span><span class="token punctuation">,</span>epoch<span class="token punctuation">,</span><span class="token string">'|Step:'</span><span class="token punctuation">,</span>step<span class="token punctuation">,</span><span class="token string">'|train loss:%.4f'</span><span class="token operator">%</span>Ltot<span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                  <span class="token string">'|test accuracy:%.4f'</span><span class="token operator">%</span>accuracy<span class="token punctuation">,</span><span class="token string">'|train accuracy:%.4f'</span><span class="token operator">%</span>accu<span class="token punctuation">)</span>                        F<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>            C<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>        step <span class="token operator">+=</span> <span class="token number">1</span>       <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 深度学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pytorch </tag>
            
            <tag> 神经网络 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pandas高级数据处理学习笔记（简略版）</title>
      <link href="/2023/03/24/pandas-gao-ji-shu-ju-chu-li-xue-xi-bi-ji-jian-lue-ban/"/>
      <url>/2023/03/24/pandas-gao-ji-shu-ju-chu-li-xue-xi-bi-ji-jian-lue-ban/</url>
      
        <content type="html"><![CDATA[<h2 id="一、缺失值处理"><a href="#一、缺失值处理" class="headerlink" title="一、缺失值处理"></a>一、缺失值处理</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd<span class="token number">1</span>、判断是否存在缺失值data<span class="token operator">=</span>pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'./1.csv'</span><span class="token punctuation">)</span>pd<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 返回True说明存在缺失值</span>pd<span class="token punctuation">.</span>notnull<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 返回False说明存在缺失值</span><span class="token number">2</span>、缺失值是nandata<span class="token punctuation">.</span>dropna<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># 删除</span>data<span class="token punctuation">[</span><span class="token string">'r'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'r'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment">#填补</span><span class="token number">3</span>、缺失值不是nandata_new<span class="token operator">=</span>data<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>to_replace<span class="token operator">=</span><span class="token string">'?'</span><span class="token punctuation">,</span>value<span class="token operator">=</span>np<span class="token punctuation">.</span>nan<span class="token punctuation">)</span>data_new<span class="token punctuation">.</span>dropna<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="二、one-hot"><a href="#二、one-hot" class="headerlink" title="二、one-hot"></a>二、one-hot</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 变成one-hot变量</span>sr<span class="token operator">=</span>pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>index<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">,</span><span class="token string">'y'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">,</span><span class="token string">'v'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'n'</span><span class="token punctuation">,</span><span class="token string">'m'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment"># 分组</span>pd<span class="token punctuation">.</span>qcut<span class="token punctuation">(</span>sr<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token comment"># bins=[0,3,6,9]</span><span class="token comment"># pd.cut(sr,bins)</span><span class="token comment"># 转换</span>pd<span class="token punctuation">.</span>get_dummies<span class="token punctuation">(</span>sr<span class="token punctuation">,</span>prefix<span class="token operator">=</span><span class="token string">'这是前缀'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="三、合并"><a href="#三、合并" class="headerlink" title="三、合并"></a>三、合并</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 按方向连接</span>data1<span class="token operator">=</span>pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>data1<span class="token punctuation">,</span>data2<span class="token punctuation">]</span><span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment"># 按索引连接</span>data2<span class="token operator">=</span>pd<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>left<span class="token punctuation">,</span>right<span class="token punctuation">,</span>how<span class="token operator">=</span><span class="token string">'inner'</span><span class="token punctuation">,</span>on<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'key1'</span><span class="token punctuation">,</span><span class="token string">'key2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="四、交叉表"><a href="#四、交叉表" class="headerlink" title="四、交叉表"></a>四、交叉表</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 交叉表</span>data<span class="token operator">=</span>pd<span class="token punctuation">.</span>crosstab<span class="token punctuation">(</span>values1<span class="token punctuation">,</span>values2<span class="token punctuation">)</span>data<span class="token punctuation">.</span>div<span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="五、分组与聚合"><a href="#五、分组与聚合" class="headerlink" title="五、分组与聚合"></a>五、分组与聚合</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 对color列分组，price1进行聚合</span>df<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token string">'color'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'price1'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 数据分析 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据分析 </tag>
            
            <tag> 数据挖掘 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>windows常用dos命令</title>
      <link href="/2023/03/23/windows-chang-yong-dos-ming-ling/"/>
      <url>/2023/03/23/windows-chang-yong-dos-ming-ling/</url>
      
        <content type="html"><![CDATA[<h1 id="1、打开CMD的方式："><a href="#1、打开CMD的方式：" class="headerlink" title="1、打开CMD的方式："></a>1、打开CMD的方式：</h1><ol><li>开始+系统+命令提示符</li><li>win键+R 输入cmd打开控制台</li><li>在任意的文件夹下边，按住Shift+鼠标右键点击，在此处打开命令行窗口（power shell)</li><li>资源管理器的地址栏前面加CMD+空格+路径</li></ol><p>管理员方式运行：选择以管理员方式运行（获取最高层次权限）</p><h1 id="2、常用的dos命令："><a href="#2、常用的dos命令：" class="headerlink" title="2、常用的dos命令："></a>2、常用的dos命令：</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">1</span>. <span class="token comment">#盘符切换</span><span class="token number">2</span>. <span class="token comment">#查看当前目录下的所有文件 dir</span><span class="token number">3</span>. <span class="token comment">#切换目录 cd (change directory)  cd/d D:（进入D盘）   cd/d F:\CAJ(进入F盘CAJ文件夹) </span><span class="token number">4</span>. <span class="token comment">#返回上一级 cd..  cd CAJ(进入同盘，下一级目录)</span><span class="token number">5</span>. <span class="token comment">#清理dos命令屏幕 cls (clear screen)</span><span class="token number">6</span>. <span class="token comment">#退出dos命令终端 exit</span><span class="token number">7</span>. <span class="token comment">#查看电脑IP ipconfig</span><span class="token number">8</span>. <span class="token comment">#打开软件 mspaint（打开画图软件） calc(打开计算器)    notepad(打开记事本)</span><span class="token number">9</span>. <span class="token comment">#ping命令 ping www.baidu.com(得到百度的IP地址) 测试网络是否正常</span><span class="token number">10</span> <span class="token comment">#文件操作  md 目录名（make创建文件夹） rd 目录名（r删除文件夹） cd&gt; 文件名（创建文件） del 文件名（删除文件）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
            <tag> windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dataframe常用技巧</title>
      <link href="/2023/03/23/dataframe-chang-yong-ji-qiao/"/>
      <url>/2023/03/23/dataframe-chang-yong-ji-qiao/</url>
      
        <content type="html"><![CDATA[<h2 id="1、os小结"><a href="#1、os小结" class="headerlink" title="1、os小结"></a>1、os小结</h2><p>os.getcwd()函数     #获得当前的路径</p><p>os.path.sep:       #路径分隔符 (相当于就是‘/’的作用）</p><p>os.path.join(os.getcwd(),’aaa’, ‘bbb’, ‘ccc’)   拼接出来多级目录：E:\test\aaa\bbb\ccc</p><p>os.path.abspath(path) #返回绝对路径</p><p>os.path.basename(path) #返回文件名</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">path <span class="token operator">=</span>  os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>os<span class="token punctuation">.</span>getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># 获取当前路径</span>input_path <span class="token operator">=</span> path<span class="token operator">+</span><span class="token string">'/data/'</span>             <span class="token comment"># 获取文件路径</span>featureName <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'carid'</span><span class="token punctuation">,</span> <span class="token string">'pushDate'</span><span class="token punctuation">,</span> <span class="token string">'pushPrice'</span><span class="token punctuation">,</span> <span class="token string">'updatePriceTimeJson'</span><span class="token punctuation">,</span> <span class="token string">'pullDate'</span><span class="token punctuation">,</span> <span class="token string">'withdrawDate'</span><span class="token punctuation">]</span>Train_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>input_path<span class="token punctuation">,</span><span class="token string">'附件4：门店交易训练数据.txt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">,</span> names<span class="token operator">=</span>featureName<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2、取整函数，近似函数"><a href="#2、取整函数，近似函数" class="headerlink" title="2、取整函数，近似函数"></a>2、取整函数，近似函数</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python">a<span class="token operator">=</span><span class="token number">3.4</span><span class="token comment"># 向下取整</span>b<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">#法1,b=3</span><span class="token keyword">import</span> mathb<span class="token operator">=</span>math<span class="token punctuation">.</span>floor<span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">#法2，b=3</span><span class="token comment"># 向上取整</span>c<span class="token operator">=</span>math<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment"># c=4</span><span class="token comment"># 四舍五入近似</span>df<span class="token punctuation">[</span><span class="token string">'car_age_year'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">round</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'car_age_day'</span><span class="token punctuation">]</span> <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># 指的是在四舍五入到1位</span>df<span class="token punctuation">[</span><span class="token string">'car_age_year'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'car_age_day'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>decimals<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># 指的是在四舍五入到1位</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3、处理目标值长尾分布"><a href="#3、处理目标值长尾分布" class="headerlink" title="3、处理目标值长尾分布"></a>3、处理目标值长尾分布</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#处理目标值长尾分布的问题</span>Train_data<span class="token punctuation">[</span><span class="token string">'carid'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>log1p<span class="token punctuation">(</span>Train_data<span class="token punctuation">[</span><span class="token string">'carid'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># 取log</span>Train_data<span class="token punctuation">[</span><span class="token string">'carid'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>expm1<span class="token punctuation">(</span>Train_data<span class="token punctuation">[</span><span class="token string">'carid'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># 用e还原</span><span class="token comment"># 合并方便后面的操作</span>df <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>Train_data<span class="token punctuation">,</span> Test_data<span class="token punctuation">]</span><span class="token punctuation">,</span> ignore_index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4、dataframe中的transform"><a href="#4、dataframe中的transform" class="headerlink" title="4、dataframe中的transform"></a>4、dataframe中的transform</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python">df<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'order'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'ext price'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">"""order10001     576.1210005    8185.4910006    3724.49Name: ext price, dtype: float64"""</span>df<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'order'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'ext price'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>transform<span class="token punctuation">(</span><span class="token string">'sum'</span><span class="token punctuation">)</span> <span class="token triple-quoted-string string">"""0      576.121      576.122      576.123     8185.494     8185.495     8185.496     8185.497     8185.498     3724.499     3724.4910    3724.4911    3724.49Name: ext price, dtype: float64"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5、dataframe日期数据处理"><a href="#5、dataframe日期数据处理" class="headerlink" title="5、dataframe日期数据处理"></a>5、dataframe日期数据处理</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python">data<span class="token punctuation">[</span><span class="token string">'withdrawDate'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'withdrawDate'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%Y/%m/%d'</span><span class="token punctuation">)</span><span class="token comment">#  构造日期和月份特征</span>data<span class="token punctuation">[</span><span class="token string">'pushDateMonth'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'pushDate'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dt<span class="token punctuation">.</span>monthdata<span class="token punctuation">[</span><span class="token string">'pushDateYear'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'pushDate'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dt<span class="token punctuation">.</span>yeardf<span class="token punctuation">[</span><span class="token string">'regDate_day'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'regDate'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dt<span class="token punctuation">.</span>daydf<span class="token punctuation">[</span><span class="token string">'car_age_day'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'creatDate'</span><span class="token punctuation">]</span> <span class="token operator">-</span> df<span class="token punctuation">[</span><span class="token string">'regDate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dt<span class="token punctuation">.</span>day<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="6、pandas-apply-函数用法"><a href="#6、pandas-apply-函数用法" class="headerlink" title="6、pandas apply() 函数用法"></a>6、pandas apply() 函数用法</h2><p>pandas 的 <code>apply()</code> 函数可以作用于 <code>Series</code> 或者整个 <code>DataFrame</code>，功能也是自动遍历整个 <code>Series</code> 或者 <code>DataFrame</code>, 对每一个元素运行指定的函数。</p><h3 id="6-1、Series-apply"><a href="#6-1、Series-apply" class="headerlink" title="6.1、Series.apply()"></a>6.1、Series.apply()</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python">df<span class="token punctuation">[</span><span class="token string">'ExtraScore'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'Nationality'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token number">5</span> <span class="token keyword">if</span> x <span class="token operator">!=</span> <span class="token string">'汉'</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># 如果df['Nationality']不是汉族，对应位置为5，否则为0</span>df<span class="token punctuation">[</span><span class="token string">'NameLength'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'Name'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">)</span> <span class="token comment"># df['Name']的长度为</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="6-2、lambda-函数"><a href="#6-2、lambda-函数" class="headerlink" title="6.2、lambda 函数"></a>6.2、lambda 函数</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> x<span class="token operator">*</span>y<span class="token comment"># 函数输入是x和y，输出是它们的积x*y</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="6-3、DataFrame-apply"><a href="#6-3、DataFrame-apply" class="headerlink" title="6.3、DataFrame.apply()"></a>6.3、DataFrame.apply()</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python">df<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>square<span class="token punctuation">)</span>   <span class="token comment">#整个df都做乘法运算</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="7、dataframe属性"><a href="#7、dataframe属性" class="headerlink" title="7、dataframe属性"></a>7、dataframe属性</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python">carid <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'carid'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 转换为list式</span>values <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'carid'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values <span class="token comment"># 得到列表内容</span>index <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'carid'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>index <span class="token comment"># 得到列表行索引</span>columns <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'carid'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>columns <span class="token comment"># 得到列表列索引</span>shape <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'carid'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape <span class="token comment"># 得到列表形状</span>dtype <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'carid'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dtype <span class="token comment"># 得到列表类型</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="8、astype函数用于array中数值类型转换"><a href="#8、astype函数用于array中数值类型转换" class="headerlink" title="8、astype函数用于array中数值类型转换"></a>8、astype函数用于array中数值类型转换</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 适用于numpy，转换数据类型</span>x <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>x1<span class="token operator">=</span>x<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="9、dataframe分析相关性"><a href="#9、dataframe分析相关性" class="headerlink" title="9、dataframe分析相关性"></a>9、dataframe分析相关性</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pdfeatureName <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'carid'</span><span class="token punctuation">,</span> <span class="token string">'pushDate'</span><span class="token punctuation">,</span> <span class="token string">'pushPrice'</span><span class="token punctuation">,</span> <span class="token string">'updatePriceTimeJson'</span><span class="token punctuation">,</span> <span class="token string">'pullDate'</span><span class="token punctuation">,</span> <span class="token string">'withdrawDate'</span><span class="token punctuation">]</span>datanew <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>path<span class="token operator">+</span><span class="token string">'附件4：门店交易训练数据.txt'</span><span class="token punctuation">,</span>sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">,</span> names<span class="token operator">=</span>featureName<span class="token punctuation">)</span><span class="token comment">#  分析相关性</span>cor<span class="token operator">=</span>datanew<span class="token punctuation">.</span>corr<span class="token punctuation">(</span>method<span class="token operator">=</span><span class="token string">'spearman'</span><span class="token punctuation">)</span>   <span class="token comment"># 相关性</span>pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>datanew<span class="token punctuation">.</span>corr<span class="token punctuation">(</span>method<span class="token operator">=</span><span class="token string">'spearman'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>decimals<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment"># round函数是4舍5入，decimals指的是在四舍五入到3位，即0.01245-》0.012</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="10、item（）的用法"><a href="#10、item（）的用法" class="headerlink" title="10、item（）的用法"></a>10、item（）的用法</h2><p>作用：<strong>取出单元素张量的元素值并返回该值</strong>（保持原元素类型不变）<br>即：原张量元素为整形，则返回整形，原张量元素为浮点型则返回浮点型。</p>]]></content>
      
      
      <categories>
          
          <category> 数据分析 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据分析 </tag>
            
            <tag> 数据挖掘 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SK net网络</title>
      <link href="/2023/03/23/sk-net-wang-luo/"/>
      <url>/2023/03/23/sk-net-wang-luo/</url>
      
        <content type="html"><![CDATA[<h2 id="一、理论部分"><a href="#一、理论部分" class="headerlink" title="一、理论部分"></a>一、理论部分</h2><p>SKNet <strong>针对卷积核的注意力机制</strong> 研究。</p><pre><code>不同大小的感受视野（卷积核）对于不同尺度（远近、大小）的目标会有不同的效果。尽管比如 Inception 这样的增加了多个卷积核来适应不同尺度图像，但是一旦训练完成后，参数就固定了，这样多尺度信息就会被全部使用了（每个卷积核的权重相同）</code></pre><p> SKNet 提出了一种机制，即 <strong>卷积核的重要性</strong> —— <strong>不同的图像能够得到具有不同重要性的卷积核</strong></p><img src="https://img-blog.csdnimg.cn/20200411202156202.png" alt="img" style="zoom:80%;"><p>网络主要由 Split、Fuse、Select 三部分组成。</p><ul><li><p><strong>Split 部分</strong>  是对原特征图经过 <strong>不同大小的卷积核</strong> 部分进行卷积的过程，这里可以有多个分支。</p><p>  对输入X使用不同大小卷积核分别进行卷积操作 (图中的卷积核 size 分别为 3×3 和 5×5 两个分支，但是可以有多个分支)。操作包括卷积、efficient grouped / depth-wise convolutions、BN。</p></li><li><p><strong>Fuse 部分</strong> 是 <strong>计算每个卷积核权重</strong> 的部分。</p><p>将两部分的特征图按元素求和</p><img src="https://img-blog.csdnimg.cn/20200411202318167.png" alt="img" style="zoom:100%;"><p>U 通过全局平均池化（GAP）生成通道统计信息。得到的 Sc 维度为 C×1</p><p><img src="https://img-blog.csdnimg.cn/20200411202359726.png" alt="img"></p><pre><code>经过全连接生成紧凑的特征 z（维度为 d×1）， δ 是 RELU 激活函数，B 表示批标准化（BN），z 的维度为卷积核的个数，W 维度为 d×C， d 代表全连接后的特征维度，L 在文中的值为 32，r 为压缩因子。</code></pre></li></ul><p><img src="https://img-blog.csdnimg.cn/9bece364cf4c4f02af0b62607382b529.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP55m95a2m5Lmg6K6w5b2V,size_14,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p><ul><li><p><strong>Select 部分</strong> 是根据不同权重卷积核计算后 <strong>得到的新的特征图</strong> 的过程。</p><p>  进行 Softmax 计算每个卷积核的权重，计算方式如下图所示。如果是两个卷积核，则 ac + bc = 1。z的维度为（d×1）A的维度为（C×d），B的维度为（C×d），则 a = A×z 的维度为1×C。</p><p>  Ac、Bc 为 A、B 的第 c 行数据（1×d）。ac 为 a 的第 c 个元素，这样分别得到了每个卷积核的权重。</p></li></ul><p><img src="https://img-blog.csdnimg.cn/20200411202614612.png" alt="img"></p><p>将权重应用到特征图上。其中 V = [V1,V2,…,VC]，Vc 维度为（H×W），如果</p><p><img src="https://img-blog.csdnimg.cn/20200411202656332.png" alt="img"></p><p>select 中 Softmax 部分可参考下图（3个卷积核）</p><p><img src="https://img-blog.csdnimg.cn/20200411202729627.png" alt="img"></p><h2 id="二、代码部分"><a href="#二、代码部分" class="headerlink" title="二、代码部分"></a>二、代码部分</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn<span class="token keyword">class</span> <span class="token class-name">SKConv</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span>out_channels <span class="token punctuation">,</span> M<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> G<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> r<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> L<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">""" Constructor        :param in_channels:  输入通道维度        :param out_channels: 输出通道维度   原论文中 输入输出通道维度相同        :param stride:  步长，默认为1        :param M:  分支数        :param r: 特征Z的长度，计算其维度d 时所需的比率（论文中 特征S-&gt;Z 是降维，故需要规定 降维的下界）        :param L: 论文中规定特征Z的下界，默认为32        :param G: 分组卷积G=32        """</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>SKConv<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        d <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>in_channels<span class="token operator">//</span> r<span class="token punctuation">)</span><span class="token punctuation">,</span> L<span class="token punctuation">)</span> <span class="token comment"># 计算向量Z 的长度d</span>        self<span class="token punctuation">.</span>M <span class="token operator">=</span> M        self<span class="token punctuation">.</span>out_channels <span class="token operator">=</span> out_channels        self<span class="token punctuation">.</span>convs <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># 根据分支数量 添加 不同核的卷积操作</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token comment"># 为提高效率，原论文中 扩张卷积5x5为 (3X3，dilation=2)来代替。且论文中建议分组卷积G=32</span>            self<span class="token punctuation">.</span>convs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span>stride<span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> groups<span class="token operator">=</span>G<span class="token punctuation">,</span>                          bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>out_channels<span class="token punctuation">)</span><span class="token punctuation">,</span>                nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>            <span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment"># 自适应 pool 到指定维度 - GAP</span>        self<span class="token punctuation">.</span>gap <span class="token operator">=</span> nn<span class="token punctuation">.</span>AdaptiveAvgPool2d<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>         self<span class="token punctuation">.</span>fc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>out_channels<span class="token punctuation">,</span> d<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">,</span>                                nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 降维</span>        self<span class="token punctuation">.</span>fcs <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>fcs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>d<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># 升维</span>            <span class="token punctuation">)</span>        self<span class="token punctuation">.</span>softmax <span class="token operator">=</span> nn<span class="token punctuation">.</span>Softmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># 指定 dim=1 令两个 FCs 对应位置进行 softmax,保证 对应位置a+b+..=</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        batch_size <span class="token operator">=</span> x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>        <span class="token comment">#the part of split</span>        feats <span class="token operator">=</span> <span class="token punctuation">[</span>conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> conv <span class="token keyword">in</span> self<span class="token punctuation">.</span>convs<span class="token punctuation">]</span>        feats <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>feats<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>        feats <span class="token operator">=</span> feats<span class="token punctuation">.</span>view<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>M<span class="token punctuation">,</span> self<span class="token punctuation">.</span>out_channels<span class="token punctuation">,</span> feats<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> feats<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token comment">#the part of fusion</span>        feats_U <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>feats<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 逐元素相加生成 混合特征</span>        feats_S <span class="token operator">=</span> self<span class="token punctuation">.</span>gap<span class="token punctuation">(</span>feats_U<span class="token punctuation">)</span>         feats_Z <span class="token operator">=</span> self<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>feats_S<span class="token punctuation">)</span> <span class="token comment">#降维</span>        <span class="token comment">#the part of Select</span>        attention_vectors <span class="token operator">=</span> <span class="token punctuation">[</span>fc<span class="token punctuation">(</span>feats_Z<span class="token punctuation">)</span> <span class="token keyword">for</span> fc <span class="token keyword">in</span> self<span class="token punctuation">.</span>fcs<span class="token punctuation">]</span>        attention_vectors <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>attention_vectors<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment"># 升维度</span>        attention_vectors <span class="token operator">=</span> attention_vectors<span class="token punctuation">.</span>view<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>M<span class="token punctuation">,</span> self<span class="token punctuation">.</span>out_channels<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>        attention_vectors <span class="token operator">=</span> self<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>attention_vectors<span class="token punctuation">)</span>        feats_V <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>feats <span class="token operator">*</span> attention_vectors<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> feats_V<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    t <span class="token operator">=</span> torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    sk <span class="token operator">=</span> SKConv<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">)</span>    out <span class="token operator">=</span> sk<span class="token punctuation">(</span>t<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>out<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 深度学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pytorch </tag>
            
            <tag> 神经网络 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>残差网络ResNet</title>
      <link href="/2023/03/23/can-chai-wang-luo-resnet/"/>
      <url>/2023/03/23/can-chai-wang-luo-resnet/</url>
      
        <content type="html"><![CDATA[<h2 id="一、定义"><a href="#一、定义" class="headerlink" title="一、定义"></a>一、定义</h2><p><strong>残差指的是什么？</strong><br>其中ResNet提出了两种mapping：一种是identity mapping，指的就是图1中”弯弯的曲线”，另一种residual mapping，指的就是除了”弯弯的曲线“那部分，所以最后的输出是 y=F(x)+x<br>identity mapping顾名思义，就是指本身，也就是公式中的xx，而residual mapping指的是“差”，也就是y−x，所以残差指的就是F(x)部分。<br><strong>ResNet结构：</strong></p><img src="https://img-blog.csdn.net/20180114184946861?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbGFucmFuMg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="img" style="zoom:50%;"><p>它使用了一种连接方式叫做“shortcut connection”，顾名思义，shortcut就是“抄近道”的意思</p><p><strong>为什么ResNet可以解决“随着网络加深，准确率不下降”的问题？</strong><br>理论上，对于“随着网络加深，准确率下降”的问题，Resnet提供了两种选择方式，也就是identity mapping和residual mapping，如果网络已经到达最优，继续加深网络，residual mapping将被push为0，只剩下identity mapping，这样理论上网络一直处于最优状态了，网络的性能也就不会随着深度增加而降低了。</p><h2 id="二、代码"><a href="#二、代码" class="headerlink" title="二、代码"></a>二、代码</h2><img src="https://img-blog.csdnimg.cn/20200514202531827.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDMzMTMwNA==,size_16,color_FFFFFF,t_70#pic_center" alt="img" style="zoom:50%;"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F<span class="token keyword">class</span> <span class="token class-name">basic_block</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''定义了带实线部分的残差块'''</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>in_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>basic_block<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span>in_channels<span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span>in_channels<span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        y <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>        y <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>y<span class="token punctuation">)</span>        <span class="token keyword">return</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token operator">+</span>y<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><em><strong>第二种是带有虚线标注的跳跃连接部分</strong></em>，第一种结构是在通道数不变的情况下，进行的残差结构运算，第二种的跳跃连接结构，通道数发生了改变，于是把它单独做成一个基础块，如下图：</p><img src="https://img-blog.csdnimg.cn/20200514201806710.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDMzMTMwNA==,size_16,color_FFFFFF,t_70#pic_center" alt="img" style="zoom:50%;"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">basic_block2</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''定义了带虚线部分的残差块'''</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>in_channels<span class="token punctuation">,</span>out_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>basic_block2<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span>out_channels<span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span>out_channels<span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>conv3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>out_channels<span class="token punctuation">,</span>out_channels<span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        z <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        y <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>        y <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3<span class="token punctuation">(</span>y<span class="token punctuation">)</span>        <span class="token keyword">return</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>y<span class="token operator">+</span>z<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 深度学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pytorch </tag>
            
            <tag> 神经网络 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>csSEnet注意力网络</title>
      <link href="/2023/03/23/cssenet-zhu-yi-li-wang-luo/"/>
      <url>/2023/03/23/cssenet-zhu-yi-li-wang-luo/</url>
      
        <content type="html"><![CDATA[<h2 id="一、cSE网络模型-通道注意力机制"><a href="#一、cSE网络模型-通道注意力机制" class="headerlink" title="一、cSE网络模型(通道注意力机制)"></a>一、cSE网络模型(通道注意力机制)</h2><p><strong>通道注意力机制</strong>：就是对于每个channel赋予不同的权重，比如1，2处马的形状比较明显，所以理所当然，对1，2通道的权重比较大，3，4处权重小。</p><p><strong>CSEnet的模型结构，该注意力机制主要分为三部分：挤压（squeeze）、激励（excitation)、注意（scale）</strong></p><p>计算机视觉研究领域的一个<strong>核心理论就是如何提高网络的表现力使其关注到图片的关键位置，从而提升网络性能</strong>。与一般网络通过空间维度优化不同，SENet(Squeeze-and-Excitation Networks)着手于<strong>优化channel维度</strong>，通过引入注意力机制，增加少量参数，使模型可以更好地<strong>获取不同channel上的特征</strong>，从而<strong>提高准确率。</strong><br><img src="https://img-blog.csdnimg.cn/20210423123048195.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2NTg0Njcz,size_16,color_FFFFFF,t_70" alt="img"></p><p>SE(Squeeze-and-Excitation)，顾名思义：压缩-激活网络。如上图所示，输入X是C’×H’×W’的张量，经过卷积操作生成feature map U为C×H×W，对feature map进行压缩-激活操作。保留通道数C不变，将H×W变成1×1，接下来通过一系列激活操作，最后再将激活后的结果与U对位相乘得到最后的结果。那么S和E过程具体是如何操作的呢？</p><p>1、是squeeze操作，从空间维度进行特征压缩，将h * w * c的特征变为1 * 1* c的特征，得到向量某种程度上具有全域性的感受野，并且输出的通道数和输入的特征通道数相匹配，它表示在特征通道上响应的全域性分布。操作简单，<strong>全局平均池化</strong></p><p>2、是excitation操作，通过引入w参数来为每个特征通道生成权重，其中w就是一个多层感知器，是可以学习的，中间经过一个降维，减少参数量。并通过一个sogmoid函数获得0——1之间归一化的权重，完成显式建模特征通道数间的相关性</p><p>3、是sacle操作，将excitation的输出的权重看作是经过选择后的每个特征通道的重要性，通过通道宽度相乘加权到先前特征上，完成在通道维度上的对原始特征的重构</p><h3 id="1、Squeeze"><a href="#1、Squeeze" class="headerlink" title="1、Squeeze"></a>1、Squeeze</h3><p>将C×H×W的Feature map变为C×1×1大小。保留通道数不变，改变分辨率用的是池化操作，根据文章</p><p>此处为Global pooling。Pytorch实现如下:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">self<span class="token punctuation">.</span>avg_pool <span class="token operator">=</span> nn<span class="token punctuation">.</span>AdaptiveAvgPool2d<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span>，<span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment"># 自适应池化，指定池化输出尺寸为 1 * 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>该步骤的目的是<strong>获取全局信息</strong></p><p>作用：如果要预测K个类别，在卷积特征抽取部分的最后一层卷积层，就会生成K个特征图，然后通过全局平均池化就可以得到 K个1×1的特征图，将这些1×1的特征图输入到softmax layer之后，每一个输出结果代表着这K个类别的概率（或置信度 confidence），起到取代全连接层的效果</p><h4 id="全局平均池化（Global-Average-Pooling）"><a href="#全局平均池化（Global-Average-Pooling）" class="headerlink" title="全局平均池化（Global Average Pooling）"></a>全局平均池化（Global Average Pooling）</h4><p>定义：将特征图所有像素值相加求平局，得到一个数值，即用该数值表示对应特征图。</p><p>目的：替代全连接层</p><p>效果：减少参数数量，减少计算量，减少过拟合</p><p> 思路：如下图所示。假设最终分成10类，则最后卷积层应该包含10个滤波器（即输出10个特征图），然后按照全局池化平均定义，分别对每个特征图，累加所有像素值并求平均，最后得到10个数值，将这10个数值输入到softmax层中，得到10个概率值，即这张图片属于每个类别的概率值。<br><img src="https://img-blog.csdn.net/20180201141956028?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveWltaW5nc2lsZW5jZQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="img" style="zoom:67%;"></p><p><strong>意义</strong>：对整个网络从结构上做正则化防止过拟合，剔除了全连接层黑箱子操作的特征，直接赋予了每个channel实际的类别意义。</p><h3 id="2、Excitation"><a href="#2、Excitation" class="headerlink" title="2、Excitation"></a>2、Excitation</h3><p>经过一系列激活操作，但不改变操作前后的大小和通道数。具体如何实现见下图：</p><img src="https://img-blog.csdnimg.cn/20210423124701110.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2NTg0Njcz,size_16,color_FFFFFF,t_70" alt="img" style="zoom:50%;"><p>如图片右侧结构所示：Excitation为：FC→ReLU→FC→Sigmoid<br>具体细节如下：FC为一个全连接层Linear(C, C/r)将特征压缩到C/r通道（r为reduction是通道压缩倍率，一般取16可以平衡准确率和模型复杂性，详见论文6.1节），然后使用ReLU，接着再用一个FC层Linear(C/r, C)将特征还原至C通道，最后使用一个Simoid函数激活 Pytorch实现如下:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">self<span class="token punctuation">.</span>excitation <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>channel<span class="token punctuation">,</span>channel<span class="token operator">//</span><span class="token number">16</span><span class="token punctuation">,</span>bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>channel<span class="token operator">//</span><span class="token number">16</span><span class="token punctuation">,</span>channel<span class="token punctuation">,</span>bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>该步骤的目的是：<strong>Adaptive Recalibration(适合的再校准)，重新校准特征，让上一步操作获得的通道信息特征相互响应</strong></p><h3 id="3、完整CSE-block的Pytorch实现"><a href="#3、完整CSE-block的Pytorch实现" class="headerlink" title="3、完整CSE block的Pytorch实现"></a>3、完整CSE block的Pytorch实现</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn<span class="token keyword">class</span> <span class="token class-name">cSE_Module</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> channel<span class="token punctuation">,</span>ratio <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>cSE_Module<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>squeeze <span class="token operator">=</span> nn<span class="token punctuation">.</span>AdaptiveAvgPool2d<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>excitation <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>                nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span>channel<span class="token punctuation">,</span> out_features<span class="token operator">=</span>channel <span class="token operator">//</span> ratio<span class="token punctuation">)</span><span class="token punctuation">,</span>                nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span>channel <span class="token operator">//</span> ratio<span class="token punctuation">,</span> out_features<span class="token operator">=</span>channel<span class="token punctuation">)</span><span class="token punctuation">,</span>                nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _ <span class="token operator">=</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">#1,16,64,64</span>        y <span class="token operator">=</span> self<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>b<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token comment">#1,16</span>        z <span class="token operator">=</span> self<span class="token punctuation">.</span>excitation<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">#1,16,1,1</span>        <span class="token keyword">return</span> x <span class="token operator">*</span> z<span class="token punctuation">.</span>expand_as<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token comment"># y.expand_as(x) 把y变成和x一样的形状1，16，64，64</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>1.专注网络的channel关系，而不是空间关系<br>2.Squeeze建立channel间的依赖关系；Excitation重新校准特征。二者结合强调有用特征抑制无用特征。<br>3.能有效提升模型性能，提高准确率。几乎可以无脑添加到backbone中。根据论文，SE block应该加在Inception block之后，ResNet网络应该加在shortcut之前，将前后对应的通道数对应上即可</p><h2 id="二、sSE模块"><a href="#二、sSE模块" class="headerlink" title="二、sSE模块"></a>二、sSE模块</h2><img src="https://img-blog.csdnimg.cn/20200603100402128.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2p1c3Rzb2xvdw==,size_16,color_FFFFFF,t_70" alt="img" style="zoom:50%;"><p><strong>空间注意力：</strong><br>空间注意力是对64个通道进行mean的一个操作，得到一个（w x h）的权重，mean的操作就学到了所有通道的整体分布，而抛弃了奇异的通道。比如说1，2的图可以很好的描绘出马的形状，而3，4就不行（但本质上它也是要显示出马的形状），但是通过mean后，得到的w x h权值共享后，给了3，4一定的权值描述，相当于给3，4一定的注意力，这样它们也可以描绘出马的形状。</p><p>上图是<strong>空间注意力机制</strong>的实现</p><p>1、直接对feature map使用1×1×1卷积, 从[C, H, W]变为[1, H, W]的features<br>2、然后使用sigmoid进行激活得到spatial attention map<br>3、然后直接施加到原始feature map中，完成空间的信息校准</p><p>代码：</p><pre class="line-numbers language-pytnon" data-language="pytnon"><code class="language-pytnon">class sSE_Module(nn.Module):    def __init__(self, channel):        super(sSE_Module, self).__init__()        self.spatial_excitation = nn.Sequential(                nn.Conv2d(in_channels=channel, out_channels=1, kernel_size=1,stride=1,padding=0),                nn.Sigmoid()            )    def forward(self, x):        z = self.spatial_excitation(x)        return x * z.expand_as(x)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="三、scSE模块"><a href="#三、scSE模块" class="headerlink" title="三、scSE模块"></a>三、scSE模块</h2><img src="https://img-blog.csdnimg.cn/20200603100612339.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2p1c3Rzb2xvdw==,size_16,color_FFFFFF,t_70" alt="img" style="zoom:50%;"><p>代码：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn<span class="token keyword">import</span> torchvision<span class="token keyword">class</span> <span class="token class-name">cSE_Module</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> channel<span class="token punctuation">,</span>ratio <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>cSE_Module<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>squeeze <span class="token operator">=</span> nn<span class="token punctuation">.</span>AdaptiveAvgPool2d<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>excitation <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>                nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span>channel<span class="token punctuation">,</span> out_features<span class="token operator">=</span>channel <span class="token operator">//</span> ratio<span class="token punctuation">)</span><span class="token punctuation">,</span>                nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span>channel <span class="token operator">//</span> ratio<span class="token punctuation">,</span> out_features<span class="token operator">=</span>channel<span class="token punctuation">)</span><span class="token punctuation">,</span>                nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _ <span class="token operator">=</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span>        y <span class="token operator">=</span> self<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>        z <span class="token operator">=</span> self<span class="token punctuation">.</span>excitation<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> x <span class="token operator">*</span> z<span class="token punctuation">.</span>expand_as<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">sSE_Module</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>sSE_Module<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>spatial_excitation <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span>channel<span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        z <span class="token operator">=</span> self<span class="token punctuation">.</span>spatial_excitation<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        <span class="token keyword">return</span> x <span class="token operator">*</span> z<span class="token punctuation">.</span>expand_as<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">scSE_Module</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> channel<span class="token punctuation">,</span>ratio <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>scSE_Module<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>cSE <span class="token operator">=</span> cSE_Module<span class="token punctuation">(</span>channel<span class="token punctuation">,</span>ratio<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>sSE <span class="token operator">=</span> sSE_Module<span class="token punctuation">(</span>channel<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>cSE<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>sSE<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">'__main__'</span><span class="token punctuation">:</span>    <span class="token comment"># model = cSE_Module(channel=16)</span>    <span class="token comment"># model = sSE_Module(channel=16)</span>    model <span class="token operator">=</span> scSE_Module<span class="token punctuation">(</span>channel<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span>    <span class="token builtin">input</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>    out <span class="token operator">=</span> model<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>out<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 深度学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pytorch </tag>
            
            <tag> 神经网络 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>对抗网络实现特征迁移技术路线</title>
      <link href="/2023/03/23/dui-kang-wang-luo-shi-xian-te-zheng-qian-yi-ji-zhu-lu-xian/"/>
      <url>/2023/03/23/dui-kang-wang-luo-shi-xian-te-zheng-qian-yi-ji-zhu-lu-xian/</url>
      
        <content type="html"><![CDATA[<h2 id="特征提取器目标"><a href="#特征提取器目标" class="headerlink" title="特征提取器目标"></a>特征提取器目标</h2><p>将源域和目标域样本输入，目标是使得提取的特征<strong>与域无关，同时能够正确分类</strong>。</p><h2 id="分类器目标"><a href="#分类器目标" class="headerlink" title="分类器目标"></a>分类器目标</h2><p>训练源域模型</p><ul><li>损失函数的目的是：预测的<strong>源域分类器</strong>标签与<strong>真实</strong>标签相差尽可能小</li></ul><h2 id="域判别器目标"><a href="#域判别器目标" class="headerlink" title="域判别器目标"></a>域判别器目标</h2><p>将源域特征和目标域特征<strong>尽可能区分</strong>。</p><ul><li>目标是：分清楚源域与目标域</li><li>损失函数的目的是：预测的<strong>源域判别标签</strong>与<strong>真实域</strong>标签相差尽可能小</li></ul><h2 id="最终目标"><a href="#最终目标" class="headerlink" title="最终目标"></a>最终目标</h2><p>通过特征提取器和域判别器之间相互对抗，训练出一个能够<strong>提取域不敏感同时有很好分类能力的特征</strong>。</p><ul><li>测试：目标域测试</li><li>目标：使用<strong>训练好的源域分类器</strong>，将<strong>目标域特征输入</strong>得到的标签与<strong>真实</strong>标签对比，分类尽可能的高</li></ul><p><img src="https://img-blog.csdnimg.cn/f1a9b06efbfd45819017780329f64440.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP55m95a2m5Lmg6K6w5b2V,size_14,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>]]></content>
      
      
      <categories>
          
          <category> 深度学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pytorch </tag>
            
            <tag> 神经网络 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>深度学习调参侠</title>
      <link href="/2023/03/23/shen-du-xue-xi-diao-can-xia/"/>
      <url>/2023/03/23/shen-du-xue-xi-diao-can-xia/</url>
      
        <content type="html"><![CDATA[<p>在面对模型不收敛的时候，首先要保证训练的次数够多。在训练过程中，loss并不是一直在下降，准确率一直在提升的，会有一些震荡存在。只要总体趋势是在收敛就行。若训练次数够多（一般上千次，上万次，或者几十个epoch）没收敛，再考虑采取措施解决。</p><h2 id="一、数据与标签"><a href="#一、数据与标签" class="headerlink" title="一、数据与标签"></a>一、数据与标签</h2><p>没有对数据进行预处理。数据分类标注是否准确？数据是否干净？</p><p>没有对数据进行归一化。由于不同评价指标往往具有不同的量纲和量纲单位，这样的情况会影响到数据分析的结果，为了消除指标之间的量纲影响，需要进行数据标准化处理，以解决数据指标之间的可比性。原始数据经过数据标准化处理后，各指标处于同一数量级，适合进行综合对比评价。此外，大部分神经网络流程都假设输入输出是在0附近的分布，从权值初始化到激活函数、从训练到训练网络的优化算法。将数据减去均值并除去方差。</p><p>样本的信息量太大导致网络不足以fit住整个样本空间。样本少只可能带来过拟合的问题，你看下你的training set上的loss收敛了吗？如果只是validate set上不收敛那就说明overfitting了，这时候就要考虑各种anti-overfit的trick了，比如dropout，SGD，增大minibatch的数量，减少fc层的节点数量，momentum，finetune等。</p><p>标签的设置是否正确。</p><h2 id="二、模型"><a href="#二、模型" class="headerlink" title="二、模型"></a>二、模型</h2><h3 id="1-网络设定不合理"><a href="#1-网络设定不合理" class="headerlink" title="1. 网络设定不合理"></a>1. 网络设定不合理</h3><p>如果做很复杂的分类任务，却只用了很浅的网络，可能会导致训练难以收敛。应当选择合适的网络，或者尝试加深当前网络。总体来说，网络不是越深越好，开始可以搭建一个3~8层的网络，当这个网络实现的不错时，你可以考虑实验更深的网络来提升精确度。从小网络开始训练意味着更快，并且可以设置不同参数观察对网络的影响而不是简单的堆叠更多层。</p><h3 id="2-Learning-rate不合适"><a href="#2-Learning-rate不合适" class="headerlink" title="2. Learning rate不合适"></a>2. Learning rate不合适</h3><p>如果太大，会造成不收敛，如果太小，会造成收敛速度非常慢。学习率设定不合理。在自己训练新网络时，可以从0.1开始尝试，如果loss不下降的意思，那就降低，除以10，用0.01尝试，一般来说0.01会收敛，不行的话就用0.001. 学习率设置过大，很容易震荡。</p><p>不过刚刚开始不建议把学习率设置过小，尤其是在训练的开始阶段。在开始阶段我们不能把学习率设置的太低否则loss不会收敛。我的做法是逐渐尝试，从0.1,0.08,0.06,0.05 ……逐渐减小直到正常为止。有的时候候学习率太低走不出低估，把冲量提高也是一种方法，适当提高mini-batch值，使其波动不大。</p><p>learning rate设大了会带来跑飞（loss突然一直很大）的问题。这个是新手最常见的情况——为啥网络跑着跑着看着要收敛了结果突然飞了呢？可能性最大的原因是你用了relu作为激活函数的同时使用了softmax或者带有exp的函数做分类层的loss函数。</p><p>当某一次训练传到最后一层的时候，某一节点激活过度（比如100），那么exp(100)=Inf，发生溢出，bp后所有的weight会变成NAN，然后从此之后weight就会一直保持NAN，于是loss就飞起来辣。如果lr设的过大会出现跑飞再也回不来的情况。这时候你停一下随便挑一个层的weights看一看，很有可能都是NAN了。对于这种情况建议用二分法尝试。0.1~0.0001.不同模型不同任务最优的lr都不一样。</p><h3 id="3-隐层神经元数量错误"><a href="#3-隐层神经元数量错误" class="headerlink" title="3. 隐层神经元数量错误"></a>3. 隐层神经元数量错误</h3><p>在一些情况下使用过多或过少的神经元数量都会使得网络很难训练。太少的神经元数量没有能力来表达任务，而太多的神经元数量会导致训练缓慢，并且网络很难清除一些噪声。</p><p>隐层神经元数量可以从256 到1024中间开始设置，然后可以看看研究人员使用的数字，可以用作参考。如果他们使用的数字与这个大不相同，那么可以想象一下这其中的原理。在决定使用隐层的单元数量之前，最为关键的是考虑你需要通过这个网络表达信息的实际值的最少数量，然后再慢慢增加这个数字。如果你做回归任务可以考虑使用的神经元数量为输入或输出变量的2到3倍。</p><p>实际上，与其它因素相比，隐藏单元的数量通常对于神经网络的性能影响相当小。并且在很多情况下，增大所需要隐藏单元的数量仅仅是减慢了训练速度。</p><h3 id="4-错误初始化网络参数"><a href="#4-错误初始化网络参数" class="headerlink" title="4. 错误初始化网络参数"></a>4. 错误初始化网络参数</h3><p>如果没有正确初始化网络权重，那么网络将不能训练。通常使用的比较多的初始化权重的方法有‘he’,’lecun’,’xavier’在实际应用中这些方法有非常好的性能而网络偏差通常初始化为0，你可以选择一个最适合你任务的初始化方式。</p><h3 id="5-没有正则化"><a href="#5-没有正则化" class="headerlink" title="5. 没有正则化"></a>5. 没有正则化</h3><p>正则化典型的就是dropout、加噪声等。即使数据量很大或者你觉得网络不可能出现过拟合，但是对网络进行正则化还是很有必要的。dropout 通常从设定参数为0.75或0.9开始，根据你认为网络出现过拟合的可能性来调整这个参数。</p><p>另外，如果你确定这个网络不会出现过拟合，那么可以将参数设定为0.99。正则化不仅仅可以防止过拟合，并且在这个随机过程中，能够加快训练速度以及帮助处理数据中的异常值并防止网络的极端权重配置。对数据扩增也能够实现正则化的效果，最好的避免过拟合的方法就是有大量的训练数据。</p><h3 id="6-Batch-Size-过大"><a href="#6-Batch-Size-过大" class="headerlink" title="6. Batch Size 过大"></a>6. Batch Size 过大</h3><p>Batch size 设置的过大会降低网络的准确度，因为它降低了梯度下降的随机性。另外，在相同情况下batch size 越大那么要达到相同的精确度通常需要训练更多的epoch。我们可以尝试一些较小的batch size 如 16 ，8 甚至是1。使用较小的batch size 那么一个epoch就可以进行更多次的权值更新。这里有两个好处，第一，可以跳出局部最小点。其二可以表现出更好的泛化性能。</p><h3 id="7-学习率设的不对"><a href="#7-学习率设的不对" class="headerlink" title="7. 学习率设的不对"></a>7. 学习率设的不对</h3><p>许多深度学习的框架默认开启了gradient clipping ,这个可以处理gradient explosion问题，这个是非常有用的，但是在默认情况下它也很难找到最佳学习率。如果你正确的清理了数据，删除了异常值，以及设定了正确的学习率，那么可以不需要使用gradient clipping，偶尔你也会遇到gradient explosion问题，那么你可以开启gradient clipping。但是，出现这种问题一般情况下表明数据有其它问题，而gradient clipping只是一个临时的解决方案。</p><h3 id="8-最后一层的激活函数用的不对"><a href="#8-最后一层的激活函数用的不对" class="headerlink" title="8. 最后一层的激活函数用的不对"></a>8. 最后一层的激活函数用的不对</h3><p>在最后一层使用错误的激活函数会导致网络最终不能输出你期望的范围值，最常见的错误就是最后一层使用Relu函数，其输出无负值。如果是做回归任务，大多数情况下不需要使用激活函数，除非你知道你所期望的值作为输出。想象一下你的数据值实际代表了什么，以及再归一化之后它们的范围是多少，最有可能的情况是输出没有边界的正数和负数。在这种情况下，最后一层不应该使用激活函数。如果你的输出值只能在某个范围内有意义，如0~1范围内的概率组成。那么最后一层可以使用sigmoid函数。</p><h3 id="9-网络存在坏梯度"><a href="#9-网络存在坏梯度" class="headerlink" title="9. 网络存在坏梯度"></a>9. 网络存在坏梯度</h3><p>如果你训练了几个epoch误差没有改变,那可能是你使用了Relu，可以尝试将激活函数换成leaky Relu。因为Relu激活函数对正值的梯度为1，负值的梯度为0。因此会出现某些网络权值的成本函数的斜率为0，在这种情况下我们说网络是“dead”,因为网络已经不能更新。</p><h3 id="10、如何通过train-loss与test-loss分析网络当下的状况？"><a href="#10、如何通过train-loss与test-loss分析网络当下的状况？" class="headerlink" title="10、如何通过train loss与test loss分析网络当下的状况？"></a>10、如何通过train loss与test loss分析网络当下的状况？</h3><p>train loss 不断下降，test loss不断下降，说明网络仍在学习;</p><p>train loss 不断下降，test loss趋于不变，说明网络过拟合;</p><p>train loss 趋于不变，test loss不断下降，说明数据集100%有问题;</p><p>train loss 趋于不变，test loss趋于不变，说明学习遇到瓶颈，需要减小学习率或批量数目;</p><p>train loss 不断上升，test loss不断上升，说明网络结构设计不当，训练超参数设置不当，数据集经过清洗等问题。</p>]]></content>
      
      
      <categories>
          
          <category> 深度学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pytorch </tag>
            
            <tag> 深度学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHM2012滚动轴承全寿命数据处理数据代码</title>
      <link href="/2023/03/23/phm2012-gun-dong-zhou-cheng-quan-shou-ming-shu-ju-chu-li-shu-ju-dai-ma/"/>
      <url>/2023/03/23/phm2012-gun-dong-zhou-cheng-quan-shou-ming-shu-ju-chu-li-shu-ju-dai-ma/</url>
      
        <content type="html"><![CDATA[<h1 id="PHM2012滚动轴承全寿命数据处理数据代码"><a href="#PHM2012滚动轴承全寿命数据处理数据代码" class="headerlink" title="PHM2012滚动轴承全寿命数据处理数据代码"></a>PHM2012滚动轴承全寿命数据处理数据代码</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># PHM2012滚动轴承全寿命数据</span><span class="token comment"># %% 1、工具包</span><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt<span class="token keyword">import</span> os<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> MinMaxScaler<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd<span class="token comment"># %% 2、读取文件</span><span class="token comment">#从文件夹里读取水平信号csv数据</span><span class="token keyword">def</span> <span class="token function">readfile_h</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>    files <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token comment">#输出该目录下所有文件名</span>    <span class="token comment">#将acc文件挑选出来</span>    files <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'acc_'</span> <span class="token punctuation">,</span> files<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#过滤（里面是规则）符合规则的留下</span>    <span class="token comment">#解决乱序问题，以第5位到倒数第4位之间的数字的大小排序</span>    files<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     rowdata_v <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    rowdata_h <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> files<span class="token punctuation">:</span>        info <span class="token operator">=</span> path<span class="token operator">+</span><span class="token string">"/"</span><span class="token operator">+</span><span class="token builtin">file</span>        <span class="token comment">#将csv文件里的数据转换成矩阵</span>        data <span class="token operator">=</span> np<span class="token punctuation">.</span>loadtxt<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span><span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> delimiter<span class="token operator">=</span><span class="token string">','</span><span class="token punctuation">,</span> skiprows<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>        rowdata_h <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>rowdata_h<span class="token punctuation">,</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        rowdata_v <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>rowdata_v<span class="token punctuation">,</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> rowdata_h<span class="token punctuation">,</span>rowdata_vpath<span class="token operator">=</span><span class="token string">'D:\\乔彬研究生期间文件\\data\\PHM 2012\\zhenghaiyang-phm-ieee-2012-data-challenge-dataset-master\\phm-ieee-2012-data-challenge-dataset\\'</span>savePath<span class="token operator">=</span><span class="token string">'D:\\乔彬研究生期间文件\\data\\PHM 2012\\zhenghaiyang-phm-ieee-2012-data-challenge-dataset-master\\中间数据\\'</span><span class="token comment">## 2803个csv文件</span>train1_1_h<span class="token punctuation">,</span>train1_1_v <span class="token operator">=</span> readfile_h<span class="token punctuation">(</span>path<span class="token operator">+</span><span class="token string">'Learning_set\\Bearing1_1'</span><span class="token punctuation">)</span><span class="token comment"># #871个csv文件</span>train1_2_h<span class="token punctuation">,</span>train1_2_v <span class="token operator">=</span> readfile_h<span class="token punctuation">(</span>path<span class="token operator">+</span><span class="token string">'Learning_set\\Bearing1_2'</span><span class="token punctuation">)</span>test1_3_h<span class="token punctuation">,</span>test1_3_v <span class="token operator">=</span> readfile_h<span class="token punctuation">(</span>path<span class="token operator">+</span><span class="token string">'Full_Test_Set\\Bearing1_3'</span><span class="token punctuation">)</span>test1_5_h<span class="token punctuation">,</span>test1_5_v <span class="token operator">=</span> readfile_h<span class="token punctuation">(</span>path<span class="token operator">+</span><span class="token string">'Full_Test_Set\\Bearing1_5'</span><span class="token punctuation">)</span>test1_6_h<span class="token punctuation">,</span>test1_6_v <span class="token operator">=</span> readfile_h<span class="token punctuation">(</span>path<span class="token operator">+</span><span class="token string">'Full_Test_Set\\Bearing1_6'</span><span class="token punctuation">)</span>test1_7_h<span class="token punctuation">,</span>test1_7_v <span class="token operator">=</span> readfile_h<span class="token punctuation">(</span>path<span class="token operator">+</span><span class="token string">'Full_Test_Set\\Bearing1_7'</span><span class="token punctuation">)</span><span class="token comment">#读取1_4的数据</span><span class="token keyword">def</span> <span class="token function">readfile_h4</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>    files <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>path<span class="token punctuation">)</span>    <span class="token comment">#将acc文件挑选出来</span>    files <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'acc_'</span> <span class="token punctuation">,</span> files<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># #解决乱序问题，以第5位到倒数第4位之间的数字的大小排序</span>    files<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    rowdata_v <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    rowdata_h <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> files<span class="token punctuation">:</span>        info <span class="token operator">=</span> path<span class="token operator">+</span><span class="token string">"\\"</span><span class="token operator">+</span><span class="token builtin">file</span>        <span class="token comment">#将csv文件里的数据转换成矩阵</span>        data <span class="token operator">=</span> np<span class="token punctuation">.</span>loadtxt<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span><span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> delimiter<span class="token operator">=</span><span class="token string">';'</span><span class="token punctuation">,</span>skiprows<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>        rowdata_h <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>rowdata_v<span class="token punctuation">,</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        rowdata_v <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>rowdata_h<span class="token punctuation">,</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> rowdata_h<span class="token punctuation">,</span>rowdata_vtest1_4_h<span class="token punctuation">,</span>test1_4_v <span class="token operator">=</span> readfile_h4<span class="token punctuation">(</span>path<span class="token operator">+</span><span class="token string">'Full_Test_Set\\Bearing1_4'</span><span class="token punctuation">)</span><span class="token comment"># %% 3、绘制图像</span><span class="token comment"># plot horizontal sign</span>plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>train1_1_h<span class="token punctuation">)</span>plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'horizontal1'</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>train1_2_h<span class="token punctuation">)</span>plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'horizontal2'</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>test1_3_h<span class="token punctuation">)</span>plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'horizontal3'</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>test1_4_h<span class="token punctuation">)</span>plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'horizontal4'</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>test1_5_h<span class="token punctuation">)</span>plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'horizontal5'</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>test1_6_h<span class="token punctuation">)</span>plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'horizontal6'</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>test1_7_h<span class="token punctuation">)</span>plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'horizontal7'</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span>savePath<span class="token operator">+</span><span class="token string">"horizontal.png"</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># plot vertical sign</span>plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>train1_1_v<span class="token punctuation">)</span>plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'vertical1'</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>train1_2_v<span class="token punctuation">)</span>plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'vertical2'</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>test1_3_v<span class="token punctuation">)</span>plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'vertical3'</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>test1_4_v<span class="token punctuation">)</span>plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'vertical4'</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>test1_5_v<span class="token punctuation">)</span>plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'vertical5'</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>test1_6_v<span class="token punctuation">)</span>plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'vertical6'</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>test1_7_v<span class="token punctuation">)</span>plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'vertical7'</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span>savePath<span class="token operator">+</span><span class="token string">"vertical.png"</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># %% 4、数据标准化处理</span><span class="token comment">#将数据标准化</span>mean1_1_h <span class="token operator">=</span>train1_1_h <span class="token operator">-</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>train1_1_h<span class="token punctuation">)</span>train1_h <span class="token operator">=</span> mean1_1_h<span class="token operator">/</span>np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>train1_1_h<span class="token punctuation">)</span>mean1_1_v <span class="token operator">=</span>train1_1_v <span class="token operator">-</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>train1_1_v<span class="token punctuation">)</span>train1_v <span class="token operator">=</span> mean1_1_v<span class="token operator">/</span>np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>train1_1_v<span class="token punctuation">)</span>mean1_2_h <span class="token operator">=</span>train1_2_h <span class="token operator">-</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>train1_2_h<span class="token punctuation">)</span>train2_h <span class="token operator">=</span>mean1_2_h<span class="token operator">/</span> np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>train1_2_h<span class="token punctuation">)</span>mean1_2_v <span class="token operator">=</span>train1_2_v <span class="token operator">-</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>train1_2_v<span class="token punctuation">)</span>train2_v <span class="token operator">=</span>mean1_2_v<span class="token operator">/</span> np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>train1_2_v<span class="token punctuation">)</span>mean1_3_h <span class="token operator">=</span>test1_3_h <span class="token operator">-</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>test1_3_h<span class="token punctuation">)</span>test3_h <span class="token operator">=</span> mean1_3_h<span class="token operator">/</span>np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>test1_3_h<span class="token punctuation">)</span>mean1_3_v <span class="token operator">=</span>test1_3_v <span class="token operator">-</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>test1_3_v<span class="token punctuation">)</span>test3_v <span class="token operator">=</span> mean1_3_v<span class="token operator">/</span>np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>test1_3_v<span class="token punctuation">)</span>mean1_4_h <span class="token operator">=</span>test1_4_h <span class="token operator">-</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>test1_4_h<span class="token punctuation">)</span>test4_h <span class="token operator">=</span> mean1_4_h<span class="token operator">/</span>np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>test1_4_h<span class="token punctuation">)</span>mean1_4_v <span class="token operator">=</span>test1_4_v <span class="token operator">-</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>test1_4_v<span class="token punctuation">)</span>test4_v <span class="token operator">=</span> mean1_4_v<span class="token operator">/</span>np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>test1_4_v<span class="token punctuation">)</span>mean1_5_h <span class="token operator">=</span>test1_5_h <span class="token operator">-</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>test1_5_h<span class="token punctuation">)</span>test5_h <span class="token operator">=</span> mean1_5_h <span class="token operator">/</span>np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>test1_5_h<span class="token punctuation">)</span>mean1_5_v <span class="token operator">=</span>test1_5_v <span class="token operator">-</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>test1_5_v<span class="token punctuation">)</span>test5_v <span class="token operator">=</span> mean1_5_v <span class="token operator">/</span>np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>test1_5_v<span class="token punctuation">)</span>mean1_6_h <span class="token operator">=</span>test1_6_h <span class="token operator">-</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>test1_6_h<span class="token punctuation">)</span>test6_h <span class="token operator">=</span> mean1_6_h <span class="token operator">/</span>np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>test1_6_h<span class="token punctuation">)</span>mean1_6_v <span class="token operator">=</span>test1_6_v <span class="token operator">-</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>test1_6_v<span class="token punctuation">)</span>test6_v <span class="token operator">=</span> mean1_6_v <span class="token operator">/</span>np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>test1_6_v<span class="token punctuation">)</span>mean1_7_h<span class="token operator">=</span>test1_7_h <span class="token operator">-</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>test1_7_h<span class="token punctuation">)</span>test7_h <span class="token operator">=</span> mean1_7_h <span class="token operator">/</span>np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>test1_7_h<span class="token punctuation">)</span>mean1_7_v<span class="token operator">=</span>test1_7_v <span class="token operator">-</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>test1_7_v<span class="token punctuation">)</span>test7_v <span class="token operator">=</span> mean1_7_v <span class="token operator">/</span>np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>test1_7_v<span class="token punctuation">)</span>xtr1_h<span class="token operator">=</span>train1_h<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2560</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>xtr2_h<span class="token operator">=</span>train2_h<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2560</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>xte3_h<span class="token operator">=</span> test3_h<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2560</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>xte4_h<span class="token operator">=</span> test4_h<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2560</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>xte5_h <span class="token operator">=</span> test5_h<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2560</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>xte6_h <span class="token operator">=</span> test6_h<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2560</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>xte7_h <span class="token operator">=</span> test7_h<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2560</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>xtr1_v<span class="token operator">=</span>train1_v<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2560</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>xtr2_v<span class="token operator">=</span>train2_v<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2560</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>xte3_v<span class="token operator">=</span> test3_v<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2560</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>xte4_v<span class="token operator">=</span> test4_v<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2560</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>xte5_v <span class="token operator">=</span> test5_v<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2560</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>xte6_v <span class="token operator">=</span> test6_v<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2560</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>xte7_v <span class="token operator">=</span> test7_v<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2560</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">#将垂直信号和水平信号拼接在一起</span>xtr1 <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>xtr1_v<span class="token punctuation">,</span>xtr1_h<span class="token punctuation">)</span><span class="token punctuation">)</span>xtr1 <span class="token operator">=</span> xtr1<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2560</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>xtr2 <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>xtr2_v<span class="token punctuation">,</span>xtr2_h<span class="token punctuation">)</span><span class="token punctuation">)</span>xtr2 <span class="token operator">=</span> xtr2<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2560</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>xte3 <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>xte3_v<span class="token punctuation">,</span>xte3_h<span class="token punctuation">)</span><span class="token punctuation">)</span>xte3 <span class="token operator">=</span> xte3<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2560</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>xte4 <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>xte4_v<span class="token punctuation">,</span>xte4_h<span class="token punctuation">)</span><span class="token punctuation">)</span>xte4 <span class="token operator">=</span> xte4<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2560</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>xte5 <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>xte5_v<span class="token punctuation">,</span>xte5_h<span class="token punctuation">)</span><span class="token punctuation">)</span>xte5 <span class="token operator">=</span> xte5<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2560</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>xte6 <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>xte6_v<span class="token punctuation">,</span>xte6_h<span class="token punctuation">)</span><span class="token punctuation">)</span>xte6 <span class="token operator">=</span> xte6<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2560</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>xte7 <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>xte7_v<span class="token punctuation">,</span>xte7_h<span class="token punctuation">)</span><span class="token punctuation">)</span>xte7<span class="token operator">=</span> xte7<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2560</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># %%5、制作标签</span><span class="token comment">#数据标签，剩余寿命</span>ytr1 <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>xtr1<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>ytr1 <span class="token operator">=</span> ytr1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>ytr2 <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>xtr2<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>ytr2 <span class="token operator">=</span> ytr2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>yte3 <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>xte3<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>yte3 <span class="token operator">=</span> yte3<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>yte4 <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>xte4<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>yte4 <span class="token operator">=</span> yte4<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>yte5 <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>xte5<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>yte5 <span class="token operator">=</span> yte5<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>yte6 <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>xte6<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>yte6 <span class="token operator">=</span> yte6<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>yte7 <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>xte7<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>yte7 <span class="token operator">=</span> yte7<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#将y标签归一化0——1，采用剩余寿命的百分比作为输出标签</span><span class="token comment">#使用剩余寿命的百分比作为标签值</span><span class="token comment">#不乘100为了使用rnn的sigmoid激活函数</span>min_max_scaler <span class="token operator">=</span> MinMaxScaler<span class="token punctuation">(</span><span class="token punctuation">)</span>ytr1 <span class="token operator">=</span> min_max_scaler<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>ytr1<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span>ytr2 <span class="token operator">=</span>  min_max_scaler<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>ytr2<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span>yte3 <span class="token operator">=</span>  min_max_scaler<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>yte3<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span>yte4 <span class="token operator">=</span>  min_max_scaler<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>yte4<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span>yte5 <span class="token operator">=</span>  min_max_scaler<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>yte5<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span>yte6 <span class="token operator">=</span>  min_max_scaler<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>yte6<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span>yte7 <span class="token operator">=</span>  min_max_scaler<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>yte7<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span class="token comment"># %% 6、数据分组，方便训练与测试</span>xtr_b1<span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>xtr2<span class="token punctuation">,</span>xte3<span class="token punctuation">,</span>xte4<span class="token punctuation">,</span>xte5<span class="token punctuation">,</span>xte6<span class="token punctuation">,</span>xte7<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># xtr = xtr.reshape(-1,2560,1)</span><span class="token keyword">print</span><span class="token punctuation">(</span>xtr_b1<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>ytr_b1 <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>ytr2<span class="token punctuation">,</span>yte3<span class="token punctuation">,</span>yte4<span class="token punctuation">,</span>yte5<span class="token punctuation">,</span>yte6<span class="token punctuation">,</span>yte7<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>ytr_b1<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token comment">#将1_2为测试集</span>xtr_b2<span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>xtr1<span class="token punctuation">,</span>xte3<span class="token punctuation">,</span>xte4<span class="token punctuation">,</span>xte5<span class="token punctuation">,</span>xte6<span class="token punctuation">,</span>xte7<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>xtr_b2<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>ytr_b2 <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>ytr1<span class="token punctuation">,</span>yte3<span class="token punctuation">,</span>yte4<span class="token punctuation">,</span>yte5<span class="token punctuation">,</span>yte6<span class="token punctuation">,</span>yte7<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>ytr_b2<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token comment">#将1_3为测试集</span>xtr_b3<span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>xtr1<span class="token punctuation">,</span>xtr2<span class="token punctuation">,</span>xte4<span class="token punctuation">,</span>xte5<span class="token punctuation">,</span>xte6<span class="token punctuation">,</span>xte7<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>xtr_b3<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>ytr_b3 <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>ytr1<span class="token punctuation">,</span>ytr2<span class="token punctuation">,</span>yte4<span class="token punctuation">,</span>yte5<span class="token punctuation">,</span>yte6<span class="token punctuation">,</span>yte7<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>ytr_b3<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token comment">#将1_4为测试集</span>xtr_b4<span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>xtr2<span class="token punctuation">,</span>xte3<span class="token punctuation">,</span>xte4<span class="token punctuation">,</span>xte5<span class="token punctuation">,</span>xte6<span class="token punctuation">,</span>xte7<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>xtr_b4<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>ytr_b4 <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>ytr2<span class="token punctuation">,</span>yte3<span class="token punctuation">,</span>yte4<span class="token punctuation">,</span>yte5<span class="token punctuation">,</span>yte6<span class="token punctuation">,</span>yte7<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>ytr_b4<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token comment">#将1_5为测试集</span>xtr_b5<span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>xtr1<span class="token punctuation">,</span>xtr2<span class="token punctuation">,</span>xte3<span class="token punctuation">,</span>xte4<span class="token punctuation">,</span>xte6<span class="token punctuation">,</span>xte7<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>xtr_b5<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>ytr_b5 <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>ytr1<span class="token punctuation">,</span>ytr2<span class="token punctuation">,</span>yte3<span class="token punctuation">,</span>yte4<span class="token punctuation">,</span>yte6<span class="token punctuation">,</span>yte7<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>ytr_b5<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token comment">#将1_6为测试集</span>xtr_b6<span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>xtr1<span class="token punctuation">,</span>xtr2<span class="token punctuation">,</span>xte3<span class="token punctuation">,</span>xte4<span class="token punctuation">,</span>xte5<span class="token punctuation">,</span>xte7<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>xtr_b6<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>ytr_b6 <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>ytr1<span class="token punctuation">,</span>ytr2<span class="token punctuation">,</span>yte3<span class="token punctuation">,</span>yte4<span class="token punctuation">,</span>yte5<span class="token punctuation">,</span>yte7<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>ytr_b6<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token comment">#将1_7为测试集其余做训练集</span>xtr_b7<span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>xtr1<span class="token punctuation">,</span>xtr2<span class="token punctuation">,</span>xte3<span class="token punctuation">,</span>xte4<span class="token punctuation">,</span>xte5<span class="token punctuation">,</span>xte6<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>xtr_b7<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>ytr_b7 <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>ytr1<span class="token punctuation">,</span>ytr2<span class="token punctuation">,</span>yte3<span class="token punctuation">,</span>yte4<span class="token punctuation">,</span>yte5<span class="token punctuation">,</span>yte6<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>ytr_b7<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token comment"># In[29]:</span>train_data_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>xtr_b1<span class="token punctuation">,</span>ytr_b1<span class="token punctuation">,</span>xtr1<span class="token punctuation">,</span>ytr1<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>xtr_b2<span class="token punctuation">,</span>ytr_b2<span class="token punctuation">,</span>xtr2<span class="token punctuation">,</span>ytr2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>xtr_b3<span class="token punctuation">,</span>ytr_b3<span class="token punctuation">,</span>xte3<span class="token punctuation">,</span>yte3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>xtr_b4<span class="token punctuation">,</span>ytr_b4<span class="token punctuation">,</span>xte4<span class="token punctuation">,</span>yte4<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>xtr_b5<span class="token punctuation">,</span>ytr_b5<span class="token punctuation">,</span>xte5<span class="token punctuation">,</span>yte5<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>xtr_b6<span class="token punctuation">,</span>ytr_b6<span class="token punctuation">,</span>xte6<span class="token punctuation">,</span>yte6<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>xtr_b7<span class="token punctuation">,</span>ytr_b7<span class="token punctuation">,</span>xte7<span class="token punctuation">,</span>yte7<span class="token punctuation">)</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 深度学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据分析 </tag>
            
            <tag> 数据挖掘 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2023年3月版联邦学习（fate）从主机安装到实现联邦学习</title>
      <link href="/2023/03/23/2023-nian-3-yue-ban-lian-bang-xue-xi-fate-cong-zhu-ji-an-zhuang-dao-shi-xian-lian-bang-xue-xi/"/>
      <url>/2023/03/23/2023-nian-3-yue-ban-lian-bang-xue-xi-fate-cong-zhu-ji-an-zhuang-dao-shi-xian-lian-bang-xue-xi/</url>
      
        <content type="html"><![CDATA[<h2 id="一、单机部署"><a href="#一、单机部署" class="headerlink" title="一、单机部署"></a>一、单机部署</h2><p>单机版提供3种部署方式，这里选择在<strong>主机中安装FATE</strong>（官方建议使用Docker镜像，但不熟悉Docker的人容易找不到FATE路径）</p><h3 id="1-1虚拟机配置"><a href="#1-1虚拟机配置" class="headerlink" title="1.1虚拟机配置"></a>1.1虚拟机配置</h3><p>使用<strong>虚拟机VMware</strong>进行实验，实验过程中随时<strong>拍摄快照</strong>，节约重装时间。</p><table><thead><tr><th>项目</th><th>Value</th></tr></thead><tbody><tr><td>虚拟机配置</td><td>内存4G + 硬盘150G</td></tr><tr><td>操作系统</td><td>centos 7</td></tr></tbody></table><h3 id="1-2安装python"><a href="#1-2安装python" class="headerlink" title="1.2安装python"></a>1.2安装python</h3><ul><li>这里不重复写了，请参考（Ubuntu安装python）（CentOS安装python）</li><li>或者安装anconda–linux版本</li></ul><h3 id="1-3端口检查"><a href="#1-3端口检查" class="headerlink" title="1.3端口检查"></a>1.3端口检查</h3><p>检查端口8080、9360、9380是否被占用</p><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">netstat -apln|grep 8080netstat -apln|grep 9360netstat -apln|grep 9380<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="1-4获取安装包，并解压"><a href="#1-4获取安装包，并解压" class="headerlink" title="1.4获取安装包，并解压"></a>1.4获取安装包，并解压</h3><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">sudo wget https://webank-ai-1251170195.cos.ap-guangzhou.myqcloud.com/fate/1.8.0/release/standalone_fate_install_1.8.0_release.tar.gz --no-check-certificatetar -xzvf standalone_fate_install_1.8.0_release.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="1-5安装"><a href="#1-5安装" class="headerlink" title="1.5安装"></a>1.5安装</h3><ul><li>进入解压后的目录并使用init.sh进行安装</li><li>该脚本将自动完成：<br>安装必要的操作系统依赖包<br>安装python36环境<br>安装pypi依赖包<br>安装jdk环境<br>配置FATE环境变量脚本<br>配置fateflow<br>配置fateboard<br>安装fate client<pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">cd standalone_fate_install_1.8.0_releasebash init.sh init<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><h3 id="1-6启动"><a href="#1-6启动" class="headerlink" title="1.6启动"></a>1.6启动</h3><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">bash init.sh statusbash init.sh start<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>加载环境变量</p><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">source bin/init_env.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="1-7测试"><a href="#1-7测试" class="headerlink" title="1.7测试"></a>1.7测试</h3><p>部署成功后，通过<strong>网页</strong>访问 <strong>localhost:8080</strong> 可以进入<strong>FATE Board</strong>页面，<strong>账号密码</strong>默认为：<strong>admin</strong></p><p>返回终端，开始测试</p><ul><li>Toy测试<pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">flow test toy -gid 10000 -hid 10000<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><ol><li><p>如果成功，屏幕显示类似下方的语句:<br>success to calculate secure_sum, it is 2000.0（我的显示的为1999.999999999）</p></li><li><p>之后进入<strong>FATE Broad</strong>，点击右上角<strong>JOBS</strong>，看到任务栏出现<strong>两项任务</strong>，并且状态为<strong>success</strong>则说明成功。</p></li></ol><ul><li>单元测试<pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">fate_test unittest federatedml --yes<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>如果成功，屏幕显示类似下方的语句:</li></ul><p>there are 0 failed test</p><h3 id="1-8安装FATE-Client、FATE-Test、FATE-Flow、jupyter-notebook"><a href="#1-8安装FATE-Client、FATE-Test、FATE-Flow、jupyter-notebook" class="headerlink" title="1.8安装FATE-Client、FATE-Test、FATE-Flow、jupyter notebook"></a>1.8安装FATE-Client、FATE-Test、FATE-Flow、jupyter notebook</h3><h4 id="1-8-1FATE-Client、FATE-Test"><a href="#1-8-1FATE-Client、FATE-Test" class="headerlink" title="1.8.1FATE-Client、FATE-Test"></a>1.8.1FATE-Client、FATE-Test</h4><ul><li>为方便使用FATE，安装便捷的<strong>交互工具FATE-Client</strong>以及<strong>测试工具FATE-Test</strong>.</li><li>请在环境内使用以下指令安装：<pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">python -m pip install fate-clientpython -m pip install fate-test<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><h4 id="1-8-2FATE-Flow"><a href="#1-8-2FATE-Flow" class="headerlink" title="1.8.2FATE-Flow"></a>1.8.2FATE-Flow</h4><ul><li>安装FATE-Client的过程会<strong>安装好FATE-Flow</strong>，这个工具是联邦学习端到端流水线的多方联邦任务安全调度平台，<strong>是执行任务的核心</strong></li><li>初始化<pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">flow init --ip 127.0.0.1 --port 9380<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><h4 id="1-8-3FATE中的Jupyter-Notebook"><a href="#1-8-3FATE中的Jupyter-Notebook" class="headerlink" title="1.8.3FATE中的Jupyter Notebook"></a>1.8.3FATE中的Jupyter Notebook</h4><p><a href="https://www.sohu.com/a/443726505_609552">参考：在Juypter Notebook中构建联邦学习任务</a></p><p>上边如果安装anaconda的则只需要执行下方第二步</p><ul><li>安装jupyter notebook<pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">pip install notebook fate-client<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>启动 <strong>Juypter Notebook 服务并监听 20000 端口</strong>，待服务启动完毕后则可以通过的方式 “IP：Port” 的方式访问 Notebook<pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">jupyter notebook --ip=0.0.0.0 --port=20000 --allow-root --debug --no-browser --NotebookApp.token= ''--NotebookApp.password= ''<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li>保持终端运行的状态，可以通过”IP：Port”的方式访问Juypter Notebook，此时notebook中的目录，就是Ubuntu中fate安装目录下的内容（按本教程的安装过程，fate根目录位于/home/fate/standalone_fate_master_1.8.0/）</li></ul><h2 id="二、用FATE从零实现横向逻辑回归"><a href="#二、用FATE从零实现横向逻辑回归" class="headerlink" title="二、用FATE从零实现横向逻辑回归"></a>二、用FATE从零实现横向逻辑回归</h2><p>在开始本章之前，请确保已经安装Python和FATE单机版</p><h3 id="2-1-数据集获取"><a href="#2-1-数据集获取" class="headerlink" title="2.1 数据集获取"></a>2.1 数据集获取</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>datasets <span class="token keyword">import</span> load_breast_cancer<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd breast_dataset <span class="token operator">=</span> load_breast_cancer<span class="token punctuation">(</span><span class="token punctuation">)</span>breast <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>breast_dataset<span class="token punctuation">.</span>data<span class="token punctuation">,</span> columns<span class="token operator">=</span>breast_dataset<span class="token punctuation">.</span>feature_names<span class="token punctuation">)</span>breast<span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">]</span> <span class="token operator">=</span> breast_dataset<span class="token punctuation">.</span>targetbreast<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-2-横向联邦数据集切分"><a href="#2-2-横向联邦数据集切分" class="headerlink" title="2.2 横向联邦数据集切分"></a>2.2 横向联邦数据集切分</h3><p>为了模拟横向联邦建模的场景，我们首先在本地将乳腺癌数据集切分为<strong>特征相同的横向联邦形式</strong>，当前的breast数据集有569条样本，我们将前面的<strong>469条作为训练样本</strong>，后面的<strong>100条</strong>作为评估<strong>测试样本</strong>。</p><ul><li>从469条训练样本中，选取前200条作为公司A的本地数据，保存为breast_1_train.csv，将剩余的269条数据作为公司B的本地数据，保存为breast_2_train.csv。</li><li>测试数据集可以不需要切分，两个参与方使用相同的一份测试数据即可，文件命名为breast_eval.csv。<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>datasets <span class="token keyword">import</span> load_breast_cancer<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd breast_dataset <span class="token operator">=</span> load_breast_cancer<span class="token punctuation">(</span><span class="token punctuation">)</span>breast <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>breast_dataset<span class="token punctuation">.</span>data<span class="token punctuation">,</span> columns<span class="token operator">=</span>breast_dataset<span class="token punctuation">.</span>feature_names<span class="token punctuation">)</span>breast <span class="token operator">=</span> <span class="token punctuation">(</span>breast<span class="token operator">-</span>breast<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>breast<span class="token punctuation">.</span>std<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> col_names <span class="token operator">=</span> breast<span class="token punctuation">.</span>columns<span class="token punctuation">.</span>values<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>columns <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">for</span> idx<span class="token punctuation">,</span> n <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>col_names<span class="token punctuation">)</span><span class="token punctuation">:</span>columns<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"x%d"</span><span class="token operator">%</span>idx breast <span class="token operator">=</span> breast<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>columns<span class="token operator">=</span>columns<span class="token punctuation">)</span>breast<span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">]</span> <span class="token operator">=</span> breast_dataset<span class="token punctuation">.</span>targetbreast<span class="token punctuation">[</span><span class="token string">'idx'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span>breast<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>idx <span class="token operator">=</span> breast<span class="token punctuation">[</span><span class="token string">'idx'</span><span class="token punctuation">]</span>breast<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>labels<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'idx'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> inplace <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>breast<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'idx'</span><span class="token punctuation">,</span> idx<span class="token punctuation">)</span>breast <span class="token operator">=</span> breast<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>frac<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>train <span class="token operator">=</span> breast<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">469</span><span class="token punctuation">]</span><span class="token builtin">eval</span> <span class="token operator">=</span> breast<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">469</span><span class="token punctuation">:</span><span class="token punctuation">]</span>breast_1_train <span class="token operator">=</span> train<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">200</span><span class="token punctuation">]</span>breast_1_train<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'breast_1_train.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> header<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>breast_2_train <span class="token operator">=</span> train<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">:</span><span class="token punctuation">]</span>breast_2_train<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'breast_2_train.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> header<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token builtin">eval</span><span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'breast_eval.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> header<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>运行完此程序之后会得到三个新的scv格式的数据集</li></ul><h3 id="2-3-上传数据-修改文件"><a href="#2-3-上传数据-修改文件" class="headerlink" title="2.3 上传数据-修改文件"></a>2.3 上传数据-修改文件</h3><p>在数据处理完之后，我们需要进行对<strong>数据进行上传</strong>。我们采用<strong>json格式进行上传</strong>。在FATE项目中有写好的上传json文件，在<strong>examples/dsl/v2/upload</strong>文件夹中，<strong>upload_conf.json</strong>此文件。在我的实验中，我将此文件复制到了我在FATE目录下新建的工作目录下，并对其进行了修改。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">{</span>    <span class="token string">"file"</span><span class="token punctuation">:</span> <span class="token string">"examples/data/breast_1_train.csv"</span><span class="token punctuation">,</span><span class="token comment">#指定数据文件</span>    <span class="token string">"head"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>    <span class="token string">"partition"</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>    <span class="token string">"work_mode"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token string">"table_name"</span><span class="token punctuation">:</span> <span class="token string">"homo_breast_1_train"</span><span class="token punctuation">,</span><span class="token comment">#指定DTable表名</span>    <span class="token string">"namespace"</span><span class="token punctuation">:</span> <span class="token string">"breast_1_train.csv"</span> <span class="token comment">#指定DTable表名的命名空间</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>“file”：需要改为自己的csv路径<br>“work_model”:0 表示为单机部署模式<br> “table_name”:需要改为自己的table名</p><h3 id="2-4-上传数据-跳转目录"><a href="#2-4-上传数据-跳转目录" class="headerlink" title="2.4 上传数据-跳转目录"></a>2.4 上传数据-跳转目录</h3><p> 为了方便后面的叙述统一，我们假设读者安装的FATE单机版本目录为：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">fate_dir<span class="token operator">=</span><span class="token operator">/</span>data<span class="token operator">/</span>projects<span class="token operator">/</span>fate<span class="token operator">-</span><span class="token number">1.8</span><span class="token number">.0</span><span class="token operator">-</span>experiment<span class="token operator">/</span>standalone<span class="token operator">-</span>fate<span class="token operator">-</span>master<span class="token operator">-</span><span class="token number">1.8</span><span class="token number">.0</span><span class="token operator">/</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p> 做完上述准备之后，我们需要进行以下操作</p><ol><li>跳转到standalone-fate-master-1.8.0目录下<pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">cd /data/projects/fate-1.8.0-experiment/standalone-fate-master-1.8.0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>加载环境变量<pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">source bin/init_env.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>在加载环境变量的基础上，在在当前目录下（$fate_dir/examples/federatedml-1.x-examples），在命令行中执行下面的命令，即可自动完成上传和格式转换：<pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">python /opt/standalone_fate_install_1.8.0/fateflow/python/fate_flow/fate_flow_client.py -f upload -c /opt/standalone_fate_install_1.8.0/fate/upload_data/upload_train1.json<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>或者<pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">flow data upload -c /opt/standalone_fate_install_1.8.0/fate/upload_data/upload_train1.json<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>出现如下界面说明成功：<br><img src="https://img-blog.csdnimg.cn/c8c9527e86424ab0845f77fa5fd7867d.png" alt="成功截图"></li></ol><h3 id="2-5-模型训练与评估"><a href="#2-5-模型训练与评估" class="headerlink" title="2.5 模型训练与评估"></a>2.5 模型训练与评估</h3><p>在<strong>数据完成上传</strong>之后，下面需要<strong>对训练任务进行配置</strong>，在FATE项目中已经给出了很多写好的配置，我们可以在此基础上进行修改就能直接用了。</p><h4 id="2-5-1-修改conf和dsl文件参数"><a href="#2-5-1-修改conf和dsl文件参数" class="headerlink" title="2.5.1 修改conf和dsl文件参数"></a>2.5.1 修改conf和dsl文件参数</h4><p>书中的版本与v1.8.0完全发生了改变，我们需要重新配置dsl和conf文件，且书中是<strong>使用训练集建模</strong>，<strong>训练集评估，与建模流程不符</strong>，我们改变书中流程，使用<strong>训练集建模</strong>，<strong>训练集与测试集分开进行评估</strong>。</p><p>在这里我使用的是<strong>homo_lr_train_conf.json和homo_lr_train_dsl.json</strong>，这两个文件在<strong>examples/dsl/v2/homo_logistic_regression</strong>目录中能够找到。接下来我们需要对其进行修改</p><ol><li><strong>homo_lr_train_conf.json</strong>：用来设置各个组件的参数，比如输入模块的数据表名，算法模块的学习率，batch大小，迭代次数。<br>一般使用默认值即可，需要修改的地方包括以下几处。</li></ol><ul><li><strong>role字段</strong>：该字段包括guest和host分别对应两个参与方。需要修改三个参数。首先是name和namespace，代表训练数据的DTable表名和命名空间；此外，label_name表示的是标签列对应的属性名，<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">{</span>            <span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>            <span class="token string">"host"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                <span class="token string">"0"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                    <span class="token string">"reader_0"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                        <span class="token string">"table"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                            <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"mnist_host_train"</span><span class="token punctuation">,</span>  <span class="token comment">#注意此处换成对应的表名，在复制此代码时需要删除此注释</span>                            <span class="token string">"namespace"</span><span class="token punctuation">:</span> <span class="token string">"experiment"</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span>                    <span class="token string">"evaluation_0"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                        <span class="token string">"need_run"</span><span class="token punctuation">:</span> false                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token string">"guest"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                <span class="token string">"0"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                    <span class="token string">"reader_0"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                        <span class="token string">"table"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                            <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"mnist_guest_train"</span><span class="token punctuation">,</span><span class="token comment">#注意此处换成对应的表名，在复制此代码时需要删除此注释</span>                            <span class="token string">"namespace"</span><span class="token punctuation">:</span> <span class="token string">"experiment"</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><strong>component_parameters</strong>字段：用来设置模型训练的超参数信息，包括优化函数与学习率，迭代次数<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token string">"component_parameters"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>        <span class="token string">"common"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>            <span class="token string">"data_transform_0"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                <span class="token string">"with_label"</span><span class="token punctuation">:</span> true<span class="token punctuation">,</span>                <span class="token string">"output_format"</span><span class="token punctuation">:</span> <span class="token string">"dense"</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token string">"homo_lr_0"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                <span class="token string">"penalty"</span><span class="token punctuation">:</span> <span class="token string">"L2"</span><span class="token punctuation">,</span>                <span class="token string">"tol"</span><span class="token punctuation">:</span> <span class="token number">1e-05</span><span class="token punctuation">,</span>                <span class="token string">"alpha"</span><span class="token punctuation">:</span> <span class="token number">0.01</span><span class="token punctuation">,</span>                <span class="token string">"optimizer"</span><span class="token punctuation">:</span> <span class="token string">"sgd"</span><span class="token punctuation">,</span>                <span class="token string">"batch_size"</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>                <span class="token string">"learning_rate"</span><span class="token punctuation">:</span> <span class="token number">0.15</span><span class="token punctuation">,</span>                <span class="token string">"init_param"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                    <span class="token string">"init_method"</span><span class="token punctuation">:</span> <span class="token string">"zeros"</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token string">"max_iter"</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>                <span class="token string">"early_stop"</span><span class="token punctuation">:</span> <span class="token string">"diff"</span><span class="token punctuation">,</span>                <span class="token string">"encrypt_param"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                    <span class="token string">"method"</span><span class="token punctuation">:</span> null                <span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token string">"cv_param"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                    <span class="token string">"n_splits"</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>                    <span class="token string">"shuffle"</span><span class="token punctuation">:</span> true<span class="token punctuation">,</span>                    <span class="token string">"random_seed"</span><span class="token punctuation">:</span> <span class="token number">33</span><span class="token punctuation">,</span>                    <span class="token string">"need_cv"</span><span class="token punctuation">:</span> false                <span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token string">"decay"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>                <span class="token string">"decay_sqrt"</span><span class="token punctuation">:</span> true            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token string">"evaluation_0"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                <span class="token string">"eval_type"</span><span class="token punctuation">:</span> <span class="token string">"binary"</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><ol start="2"><li>homo_lr_train_dsl.json：用来描述任务模块，将任务模块以有向无环图的形式组合在一起。以下组件模块构成了最基本的横向联邦模型流水线。</li></ol><ul><li>homo_lr_0：横向逻辑回归组件</li><li>evaluation_0:模型评估组件，如果没有提供测试数据集，将自动使用训练数据进行模型评估。</li></ul><h4 id="2-5-2-修改结束之后，在命令行输入以下命令（submit-job）执行模型训练"><a href="#2-5-2-修改结束之后，在命令行输入以下命令（submit-job）执行模型训练" class="headerlink" title="2.5.2 修改结束之后，在命令行输入以下命令（submit_ job）执行模型训练"></a>2.5.2 修改结束之后，在命令行输入以下命令（submit_ job）执行模型训练</h4><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">python /opt/standalone_fate_install_1.8.0/fateflow/python/fate_flow/fate_flow_client.py -f submit_job -d /opt/standalone_fate_install_1.8.0/fate/dsl_conf/homo_lr_train_dsl.json -c /opt/standalone_fate_install_1.8.0/fate/dsl_conf/homo_lr_train_conf.json<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>或者</p><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">flow job submit -d /opt/standalone_fate_install_1.8.0/fate/dsl_conf/homo_lr_train_dsl.json -c /opt/standalone_fate_install_1.8.0/fate/dsl_conf/homo_lr_train_conf.json<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>成功后显示如图<br><img src="https://img-blog.csdnimg.cn/8e5a0116c1b1438c994b60d659e614da.png" alt="截图"><br>通过箭头所指地址我们可以在浏览器中查看任务进度和信息<br><img src="https://img-blog.csdnimg.cn/74dffdbcb283421488ef873b70e7b73e.png" alt="截图成功"></p>]]></content>
      
      
      <categories>
          
          <category> 深度学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 联邦学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IEEE PHM 2012挑战赛的实验数据集</title>
      <link href="/2023/03/23/ieee-phm-2012-tiao-zhan-sai-de-shi-yan-shu-ju-ji/"/>
      <url>/2023/03/23/ieee-phm-2012-tiao-zhan-sai-de-shi-yan-shu-ju-ji/</url>
      
        <content type="html"><![CDATA[<p>轴承退化的表征基于传感器的两种数据类型：振动和温度；</p><h2 id="1-轴承退化：运行至故障试验"><a href="#1-轴承退化：运行至故障试验" class="headerlink" title="1. 轴承退化：运行至故障试验"></a>1. 轴承退化：运行至故障试验</h2><h2 id="2-挑战数据集"><a href="#2-挑战数据集" class="headerlink" title="2.挑战数据集"></a>2.挑战数据集</h2><p>三种不同的工况如下，具体训练集和测试集特征如下所示</p><p>①：负载4000N，转速1800rpm;</p><p>②：负载4200N，转速1650rpm;</p><p>③：负载5000N，转速1500rpm;</p><p><img src="https://img-blog.csdnimg.cn/ed61978683a14397a93d965df89d1872.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP55m95a2m5Lmg6K6w5b2V,size_16,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p><h2 id="3-数据集介绍："><a href="#3-数据集介绍：" class="headerlink" title="3.数据集介绍："></a>3.数据集介绍：</h2><p>振动文件为acc_xxxxx.csv，温度文件为temp_xxxxx.csv</p><p><strong>振动信号(水平方向和垂直方向)：</strong></p><p>1.采样频率：25.6KHz；<br>2.采集设置：10秒采集一次，一次采集0.1s，即一次采集2560个点；示意图如下 温度信号 采样频率：10Hz;采集设置：每分钟采集600点</p><p><strong>每个文件的列标签：</strong></p><p><img src="https://img-blog.csdnimg.cn/8aaa7b33a37449288201e4b1fcd4dee8.png" alt="在这里插入图片描述"></p><p><strong>温度信号：</strong></p><p>1.采样频率：10Hz;</p><p>2.采集设置：每分钟采集600点；</p><p><strong>注意：该数据为比赛数据，所有存放数据的文件夹有三个，一个是训练数据(Learning_set)，一个是比赛时采用的截断数据(Test_set)，一个是全寿命数据(Full_Test_set)，这个Full_Test_set是Test_set的完整版。</strong></p>]]></content>
      
      
      <categories>
          
          <category> 深度学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据分析 </tag>
            
            <tag> 数据挖掘 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux_实操篇</title>
      <link href="/2023/03/23/linux-shi-cao-pian/"/>
      <url>/2023/03/23/linux-shi-cao-pian/</url>
      
        <content type="html"><![CDATA[<p>@[toc](linux_实操篇]</p><h2 id="六、Linux远程登录"><a href="#六、Linux远程登录" class="headerlink" title="六、Linux远程登录"></a>六、Linux远程登录</h2><h3 id="6-1为什么linux要远程登录"><a href="#6-1为什么linux要远程登录" class="headerlink" title="6.1为什么linux要远程登录"></a>6.1为什么linux要远程登录</h3><p><img src="https://img-blog.csdnimg.cn/6c33daa9ad544defb877426e469847a2.png" alt="为什么linux要远程登录"><br><img src="https://img-blog.csdnimg.cn/e58eea25cd3943a0aaebe736b4f4c732.png" alt="登录客户端"></p><h3 id="6-2远程登录linux-Xshell7"><a href="#6-2远程登录linux-Xshell7" class="headerlink" title="6.2远程登录linux-Xshell7"></a>6.2远程登录linux-Xshell7</h3><p><img src="https://img-blog.csdnimg.cn/148d98df3a834b4d81495a990e72c058.png" alt="远程登录linux"><br>下载地址：<br> <a href="https://www.xshell.com/zh/free-for-home-school/">https://www.xshell.com/zh/free-for-home-school/</a><br><img src="https://img-blog.csdnimg.cn/d5f6bb2ca800433a85e0ba5af83d9ff1.png" alt="点击xshell新建"></p><h3 id="6-3远程上传下载文件-Xftp7"><a href="#6-3远程上传下载文件-Xftp7" class="headerlink" title="6.3远程上传下载文件-Xftp7"></a>6.3远程上传下载文件-Xftp7</h3><p><img src="https://img-blog.csdnimg.cn/1da5dbfa5a3248a1818b7f24a17707e9.png" alt="远程上传下载文件"><br><img src="https://img-blog.csdnimg.cn/08e901ea88ba4dab9972d9f537bb9fba.png" alt="点击Xftp新建"></p><h4 id="6-3-1解决中文乱码"><a href="#6-3-1解决中文乱码" class="headerlink" title="6.3.1解决中文乱码"></a>6.3.1解决中文乱码</h4><p>点击属性——&gt;选项——&gt;编码方式改变</p><h2 id="七、vi与vim编辑器"><a href="#七、vi与vim编辑器" class="headerlink" title="七、vi与vim编辑器"></a>七、vi与vim编辑器</h2><h3 id="7-1vim快速入门"><a href="#7-1vim快速入门" class="headerlink" title="7.1vim快速入门"></a>7.1vim快速入门</h3><h4 id="7-1-1基本介绍"><a href="#7-1-1基本介绍" class="headerlink" title="7.1.1基本介绍"></a>7.1.1基本介绍</h4><p><img src="https://img-blog.csdnimg.cn/893e2b71f3b54c8da64569d69d21f4e2.png" alt="vi与vim基本介绍"></p><h4 id="7-1-2-vi与vim常用三种模式"><a href="#7-1-2-vi与vim常用三种模式" class="headerlink" title="7.1.2 vi与vim常用三种模式"></a>7.1.2 vi与vim常用三种模式</h4><p><img src="https://img-blog.csdnimg.cn/2e4b0cbf33724e0f81ea8f4a822f4389.png" alt="vi与vim常用三种模式"></p><h4 id="7-1-3vi和vim基本使用"><a href="#7-1-3vi和vim基本使用" class="headerlink" title="7.1.3vi和vim基本使用"></a>7.1.3vi和vim基本使用</h4><p><img src="https://img-blog.csdnimg.cn/82ee46be844646fc8c30571bb5caeebb.png" alt="在这里插入图片描述"></p><h3 id="7-2vi和vim快捷键"><a href="#7-2vi和vim快捷键" class="headerlink" title="7.2vi和vim快捷键"></a>7.2vi和vim快捷键</h3><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">正常模式下: 1.复制：5yy 2.粘贴：p 3.删除：5dd 4.撤销：u 5.到达文件中某一行：1G命令行模式下： 1.查找某个单词：/关键字,回车 2.查找下一个：n 3.设置行号：set nu 4.取消行号：set nonu<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="7-2-1-快捷键练习"><a href="#7-2-1-快捷键练习" class="headerlink" title="7.2.1 快捷键练习"></a>7.2.1 快捷键练习</h4><p><img src="https://img-blog.csdnimg.cn/11b5864bda644148badb62e482a63cda.png" alt="各种模式切换"></p><p>1、使用xshell远程登录<br>2、登陆后在终端输入vim Hello.java——&gt;进入正常模式<br>3、使用<strong>i</strong>——&gt;进入编辑模式，写入代码<br>4、Esc退出编辑模式<br>5、使用:——&gt;进入命令行模式<br>6、使用wq（写入并退出）<br>i<br>正常模式下</p><ul><li>拷贝当前行——yy<br>拷贝当前行向下5行 ——5yy<br>粘贴——p</li><li>删除当前行——dd<br>删除当前行向下5行——5dd</li><li>编辑/etc/profile 文件<br> 到达该文档的最末行——G<br> 到达该文档的第20行——20+G<br> 到达该文档的最首行——gg</li><li>撤销当前动作——u</li></ul><p>命令行模式下——:</p><ul><li>查找某个单词——/关键字，回车查找。<br> 查找下一个——输入n。</li><li>设置文件行号——set nu<br> 取消文件行号——set nonu</li></ul><h2 id="八、linux的开机、重启与用户注销"><a href="#八、linux的开机、重启与用户注销" class="headerlink" title="八、linux的开机、重启与用户注销"></a>八、linux的开机、重启与用户注销</h2><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">关机：shutdown -h nowshutdown -h 1halt重启：shutdown -r nowreboot<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="8-1关机与重启的命令"><a href="#8-1关机与重启的命令" class="headerlink" title="8.1关机与重启的命令"></a>8.1关机与重启的命令</h3><p><img src="https://img-blog.csdnimg.cn/9f74ecbb5f164bf8b76fa8801c2f05c0.png" alt="关机与重启"><br><strong>细节</strong>：不管重启还是关机，首先运行sync命令，把内存中的数据写入到磁盘；</p><ul><li><strong>关机</strong><br> shutdown -h now ——立即关机<br> shutdown -h 1——1分钟后关机（shutdown)<br> halt——关机(<strong>最高权限者关机才能用</strong>）</li><li><strong>重启</strong><br> shutdown -r now——立即重启<br> reboot——立即重启</li><li>撤销关机/重启命令——shutdown -c</li><li>把内存数据同步到磁盘——sync</li></ul><h3 id="8-2用户登录与注销"><a href="#8-2用户登录与注销" class="headerlink" title="8.2用户登录与注销"></a>8.2用户登录与注销</h3><p>  <img src="https://img-blog.csdnimg.cn/31bad7091beb44a1b2885dbb255180e3.png" alt="用户登录与注销"></p><h2 id="九、用户管理"><a href="#九、用户管理" class="headerlink" title="九、用户管理"></a>九、用户管理</h2><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">用户添加：useradd [-d 指定目录] [-g 用户组] 用户名指定密码：passwd 用户名删除用户: userdel [-r] 用户名查询用户信息： id 用户名切换用户：su - 用户名注销用户：logout查看当前登录用户信息：whoami用户组添加：groupadd 组名用户组删除：groupdel 组名 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="9-1用户"><a href="#9-1用户" class="headerlink" title="9.1用户"></a>9.1用户</h3><ul><li>用户添加<br> useradd 用户名——默认用户的家目录在/home/用户名<br> useradd -d 指定目录 新的用户名<br> useradd -g 用户组 用户名</li><li>指定密码<br>passwd  用户名</li><li>删除用户<br>userdel 用户名——保留家目录<br>userdel -r 用户名——用户及家目录均被删除</li><li>查询用户信息指令<br>id 用户名</li><li>切换用户<br>su - 切换用户名<br>注：权限高——权限低（不需要密码），反之需要<br> 当返回原来用户时，使用logout（注销）指令</li><li>查看当前登录用户信息<br> whoami</li><li>修改用户的组<br> usermod -g 用户组 用户名</li></ul><h3 id="9-2用户组"><a href="#9-2用户组" class="headerlink" title="9.2用户组"></a>9.2用户组</h3><p> 系统可以对有共同权限的多个用户进行管理</p><ul><li>新增组<br> groupadd 组名</li><li>删除组<br> groupdel 组名</li></ul><h3 id="9-3-用户和组相关文件"><a href="#9-3-用户和组相关文件" class="headerlink" title="9.3 用户和组相关文件"></a>9.3 用户和组相关文件</h3><ul><li>/etc/passwd 文件（用户配置文件）<br> 每行含义：用户名:口令:用户标识号:组标识号:注释性描述:主目录:登录Shell</li><li>/etc/shadow 文件（口令配置文件）<br> 每行含义：登录名:加密口令:最后一次修改时间:最小时间间隔:最大时间间隔:警告时间:不活动时间：失效时间：标志</li><li>/etc/group 文件（组配置文件）<br> 每行含义：用户名:口令:组标识号:组内用户列表</li></ul><h2 id="十、运行级别"><a href="#十、运行级别" class="headerlink" title="十、运行级别"></a>十、运行级别</h2><h3 id="10-1基本介绍"><a href="#10-1基本介绍" class="headerlink" title="10.1基本介绍"></a>10.1基本介绍</h3><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">init 0-6 切换运行级别设置默认运行级别为3:systemctl set-default multi-user.target设置默认运行级别为5:systemctl set-default graphical.target<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>运行级别说明：<br>0：关机<br>1：单用户（找回丢失密码）<br>2：多用户状态没有网络服务<br>3：多用户状态有网络服务<br>4：系统未使用保留给用户<br>5：图形界面<br>6：系统重启</li><li>切换运行级别——init 级别号（3）</li><li>查看当前运行级别——systemctl get-default</li><li>设置默认运行级别为3——systemctl set-default multi-user.target</li><li>设置默认运行级别为5——systemctl set-default graphical.target</li></ul><h3 id="10-2找回root密码"><a href="#10-2找回root密码" class="headerlink" title="10.2找回root密码"></a>10.2找回root密码</h3><ol><li>启动系统，在进入开机界面，在界面中按“e”进入编辑界面</li><li>进入编辑界面，使用光标，找到以“Linux16开头的行”，在行末输入：init=/bin/sh(进入单用户模式）</li><li>输入完成后，按快捷键”ctrl+x”,进入单用户模式</li><li>在光标闪烁位置输入mount -o remount,rw /</li><li>在新的一行最后输入：passwd,回车确认</li><li>输入两次新的密码</li><li>接着，在鼠标闪烁位置输入： touch /.autorelabel 回车确认</li><li>最后在光标闪烁位置输入 exec  (空格)/sbin/init  回车确认</li><li>直到系统自动重启</li></ol><h2 id="十一、帮助指令"><a href="#十一、帮助指令" class="headerlink" title="十一、帮助指令"></a>十一、帮助指令</h2><ol><li>man——获得帮助信息<br>基本语法：man [命令或配置文件]<br>案例：查看ls命令的帮助信息<br>注：在linux下，隐藏文件是以.开头，选项可以组合使用，比如：ls -al;ls -al root</li><li>help——获得shell内置命令帮助信息<br>基本语法：help命令</li><li>百度——菜鸟教程</li></ol><h2 id="十二、文件目录命令"><a href="#十二、文件目录命令" class="headerlink" title="十二、文件目录命令"></a>十二、文件目录命令</h2><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">pwd——显示当前工作目录的绝对路径ls -al——显示当前目录下所有文件和目录cd cd..——切换目录mkdir -p——创建目录rmdir——删除空目录touch——创建新文件\cp -r——复制文件或文件夹rm -rf——移除文件或文件夹mv——移动文件或重命名<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li><strong>显示当前工作目录的绝对路径</strong><br>语法：pwd</li><li><strong>显示当前目录下所有文件和目录</strong><br>语法：ls [选项]  [目录和文件]<br>选项:<br> -a 显示当前所有文件（包含隐藏文件夹）<br> -l 以列表方式显示信息</li><li><strong>切换目录</strong><br> 语法：cd [参数]<br> 参数：<br> cd 或者cd ~   ——回到自己的家目录<br> cd .. ——返回上一级目录</li><li><strong>创建目录</strong><br> 语法：mkdir [选项] [目录]<br> 选项：-p 创建多级目录<br> 案例：<br> 创建一个目录 mkdir /home/dog<br> 创建多级目录 mkdir -p /home/animal/dog</li><li><strong>删除空目录</strong><br> 语法：rmdir [选项] [目录]<br> 案例：rmdir /home/animal</li><li><strong>创建空文件夹</strong><br> 语法：touch 文件名称</li><li><strong>拷贝文件到指定目录</strong><br> 语法：cp [选项] source dest<br> 常用选项：<br> -r : 递归复制整个文件夹<br> 案例：<br> 拷贝文件：cp /home/hello.txt /root<br> 拷贝整个文件夹：cp -r /home/tom /root<br> 强制覆盖不提示：\cp -r /home/tom /root</li><li><strong>移除文件或目录</strong><br> 语法：rm [选项] 文件、目录路径<br> 常用选项：<br> -r : 递归删除整个文件夹<br> -f : 强制删除不提示<br> 案例：<br> 删除文件——rm /home/hello.txt<br> 删除文件夹——rm -rf  /home/tom</li><li><strong>移动文件与目录或重命名</strong><br> 语法：<br> mv oldFile NewFile(重命名）<br> mv /temp/moveFile /targetFolder (移动文件）</li></ol>]]></content>
      
      
      <categories>
          
          <category> 嵌入式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> vim </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git 版本管理</title>
      <link href="/2023/03/23/git-ban-ben-guan-li/"/>
      <url>/2023/03/23/git-ban-ben-guan-li/</url>
      
        <content type="html"><![CDATA[<h2 id="一、下载"><a href="#一、下载" class="headerlink" title="一、下载"></a>一、下载</h2><p>国内镜像源下载地址</p><p><a href="https://npm.taobao.org/mirrors/git-for-windows/">https://npm.taobao.org/mirrors/git-for-windows/</a></p><p>git官网下载</p><p><a href="https://git-scm.com/downloads">https://git-scm.com/downloads</a></p><h2 id="二、安装"><a href="#二、安装" class="headerlink" title="二、安装"></a>二、安装</h2><p><strong>推荐使用默认安装参数, 然后一路<code>下一步</code>到底</strong>. 安装好之后, 在你的所有程序中, 将会出现 git 的文件夹, 而且里面会有一个程序叫做 <code>git bash</code>. 这个 <code>git bash</code> 是 git 在 Windows 上为了方便使用所设置的一个 Unix 的环境. 如果你是 Windows 用户, 之后的教程你也能用这个来学习使用 git.</p><h2 id="三、创建-x2F-修改版本库"><a href="#三、创建-x2F-修改版本库" class="headerlink" title="三、创建/修改版本库"></a>三、创建/修改版本库</h2><h3 id="3-1创建版本库（init）"><a href="#3-1创建版本库（init）" class="headerlink" title="3.1创建版本库（init）"></a>3.1创建版本库（init）</h3><h4 id="3-1-1-确定管理文件夹"><a href="#3-1-1-确定管理文件夹" class="headerlink" title="3.1.1 确定管理文件夹"></a>3.1.1 确定管理文件夹</h4><p>首先确定对哪个文件夹里的文件进行管理，比如我选的D:/xx研究生文件集合/code 文件；然后打开git bush，把目录调至文件夹<code>code</code>,相关代码</p><pre class="line-numbers language-git" data-language="git"><code class="language-git">$ cd D:/xx研究生文件集合/code 文件<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="3-1-2-创建管理员用户名和email"><a href="#3-1-2-创建管理员用户名和email" class="headerlink" title="3.1.2 创建管理员用户名和email"></a>3.1.2 创建管理员用户名和email</h4><p>为了更好使用git，同时记录每一个施加修改的人，故在git中添加用户名<code>user.name</code>和用户email<code>user.email</code></p><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token command">$ git config<span class="token parameter"> --global</span> user.name </span><span class="token string">"B Q"</span><span class="token command">$ git config<span class="token parameter"> --global</span> user.email </span><span class="token string">"XX@qq.com"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="3-1-3-初始化git"><a href="#3-1-3-初始化git" class="headerlink" title="3.1.3 初始化git"></a>3.1.3 初始化git</h4><p>在文件夹中初始化 git 的管理文件库</p><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token command">$ git init</span><span class="token comment"># Initialized empty Git repository in D:/xx研究生文件集合/code/.git/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="3-2-添加文件管理（add）"><a href="#3-2-添加文件管理（add）" class="headerlink" title="3.2 添加文件管理（add）"></a>3.2 添加文件管理（add）</h3><p><img src="https://img-blog.csdnimg.cn/137d7ac8556548e5aab4a6490ac9e9ee.png" alt="在这里插入图片描述"></p><h4 id="3-2-1-查看所有文件"><a href="#3-2-1-查看所有文件" class="headerlink" title="3.2.1 查看所有文件"></a>3.2.1 查看所有文件</h4><p>执行 <code>$ ls</code> 就能看到文件夹中的所有文件，git 创建的管理库文件 <code>.git</code> 是被隐藏起来的需执行<code>$ ls -a</code></p><pre class="line-numbers language-git" data-language="git"><code class="language-git">$ ls -a<span class="token comment"># . ..  .git</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="3-2-2-创建新的文件"><a href="#3-2-2-创建新的文件" class="headerlink" title="3.2.2 创建新的文件"></a>3.2.2 创建新的文件</h4><p>法一：直接在管理库文件夹下右击创建文件</p><p>法二：用代码<code>touch</code>，如下：</p><pre class="line-numbers language-git" data-language="git"><code class="language-git">$ touch 1.py<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="3-2-3-查看版本库状态（status）"><a href="#3-2-3-查看版本库状态（status）" class="headerlink" title="3.2.3 查看版本库状态（status）"></a>3.2.3 查看版本库状态（<code>status</code>）</h4><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token command">$ git status</span><span class="token comment"># 1.py        # 1.py 文件没有被加入版本库 (unstaged)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="3-2-4-将文件放入add版本库中，即（untracked–staged）"><a href="#3-2-4-将文件放入add版本库中，即（untracked–staged）" class="headerlink" title="3.2.4 将文件放入add版本库中，即（untracked–staged）"></a>3.2.4 将文件放入<code>add</code>版本库中，即（untracked–staged）</h4><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token command">$ git add 1.py</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>若想<strong>一次性添加文件夹中所有未被添加的文件</strong>, 可以使用这个:</p><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token command">$ git add .</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="3-2-5-提交改变（commit）即（staged–unmodified）"><a href="#3-2-5-提交改变（commit）即（staged–unmodified）" class="headerlink" title="3.2.5 提交改变（commit）即（staged–unmodified）"></a>3.2.5 提交改变（<code>commit</code>）即（staged–unmodified）</h4><p>添加好了 <code>1.py</code> 文件, 最后一步就是提交这次的改变, 并在 <code>-m</code> 自定义这次版本名:</p><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token command">$ git commit<span class="token parameter"> -m</span> </span><span class="token string">"create 1"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="3-3-查看记录修改（log-amp-diff）"><a href="#3-3-查看记录修改（log-amp-diff）" class="headerlink" title="3.3 查看记录修改（log&amp;diff）"></a>3.3 查看记录修改（<code>log&amp;diff</code>）</h3><h4 id="3-3-1-文件被提交-看修改记录用git-log"><a href="#3-3-1-文件被提交-看修改记录用git-log" class="headerlink" title="3.3.1 文件被提交 看修改记录用git log"></a>3.3.1 文件被提交 看修改记录用<code>git log</code></h4><p>输入<code>git log</code>就可以看到上次更改的信息（修改的时间及修改的管理员）</p><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token command">$ git add 1.py</span><span class="token command">$ git commit<span class="token parameter"> -m</span> </span><span class="token string">"change 1"</span><span class="token command">$ git log</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="3-3-2-查看没提交的信息-git-status"><a href="#3-3-2-查看没提交的信息-git-status" class="headerlink" title="3.3.2 查看没提交的信息( git status)"></a>3.3.2 查看没提交的信息(<code> git status</code>)</h4><p>如果我们对<code>1.py</code>文件进行一次修改, 添加这行代码:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">a <span class="token operator">=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后我们就能在 <code>status</code> 中看到修改还没被提交的信息了.</p><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token command">$ git status</span><span class="token comment"># 输出</span>On branch masterChanges not staged for commit:  (use <span class="token string">"git add &lt;file&gt;..."</span> to update what will be committed)  (use <span class="token string">"git checkout -- &lt;file&gt;..."</span> to discard changes in working directory)    modified:   1.py    # 这里显示有一个修改还没被提交no changes added to commit (use <span class="token string">"git add"</span> and/or <span class="token string">"git commit -a"</span>)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-3-3-文件未提交-查看记录修改（git-diff"><a href="#3-3-3-文件未提交-查看记录修改（git-diff" class="headerlink" title="3.3.3 文件未提交 查看记录修改（git diff)"></a>3.3.3 文件未提交 查看记录修改（<code>git diff</code>)</h3><p><strong>三种情况的的diff形式</strong></p><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token comment"># 对比三种不同 diff 形式</span><span class="token command">$ git diff          # unstaged</span><span class="token coord">@@ -1,2 +1,3 @@</span> a = 2  # 注: 前面没有 + b = 1  # 注: 前面没有 +<span class="token inserted">+c = b  # 还没 add 去 stage (unstaged)</span><span class="token deleted">-----------------------</span><span class="token command">$ git add .   # add 全部修改文件</span><span class="token command">$ git diff<span class="token parameter"> --cached</span> # staged</span><span class="token coord">@@ -1 +1,2 @@</span><span class="token deleted">-a = 1  # 已 staged</span><span class="token inserted">+a = 2  # 已 staged</span><span class="token inserted">+b = 1  # 已 staged</span><span class="token deleted">-----------------------</span><span class="token command">$ git diff HEAD     # staged &amp; unstaged</span><span class="token coord">@@ -1 +1,3 @@</span><span class="token deleted">-a = 1  # 已 staged</span><span class="token inserted">+a = 2  # 已 staged</span><span class="token inserted">+b = 1  # 已 staged</span><span class="token inserted">+c = b  # 还没 add 去 stage (unstaged)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="四、版本转换"><a href="#四、版本转换" class="headerlink" title="四、版本转换"></a>四、版本转换</h2><h3 id="4-1针对全部文件的版本转换（git-reset）"><a href="#4-1针对全部文件的版本转换（git-reset）" class="headerlink" title="4.1针对全部文件的版本转换（git reset）"></a>4.1针对全部文件的版本转换（git reset）</h3><h4 id="4-1-1修改已-commit-的版本"><a href="#4-1-1修改已-commit-的版本" class="headerlink" title="4.1.1修改已 commit 的版本"></a>4.1.1修改已 commit 的版本</h4><p>例子：已经提交了 <code>commit</code> 却发现在这个 <code>commit</code> 中忘了附上另一个文件</p><p>操作：添加一个文件, 将这个修改也 <code>commit</code> 进 <code>上一个版本</code></p><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token command">$ git add 2.py</span><span class="token command">$ git commit<span class="token parameter"> --amend</span><span class="token parameter"> --no</span>-edit   # </span><span class="token string">"--no-edit"</span>: 不编辑, 直接合并到上一个 commit<span class="token command">$ git log<span class="token parameter"> --oneline</span>    # </span><span class="token string">"--oneline"</span>: 每个 commit 内容显示在一行<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="4-1-2-reset到上一个add之前"><a href="#4-1-2-reset到上一个add之前" class="headerlink" title="4.1.2 reset到上一个add之前"></a>4.1.2 reset到上一个add之前</h4><p>例子：添加 <code>add</code> 了修改, 但是又后悔, 并想补充一些内容再 <code>add</code>.</p><p>操作：想要回到add之前。 比如在 <code>1.py</code> 文件中添加这一行:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">d <span class="token operator">=</span> <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后 <code>add</code> 去 <code>staged</code> 再返回到 <code>add</code> 之前:</p><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token command">$ git add 1.py</span><span class="token command">$ git status<span class="token parameter"> -s</span> # </span><span class="token string">"-s"</span>: status 的缩写模式<span class="token comment"># 输出</span>M  1.py     # staged<span class="token deleted">-----------------------</span><span class="token command">$ git reset 1.py</span><span class="token command">$ git status<span class="token parameter"> -s</span></span><span class="token comment"># 输出</span>M 1.py     # unstaged<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="4-1-3-reset-回到-commit-之前"><a href="#4-1-3-reset-回到-commit-之前" class="headerlink" title="4.1.3 reset 回到 commit 之前"></a>4.1.3 reset 回到 commit 之前</h4><p>每个 <code>commit</code> 都有自己的 <code>id</code> 数字号, <code>HEAD</code> 是一个指针, 指引当前的状态是在哪个 <code>commit</code>. 最近的一次 <code>commit</code> 在最右边, 我们如果要回到过去, 就是让 <code>HEAD</code> 回到过去并 <code>reset</code> 此时的 <code>HEAD</code> 到过去的位置.</p><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token comment"># 看看所有的log</span><span class="token command">$ git log<span class="token parameter"> --oneline</span></span><span class="token comment"># 输出</span>904e1ba change 2c6762a1 change 113be9a7 create 1.py<span class="token deleted">-----------------------</span><span class="token comment"># 回到 c6762a1 change 1</span><span class="token comment"># 方式1: "HEAD^"</span><span class="token command">$ git reset<span class="token parameter"> --hard</span> HEAD^  </span><span class="token comment"># 方式2: "commit id"</span><span class="token command">$ git reset<span class="token parameter"> --hard</span> c6762a1</span><span class="token deleted">-----------------------</span><span class="token comment"># 看看现在的 log</span><span class="token command">$ git log<span class="token parameter"> --oneline</span></span><span class="token comment"># 输出</span>c6762a1 change 113be9a7 create 1.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>目标：挽救消失的<code>change 2</code></p><p>操作：查看 <code>$ git reflog</code> 里面最近做的所有 <code>HEAD</code> 的改动, 并选择想要挽救的 <code>commit id</code>，重复 <code>reset</code> 步骤就能回到 <code>commit (amend): change 2</code> (id=904e1ba)这一步了::</p><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token command">$ git reflog</span><span class="token comment"># 输出</span>c6762a1 HEAD@{0}: reset: moving to c6762a1904e1ba HEAD@{1}: commit (amend): change 20107760 HEAD@{2}: commit: change 2c6762a1 HEAD@{3}: commit: change 113be9a7 HEAD@{4}: commit (initial): create 1.py<span class="token command">$ git reset<span class="token parameter"> --hard</span> 904e1ba</span><span class="token command">$ git log<span class="token parameter"> --oneline</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-2-针对单个文件的版本转换（check-out）"><a href="#4-2-针对单个文件的版本转换（check-out）" class="headerlink" title="4.2 针对单个文件的版本转换（check out）"></a>4.2 针对单个文件的版本转换（check out）</h3><h4 id="4-2-1-改写文件（checkout）"><a href="#4-2-1-改写文件（checkout）" class="headerlink" title="4.2.1 改写文件（checkout）"></a>4.2.1 改写文件（checkout）</h4><p><strong>目标：</strong></p><p>我们要对 <code>1.py</code> 进行回到过去操作, 回到 <code>c6762a1 change 1</code> 这一个 <code>commit</code> </p><p><strong>操作：</strong></p><p>使用 <code>checkout</code> + id <code>c6762a1</code> + <code>--</code> + 文件目录 <code>1.py</code>, 我们就能将 <code>1.py</code> 的指针 <code>HEAD</code> 放在这个时刻 <code>c6762a1</code>:</p><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token command">$ git log<span class="token parameter"> --oneline</span></span><span class="token comment"># 输出</span>904e1ba change 2c6762a1 change 113be9a7 create 1.py<span class="token deleted">---------------------</span><span class="token command">$ git checkout c6762a1 -- 1.py</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后重新add commit</p><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token command">$ git add 1.py</span><span class="token command">$ git commit<span class="token parameter"> -m</span> </span><span class="token string">"back to change 1 and add comment for 1.py"</span><span class="token command">$ git log<span class="token parameter"> --oneline</span></span><span class="token comment"># 输出</span>47f167e back to change 1 and add comment for 1.py904e1ba change 2c6762a1 change 113be9a7 create 1.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看出, 不像 <code>reset</code> 时那样, 我们的 <code>change 2</code> 并没有消失, 但是 <code>1.py</code> 却已经回去了过去, 并改写了未来.</p><h2 id="五、github在线代码管理"><a href="#五、github在线代码管理" class="headerlink" title="五、github在线代码管理"></a>五、github在线代码管理</h2><h4 id="5-1-创建一个github库"><a href="#5-1-创建一个github库" class="headerlink" title="5.1 创建一个github库"></a>5.1 创建一个github库</h4><p>在 github/gitee注册一个 账户, 这个不用我多说, 大家都知道注册.</p><p>然后添加你的一个 online 版本库 repository:</p><h4 id="5-2-连接本地版本库"><a href="#5-2-连接本地版本库" class="headerlink" title="5.2 连接本地版本库"></a>5.2 连接本地版本库</h4><p>使用这节内容的初始例子文件, 然后将本地的版本库推送到网上:</p><pre class="line-numbers language-git" data-language="git"><code class="language-git"><span class="token comment"># 关联git仓库</span><span class="token command">$ git remote add origin https://github.com/MorvanZhou/git-demo.git</span><span class="token comment"># 将你的仓库和你的github库合并了</span><span class="token command">$ git pull<span class="token parameter"> --rebase</span> origin master</span><span class="token comment"># 将本地仓库推送到远程仓库</span><span class="token command">$ git push origin master</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="5-3-推送修改"><a href="#5-3-推送修改" class="headerlink" title="5.3 推送修改"></a>5.3 推送修改</h4><p>如果在本地再进行修改, 比如在 <code>1.py</code> 文件中加上 <code># happy github</code>, 然后 <code>commit</code> 并推上去:</p><pre class="line-numbers language-git" data-language="git"><code class="language-git">$ cd D:/xx研究生文件集合/code 文件<span class="token command">$ git remote add origin https://github.com/MorvanZhou/git-demo.git</span><span class="token command">$ git add .</span><span class="token command">$ git commit<span class="token parameter"> -am</span> </span><span class="token string">"诊断代码"</span><span class="token command">$ git pull<span class="token parameter"> --rebase</span> origin master</span><span class="token command">$ git push<span class="token parameter"> -u</span> origin master</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux基础篇——虚拟机LINUX系统安装</title>
      <link href="/2023/03/23/linux-ji-chu-pian-xu-ni-ji-linux-xi-tong-an-zhuang/"/>
      <url>/2023/03/23/linux-ji-chu-pian-xu-ni-ji-linux-xi-tong-an-zhuang/</url>
      
        <content type="html"><![CDATA[<h2 id="一、系统分区分区"><a href="#一、系统分区分区" class="headerlink" title="一、系统分区分区"></a>一、系统分区分区</h2><h3 id="1、挂载"><a href="#1、挂载" class="headerlink" title="1、挂载"></a>1、挂载</h3><ul><li>必须分区<ul><li>/（根分区）</li><li>swap分区（交换分区——暂存，内存2倍，不超过2GB)</li></ul></li><li>推荐分区<ul><li>/boot（启动分区，200mb）</li></ul></li></ul><h3 id="2、文件系统结构"><a href="#2、文件系统结构" class="headerlink" title="2、文件系统结构"></a>2、文件系统结构</h3><p><img src="https://img-blog.csdnimg.cn/052d1c2231f94416903f8c5ca1ede8be.png" alt="文件系统结构"></p><h3 id="3、总结"><a href="#3、总结" class="headerlink" title="3、总结"></a>3、总结</h3><ul><li>分区：把大硬盘分为小的逻辑硬盘</li><li>格式化：清空文件；写入文件系统</li><li>分区设备文件名：给每个分区定义设备文件名</li><li>挂载：给每个分区分配挂载点（必须是空目录）</li></ul><h2 id="二、网络连接的三种模式"><a href="#二、网络连接的三种模式" class="headerlink" title="二、网络连接的三种模式"></a>二、网络连接的三种模式</h2><p><img src="https://img-blog.csdnimg.cn/4af95475d0b04b0e9d77713cb79f34a9.png" alt="网络连接的三种模式"></p><ul><li>1、桥接模式<br>虚拟系统可以和外部通讯，但是容易造成ip冲突；<br>虚拟机自动生成与主机IP同一网段的地址用于通讯；<br><strong>原因</strong>：以192.168.0网段最多255个，虚拟系统linux网段与外部一致；可以互相通讯；</li><li>2、NAT模式<br>网络地址转换模式，虚拟系统可以和外部系统通讯，不造成IP冲突；<br><strong>原理</strong>：虚拟系统生成自己的IP地址（例如：192.168.100.88）的同时，在实际系统生成同一网段的ip地址（例如：192.168.100.99）用于通讯，并将实际系统的IP地址作为代理，用于与外部系统通讯；</li><li>3、主机模式：独立的系统；<br>与主机共享专用网络；</li></ul><h2 id="三、真实主机与虚拟机的关系"><a href="#三、真实主机与虚拟机的关系" class="headerlink" title="三、真实主机与虚拟机的关系"></a>三、真实主机与虚拟机的关系</h2><ul><li>centos7.6:   <a href="https://vault.centos.org/7.6.1810/isos/x86_64/">https://vault.centos.org/7.6.1810/isos/x86_64/</a></li><li>vm15.5.1:    <a href="https://www.nocmd.com/windows/740.html">https://www.nocmd.com/windows/740.html</a><br><img src="https://img-blog.csdnimg.cn/0b71efc3b42a44f59b17e6600ee020b2.png" alt="真实主机与虚拟机的关系"></li></ul><h2 id="四、虚拟机克隆、快照、迁移与删除"><a href="#四、虚拟机克隆、快照、迁移与删除" class="headerlink" title="四、虚拟机克隆、快照、迁移与删除"></a>四、虚拟机克隆、快照、迁移与删除</h2><h3 id="1、克隆"><a href="#1、克隆" class="headerlink" title="1、克隆"></a>1、克隆</h3><ul><li>方式1，直接拷贝一份安装好的虚拟机文件</li><li>方式2，使用vmware的克隆操作<br>（注意，克隆时，需要先关闭linux系统）</li></ul><h3 id="2、快照"><a href="#2、快照" class="headerlink" title="2、快照"></a>2、快照</h3><p>若使用虚拟机系统时，想回到原先的一个状态，就需要提前创建一个快照；<br>步骤：</p><ul><li>安装好系统后，先做一个拍摄快照A</li><li>系统出故障之后，在快照管理里快速恢复到快照A</li></ul><h3 id="3、迁移"><a href="#3、迁移" class="headerlink" title="3、迁移"></a>3、迁移</h3><ul><li>虚拟机系统安装好；它的本质是文件；</li><li>虚拟机的迁移——将安装好的虚拟机系统文件夹整体拷贝到另外位置；</li></ul><h3 id="4、删除"><a href="#4、删除" class="headerlink" title="4、删除"></a>4、删除</h3><ol><li>用vmware移除；</li><li>点击菜单从磁盘中删除<strong>或者</strong>手动删除虚拟系统对应文件夹</li></ol><h2 id="五、安装vmtools"><a href="#五、安装vmtools" class="headerlink" title="五、安装vmtools"></a>五、安装vmtools</h2><ul><li>可以在windows下更好的管理vm虚拟机</li><li>可以设置windows和centos的共享文件夹<br><img src="https://img-blog.csdnimg.cn/e10e0cb110334615aa1c442e22ede771.png" alt="共享文件原理图"></li></ul><h3 id="5-1安装vmtools的步骤"><a href="#5-1安装vmtools的步骤" class="headerlink" title="5.1安装vmtools的步骤"></a>5.1安装vmtools的步骤</h3><ol><li>启动centos7虚拟机（以管理员权限打开）</li><li>点击vm菜单的虚拟机-&gt;install vmware tools</li><li>centos虚拟机桌面会出现vmware tools </li><li>打开vmware tools 出现一个xx.tar.gz的安装包</li><li>复制xx.tar.gz，将其复制到opt文件夹<br>（主文件夹—&gt;其他位置-&gt;计算机-&gt;opt文件夹）</li><li>从终端进入到opt目录<br> 即，在终端输入 cd /opt/</li><li>在终端opt目录下解压<br> 即tar -zxvf xx.tar.gz(打入前两个字符，再使用tab键即可自动补充复杂的文件名）</li><li>进入到解压后的目录<br>  cd xx/（tab自动补充文件名）</li><li>利用ls可以查看所在目录下的文件</li><li>安装<br>使用命令./vmware-install.pl(文件名.pl)<br>然后点击一系列回车予以确认，（即全部使用默认设置）</li><li>注意：安装vmtools需要有<strong>gcc</strong><br>  如何判断是否安装gcc，在终端输入gcc -v</li></ol><h3 id="5-2-设置共享文件夹"><a href="#5-2-设置共享文件夹" class="headerlink" title="5.2 设置共享文件夹"></a>5.2 设置共享文件夹</h3><p><img src="https://img-blog.csdnimg.cn/9c43ed9f28974ce7b3edfe3ddc55a3c6.png" alt="设置共享文件夹"></p><h2 id="六、Linux的目录结构"><a href="#六、Linux的目录结构" class="headerlink" title="六、Linux的目录结构"></a>六、Linux的目录结构</h2><ul><li>基本介绍</li></ul><ol><li><p>linux的文件系统采用层级式树状结构，在结构中最上层是根目录“/”，然后在此目录下再创建其他的目录。</p></li><li><p>记住经典的话：在linux世界里，一切皆文件<br><img src="https://img-blog.csdnimg.cn/41322e9f47ea4f44b972af591a8aa6eb.png" alt="linux目录结构"></p></li><li><p>Linux目录结构是规定好的：<br><img src="https://img-blog.csdnimg.cn/cdbd89bd1f3c408790f3a9b53962a67b.png" alt="具体目录结构1"><br><img src="https://img-blog.csdnimg.cn/68623a65f29447b0a20d4927c5a9c306.png" alt="具体目录结构2"><br><img src="https://img-blog.csdnimg.cn/f961d13f1aa94fe0ab4b69ea004df1c5.png" alt="具体目录结构3"><br><img src="https://img-blog.csdnimg.cn/ef8d8b4f147a43a9b18b107fd5b5a488.png" alt="具体目录结构4"></p></li></ol><ul><li>基础命令<br>增添用户命令：useradd jack(用户名)<br>删除用户指令：userdel -r jack(用户名）<br>显示命令：ls（显示该文件夹下有什么文件）<br>查看linux虚拟系统IP：ifconfig<br>用 ping 192.168.2.129（虚拟系统的ip地址）<br>作用：用来判断虚拟系统ip与真实系统ip是否可以联通</li></ul>]]></content>
      
      
      <categories>
          
          <category> 嵌入式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> 嵌入式开发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pandas基础学习笔记（简略版）</title>
      <link href="/2023/03/23/pandas-ji-chu-xue-xi-bi-ji-jian-lue-ban/"/>
      <url>/2023/03/23/pandas-ji-chu-xue-xi-bi-ji-jian-lue-ban/</url>
      
        <content type="html"><![CDATA[<h2 id="1、DataFrame"><a href="#1、DataFrame" class="headerlink" title="1、DataFrame"></a>1、DataFrame</h2><p>既有行索引(index)又有列索引(columns)的二维数组</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 生成dataframe</span>stock<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'股票</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">'</span></span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>date<span class="token operator">=</span>pd<span class="token punctuation">.</span>date_range<span class="token punctuation">(</span>start<span class="token operator">=</span><span class="token string">'20211201'</span><span class="token punctuation">,</span>priods<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>freq<span class="token operator">=</span><span class="token string">'B'</span><span class="token punctuation">)</span>data1<span class="token operator">=</span>pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>stock_change<span class="token punctuation">,</span>index<span class="token operator">=</span>stock<span class="token punctuation">,</span>columns<span class="token operator">=</span>date<span class="token punctuation">)</span>data2<span class="token operator">=</span>pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'month'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                  <span class="token string">'year'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                  <span class="token string">'sale'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment"># dataframe的方法与属性</span><span class="token comment"># 方法</span>data<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>data<span class="token punctuation">.</span>tail<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 属性</span>data<span class="token punctuation">.</span>columnsdata<span class="token punctuation">.</span>indexdata<span class="token punctuation">.</span>valuesdata<span class="token punctuation">.</span>shapedata<span class="token punctuation">.</span>dtype<span class="token comment"># 重设索引</span>stock_<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'股票_</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">'</span></span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>data<span class="token punctuation">.</span>index<span class="token operator">=</span>stock_<span class="token comment"># 扔掉原有的行索引，用1，2，3，4代替</span>data<span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span>drop<span class="token operator">=</span>Flase<span class="token punctuation">)</span><span class="token comment"># 用‘股票0’列做索引</span>data<span class="token punctuation">.</span>set_index<span class="token punctuation">(</span><span class="token string">'股票0'</span>，drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2、series"><a href="#2、series" class="headerlink" title="2、series"></a>2、series</h2><p>带行索引的一维数组</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 创建索引</span>data1<span class="token operator">=</span>pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'red'</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string">'yellow'</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token string">'black'</span><span class="token punctuation">:</span><span class="token number">40</span><span class="token punctuation">}</span><span class="token punctuation">)</span>data2<span class="token operator">=</span>pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>index<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'r'</span><span class="token punctuation">,</span><span class="token string">'y'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'k'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="3、基本数据操作"><a href="#3、基本数据操作" class="headerlink" title="3、基本数据操作"></a>3、基本数据操作</h2><ol><li><p>索引操作</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">data<span class="token punctuation">[</span><span class="token string">'columns名'</span><span class="token punctuation">]</span>data<span class="token punctuation">[</span><span class="token string">'columns名'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'index名'</span><span class="token punctuation">]</span>data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>data<span class="token punctuation">.</span>loc<span class="token punctuation">[</span><span class="token string">'index名'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'columns名'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>赋值操作</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 索引=值</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>排序操作</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">data<span class="token punctuation">.</span>sort_index<span class="token punctuation">(</span>ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>data<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token string">'行列名'</span>，ascending<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ol><h2 id="4、DataFrame-运算"><a href="#4、DataFrame-运算" class="headerlink" title="4、DataFrame 运算"></a>4、DataFrame 运算</h2><ol><li><p>算数运算</p><p>和numpy中 <strong>array与数运算</strong>类似</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">data<span class="token punctuation">[</span><span class="token string">'股票0'</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span>data<span class="token punctuation">[</span><span class="token string">'股票1'</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>逻辑运算</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 逻辑运算符  &lt; &gt; | &amp;</span>data<span class="token punctuation">[</span><span class="token string">'股票0'</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'股票0'</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'股票1'</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment"># 逻辑运算函数</span>data<span class="token punctuation">[</span><span class="token string">'股票0'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isin<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># 3,2,1在不在里面</span>data<span class="token punctuation">.</span>query<span class="token punctuation">(</span><span class="token string">'股票0&gt;0&amp;股票1&lt;0'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>统计运算</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 1、df.describe()</span>data<span class="token punctuation">.</span>decribe<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 2、df.idxmax(axis=0)</span>data<span class="token punctuation">.</span>idxmax<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment"># 3、cumsum、cummax、cummin、cumprod(前n个数的积)</span>data<span class="token punctuation">[</span><span class="token string">'股票0'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cumsum<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>自定义运算</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># df.apply(func,axis=0)</span>data<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>x<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ol><h2 id="5、pandas绘图"><a href="#5、pandas绘图" class="headerlink" title="5、pandas绘图"></a>5、pandas绘图</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 1、df.plot(x=none,y=none,kind='line')</span>data<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token string">"volume"</span><span class="token punctuation">,</span>y<span class="token operator">=</span><span class="token string">'turnover'</span><span class="token punctuation">,</span>kind<span class="token operator">=</span><span class="token string">'scatter'</span><span class="token punctuation">)</span><span class="token comment"># 2、Series.plot(kind='line')</span>sr<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>kind<span class="token operator">=</span><span class="token string">'line'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="6、文本的读取与存储"><a href="#6、文本的读取与存储" class="headerlink" title="6、文本的读取与存储"></a>6、文本的读取与存储</h2><ul><li><p>csv</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 1、读取想要的列</span>data<span class="token operator">=</span>pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'./1.csv'</span><span class="token punctuation">,</span>usecols<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'列名'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment"># 2、给没有列名的图表加列名</span>data<span class="token operator">=</span>pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'./2.csv'</span><span class="token punctuation">,</span>names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'列名'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment"># 3、保存文件</span>data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'test.csv'</span><span class="token punctuation">,</span>index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'test1.csv'</span><span class="token punctuation">,</span>columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'列名'</span><span class="token punctuation">]</span>，index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token comment"># 4、丢弃不想要的列</span>data<span class="token operator">=</span>data<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'ma'</span><span class="token punctuation">,</span><span class="token string">'列名'</span>，axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>hdf5</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># hdf5文件读取与存储时需要指定一个键（类似matlab里的变量名）</span>data<span class="token operator">=</span>pd<span class="token punctuation">.</span>read_hdf<span class="token punctuation">(</span><span class="token string">'./1.h5'</span><span class="token punctuation">,</span>key<span class="token operator">=</span><span class="token string">'变量名'</span><span class="token punctuation">)</span>data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_hdf<span class="token punctuation">(</span><span class="token string">"2.h5"</span><span class="token punctuation">,</span>key<span class="token operator">=</span><span class="token string">'变量名'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>json</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">data<span class="token operator">=</span>pd<span class="token punctuation">.</span>read_json<span class="token punctuation">(</span><span class="token string">'./1.json'</span><span class="token punctuation">,</span>orient<span class="token operator">=</span><span class="token string">'records'</span><span class="token punctuation">,</span>lines<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_json<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'2.json'</span><span class="token punctuation">,</span>orient<span class="token operator">=</span><span class="token string">'records'</span><span class="token punctuation">,</span>lines<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul>]]></content>
      
      
      <categories>
          
          <category> 数据分析 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据分析 </tag>
            
            <tag> 数据挖掘 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pandas,matlab读取文件</title>
      <link href="/2023/03/23/pandas-du-qu-wen-jian/"/>
      <url>/2023/03/23/pandas-du-qu-wen-jian/</url>
      
        <content type="html"><![CDATA[<h2 id="一、pandas读取文件用法"><a href="#一、pandas读取文件用法" class="headerlink" title="一、pandas读取文件用法"></a>一、pandas读取文件用法</h2><h3 id="1、pandas读取xlsx、xls文件"><a href="#1、pandas读取xlsx、xls文件" class="headerlink" title="1、pandas读取xlsx、xls文件"></a>1、pandas读取xlsx、xls文件</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pddata<span class="token operator">=</span>pd<span class="token punctuation">.</span>read_excel<span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">,</span>sheetname<span class="token operator">=</span><span class="token string">'sheet1'</span><span class="token punctuation">,</span>header<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'第一列'</span><span class="token punctuation">,</span><span class="token string">'第二列'</span><span class="token punctuation">,</span><span class="token string">'第三列'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><p>path:要读取的文件的绝对路径</p></li><li><p>sheetname：指定读取excel中的哪一个工作表，默认sheetname=0，即默认读取excel中的第一个工作表<br>若sheetname = ‘sheet1’，即读取excel中的sheet1工作表；</p></li><li><p>header:用作列名的行号，默认为header=0</p><p>若header=None,则表明数据中没有列名行</p><p>若header=0，则表明第一行为列名</p></li><li><p>names:列名命名或重命名</p></li></ul><h3 id="2、pandas读取csv文件"><a href="#2、pandas读取csv文件" class="headerlink" title="2、pandas读取csv文件"></a>2、pandas读取csv文件</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pddata<span class="token operator">=</span>pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">,</span>sep<span class="token operator">=</span><span class="token string">','</span><span class="token punctuation">,</span>header<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"第一列"</span>，<span class="token string">"第二列"</span>，<span class="token string">"第三列"</span><span class="token punctuation">]</span>，encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><p>path: 要读取的文件的绝对路径</p></li><li><p>sep:指定列和列的间隔符，默认sep=’,’</p><p>若sep=’’\t”,即列与列之间用制表符\t分割，相当于tab——四个空格</p></li><li><p>header:列名行，默认为0</p></li><li><p>names:列名命名或重命名</p></li><li><p>encoding:指定用于unicode文本编码格式</p></li></ul><h3 id="3、pandas读取txt文件"><a href="#3、pandas读取txt文件" class="headerlink" title="3、pandas读取txt文件"></a>3、pandas读取txt文件</h3><p>read_csv 也可以读取txt文件，读取txt文件的方法同上，也可以用read_table读取txt文件</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pddata <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_table<span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">,</span> sep <span class="token operator">=</span> <span class="token string">'\t'</span><span class="token punctuation">,</span> header <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span> names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'第一列'</span><span class="token punctuation">,</span><span class="token string">'第二列'</span><span class="token punctuation">,</span><span class="token string">'第三列'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="二、MATLAB的-mat文件与txt文件的相互转换（mat转txt，数据格式设置）"><a href="#二、MATLAB的-mat文件与txt文件的相互转换（mat转txt，数据格式设置）" class="headerlink" title="二、MATLAB的.mat文件与txt文件的相互转换（mat转txt，数据格式设置）"></a>二、MATLAB的.mat文件与txt文件的相互转换（mat转txt，数据格式设置）</h2><h3 id="1、xx-txt转换为xx-mat"><a href="#1、xx-txt转换为xx-mat" class="headerlink" title="1、xx.txt转换为xx.mat"></a>1、xx.txt转换为xx.mat</h3><ul><li><p>load(‘路径\xx.txt’)</p><p><strong>加载txt文件</strong>，加载成功之后，在workspace中出现与该txt文件同名的变量</p><p>若txt文件名中有”-“字符，则在workspace中变量名中相应字符变为”_”</p></li><li><p>save(“路径\xx.mat”,”变量名”)</p></li></ul><pre class="line-numbers language-matlab" data-language="matlab"><code class="language-matlab"><span class="token function">load</span><span class="token punctuation">(</span>"D<span class="token operator">:</span><span class="token operator">\</span>matlabprogram<span class="token operator">\</span>test<span class="token operator">-</span><span class="token number">1.</span>txt"<span class="token punctuation">)</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token string">'D:\matlabprogram\test-1.mat'</span><span class="token punctuation">,</span><span class="token string">'test_1'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="2、xx-mat转换为xx-txt"><a href="#2、xx-mat转换为xx-txt" class="headerlink" title="2、xx.mat转换为xx.txt"></a>2、xx.mat转换为xx.txt</h3><p>(1) 不考虑转换后txt文件中的数据格式</p><ul><li>load(‘路径\xx.mat’)</li><li>save(‘路径\xx.txt’,’’,’-ASCLL’)</li></ul><p>观察最后得到的txt文件内容发现，若存储的是数值序列，则txt中数值以可续计数法保存和显示。</p><p>（2）设置txt文件中的数据格式</p><pre class="line-numbers language-matlab" data-language="matlab"><code class="language-matlab"><span class="token function">load</span><span class="token punctuation">(</span>"D<span class="token operator">:</span><span class="token operator">\</span>matlabprogram<span class="token operator">\</span>values<span class="token punctuation">.</span>mat"<span class="token punctuation">)</span><span class="token punctuation">;</span>values<span class="token punctuation">.</span>mafid <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">'D:\matlabprogram\values.txt'</span><span class="token punctuation">,</span> <span class="token string">'wt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fprint</span><span class="token punctuation">(</span>fid<span class="token punctuation">,</span><span class="token string">'%6.2f\n'</span><span class="token punctuation">,</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fclose</span><span class="token punctuation">(</span>fid<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>再次观察生成的txt文件会发现数值不再以科学计数法显示了，小数点保留了后两位。</p>]]></content>
      
      
      <categories>
          
          <category> 数据分析 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据分析 </tag>
            
            <tag> 数据挖掘 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>tableau数据可视化</title>
      <link href="/2023/03/23/tableau-shu-ju-ke-shi-hua/"/>
      <url>/2023/03/23/tableau-shu-ju-ke-shi-hua/</url>
      
        <content type="html"><![CDATA[<h2 id="一、Tableau可视化原理"><a href="#一、Tableau可视化原理" class="headerlink" title="一、Tableau可视化原理"></a>一、Tableau可视化原理</h2><h3 id="1、Tableau的第一概念："><a href="#1、Tableau的第一概念：" class="headerlink" title="1、Tableau的第一概念："></a>1、Tableau的第一概念：</h3><p><strong>对度量和维度进行拖拽操作，从而实现可视化图表的制作。</strong><br>度量默认聚合，度量值会形成图形标记，图形标记可以切换。</p><p>可拖拽操作区域主要有以下三个：<br>1、 行列（Y-X）可通过转置交换<br>2、 标记卡：<br>用来切换数据对应的视觉影射类型<br>用来调整图标颜色、标记、大小等细节<br>3、筛选器：将指定变量作为筛选条件</p><h3 id="2、Tableau可视化原理的第二个概念："><a href="#2、Tableau可视化原理的第二个概念：" class="headerlink" title="2、Tableau可视化原理的第二个概念："></a>2、Tableau可视化原理的第二个概念：</h3><p><strong>维度会对度量值进行区分，增加度量值的信息密度（单个图表传达信息的多少）</strong></p><p>1、当点击线时，只有一个点，需要引入<strong>维度</strong>对点进行拆分。（例如将<strong>维度</strong>复制，将其格式变为字符串列）<br>2、将维度放在颜色、标签、详细信息、行、列都可以对度量进行区分，并且形成对应的效果。（<strong>维度对度量</strong>进行<strong>切分</strong>，增加信息密度，维度（列），度量（行））<br>3、<strong>词云的制作方法</strong>：<br>将日期（字符串，维度）放到标签，消耗（度量）放到大小上，<strong>标记显示格式</strong>变为<strong>文本</strong></p><h3 id="3、Tableau可视化原理的第三个概念："><a href="#3、Tableau可视化原理的第三个概念：" class="headerlink" title="3、Tableau可视化原理的第三个概念："></a>3、Tableau可视化原理的第三个概念：</h3><p><strong>图表分为有轴图表和无轴图表（极坐标图表）</strong></p><p><strong>无轴图表制作方法：</strong><br>将<strong>度量</strong>放到大小上，<strong>维度</strong>放在颜色、标签、详细信息上，然后选择对应的<strong>图形标记</strong></p><p>饼图：<strong>度量的数值大小</strong>映射成饼图的角度和面积大小，<strong>维度</strong>用来区分<strong>种类</strong>，选择<strong>标记显示格式</strong>为饼图<br>树地图：<strong>度量的数值大小</strong>映射成饼图的角度和面积大小，<strong>维度</strong>用来区分<strong>种类</strong>，选择<strong>标记显示格式</strong>为方形</p><h3 id="4、Tableau可视化原理的第四个概念："><a href="#4、Tableau可视化原理的第四个概念：" class="headerlink" title="4、Tableau可视化原理的第四个概念："></a>4、Tableau可视化原理的第四个概念：</h3><p><strong>离散形成标签，连续形成数轴</strong></p><p>1、对于<strong>数轴的理解</strong>是Tableau在表和图之间切换的关键。<br>度量（绿色）一般都是连续的——形成数轴(Y)<br>维度（蓝色）一般都是离散的——形成标签(X)<br>2、表格就是由<strong>离散的维度标签</strong>所组成<br>3、度量变成标签——将<strong>度量改为离散</strong>即可</p><h2 id="二、基础图表的制作"><a href="#二、基础图表的制作" class="headerlink" title="二、基础图表的制作"></a>二、基础图表的制作</h2><p>1、柱状图：<br><strong>列</strong>为维度，<strong>行</strong>为度量<br>2、条形图：<br>柱状图转置，即<strong>行</strong>为维度，<strong>列</strong>为度量<br>【创建分级结构】实现数据钻取<br>【添加筛选器】实现数据选取<br>3、热力图（突出显示表）：</p><ul><li>先做出文本表：至少拖拽一个<strong>维度</strong>至行，然后直接拖拽需要展示的<strong>度量</strong>到维度后的Abc上</li><li>最后将需要展现的【度量】或直接将度量值拖拽至颜色</li><li>然后选择标记下方的图表类型为方形（不选择方形则是数值变色）</li></ul><p>4、气泡图：<br><strong>制作流程：</strong><br><strong>度量</strong>至大小<br><strong>维度</strong>至<strong>颜色和标签</strong><br><strong>图形</strong>选为圆形<br>5、词云：<br>用<strong>度量</strong>代表文本大小，<strong>维度</strong>代表文本颜色<br><strong>制作流程</strong>：<br><strong>度量</strong>至大小<br><strong>维度</strong>至颜色和标签<br>图形选为文本<br>6、饼图：<br>【维度】拖拽至颜色<br>【度量】拖拽至大小<br>选择图表类型为饼图<br>【快速表计算】<br>右键<strong>标签度量</strong>选择快速表计算，合计百分比计算各数值的百分比占比<br>最后右键标记的数值设置格式，区，第一个，设置为为1位数百分比<br>帮助右下角可以调整视图的显示方式<br>7、树地图：<br>【度量】至大小<br>【维度】至标签、颜色<br>8、堆积图<br>绝对堆积：在柱状图/条形图的基础上，用<strong>颜色区分</strong>一个<strong>维度</strong>在另一个<strong>维度</strong>下的占比大小<br>在做完柱状图后，将需要堆积展示占比的<strong>维度</strong>拖拽至颜色即可<br>9、折线图：<br>拖拽时间【维度】至列，【度量】至行<br>选择线<br><strong>设置时间类型，下拉列中的胶囊</strong><br>上方时间选择为离散，以日-周-月为不同类别汇总统计数据，即每一年的一月都视为一个变量<br>下方时间选择为连续，以连续的日-周-月等时间单位为序列统计数据，每一年的一月都是不一样的变量<br>【维度】到颜色可做出多维折线图，一个颜色代表一个类别<br>基于<strong>连续时间序列</strong>的折线图预测<strong>接下来的数据走向</strong>注：只有连续变量的预测才有意义</p>]]></content>
      
      
      <categories>
          
          <category> 数据分析 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据分析 </tag>
            
            <tag> 数据挖掘 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数据分析-excel</title>
      <link href="/2023/03/23/shu-ju-fen-xi-excel/"/>
      <url>/2023/03/23/shu-ju-fen-xi-excel/</url>
      
        <content type="html"><![CDATA[<h2 id="数据分析-excel"><a href="#数据分析-excel" class="headerlink" title="数据分析-excel"></a>数据分析-excel</h2><ul><li>拿到excel表，先备份一份源数据</li><li>然后对源数据进行分析，快速筛选有助于分析（ctrl+shift+L ——筛选）</li></ul><h3 id="一、数据透视表"><a href="#一、数据透视表" class="headerlink" title="一、数据透视表"></a>一、数据透视表</h3><ul><li>制作数据透视表（插入-数据透视表）<ul><li>将<strong>已有固定字段</strong>添加到<strong>报表</strong>（筛选、列、行、行列对应的值）</li><li><strong>创建新的字段</strong>（数据透视表分析-字段、项目和集-计算字段）</li><li>筛选<ul><li>插入切片器（作用筛选，位置：数据透视表分析-插入切片器）</li><li>直接把要<strong>筛选的字段</strong>拖入到<strong>筛选</strong>中</li><li><strong>区别</strong>：切片器可以在透视表外进行控制</li></ul></li><li>透视图表的制作<ul><li>选择要制作<strong>图表的标签</strong>，并选择要制作的<strong>数据透视表类型</strong></li></ul></li></ul></li></ul><h3 id="二、Excel常用函数"><a href="#二、Excel常用函数" class="headerlink" title="二、Excel常用函数"></a>二、Excel常用函数</h3><ul><li>常用技巧，冻结首行首列、新建窗口(位置：视图）</li></ul><ol><li>sum</li></ol><ul><li>语法：sum(num1,num2,…)  整行sum(A:A)  sum(行名)</li><li>sum(单个或多个单元格）、sum(A1:A22)</li></ul><ol start="2"><li>sumif</li></ol><ul><li>语法：sumif(条件判断区域，条件，用来求和的数值区域）</li><li>锁定列——=$B15，B不会发生变化，15会变化</li><li>日期：例如B15的值为2020/07/01，想要得到2020/07/16，只需要输入“=B15+15”</li></ul><ol start="3"><li>sumifs–多条件求和</li></ol><ul><li>sumifs(用来求和的数值区域，条件1判断所在区域，条件1，条件2判断所在区域，条件2…)</li><li>环比、同比的求法<ul><li>2020年环比=2020年数据/2019年数据-1</li><li>2020年7月环比=2020年7月数据/2020年6月数据-1</li><li>2020年7月同比=2020年7月数据/2019年7月数据-1</li><li>2020年7月1日环比=2020年7月1日数据/2020年6月30日数据-1</li><li>2020年7月1日月同比=2020年7月1日数据/2020年6月1日数据-1</li><li>2020年7月1日周同比=2020年7月1日数据/2020年6月24日数据-1</li></ul></li><li>DATE（year,month,day)</li><li>year(B30)——年，month(B30)——月，day（B30)——日</li><li>不要用excel的日期格式存储日期——用字符串</li><li>每个月的第一天：DATE(YEAR(B39),MONTH(B39),1)</li><li>每个月的最后一天：DATE(YEAR(B39),MONTH(B39)+1,1)-1</li></ul><ol start="4"><li>sum和subtotal的区别</li></ol><ul><li>subtotal(指定函数，选择区域1，选择区域2，…)</li><li>subtotal可以根据筛选改变</li></ul><ol start="5"><li>if函数</li></ol><ul><li>if(逻辑比较条件，结果成立返回值，结果不成立返回值）</li></ul><ol start="6"><li>vlookup函数</li></ol><ul><li>语法：vlookup(要查找的数据,要<strong>查找的位置</strong>（<strong>必须在第一行</strong>）和要<strong>返回的数据区域</strong>，要返回的数据在区域中的列号，返回<strong>近似匹配为1或精确匹配为0</strong>-指示为1/TRUE或0/FALSE)</li><li><strong>通配符：*——代替不定数量的字符，？——代替一个字符</strong></li><li>符合条件的可能有多个，但是只返回第一个</li><li>vlookup基于聚合运算结果（透视表）进行查找</li></ul><ol start="7"><li>index和match函数（关键）</li></ol><ul><li><strong>match作用</strong>：在选定的行<strong>或</strong>列里找出已给出的值的<strong>位置</strong></li><li>语法：match(查找项，查找区域，0）</li><li>index作用：得到索引值</li><li>语法：index(区域，行号，列号）</li><li><strong>组合用法：</strong></li><li>index(数据区域,match(行查找项，index数据区域的相对区域,0),match(列查找项，indexB数据区域的相对区域，0)</li></ul><h3 id="三、大厂周报表"><a href="#三、大厂周报表" class="headerlink" title="三、大厂周报表"></a>三、大厂周报表</h3><ol><li>日期只填一个，其他的都是所填日期的应用，以此达到整表变换</li><li>GMV的计算，if(平台=“全部”，sumif(日期列，日期，gmv),sumifs(gmv,日期列，日期，平台列，平台)</li><li>灵活的图表在于正则化，及将所在列用正则化的形式匹配。</li><li>根据数据类型的不同，设置格式</li></ol>]]></content>
      
      
      <categories>
          
          <category> 数据分析 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据分析 </tag>
            
            <tag> 数据挖掘 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>绘图模板1（matplotlib）</title>
      <link href="/2023/03/23/hui-tu-mo-ban-1-matplotlib/"/>
      <url>/2023/03/23/hui-tu-mo-ban-1-matplotlib/</url>
      
        <content type="html"><![CDATA[<p>@<a href="%E7%BB%98%E5%9B%BE%E6%A8%A1%E6%9D%BF%EF%BC%88matplotlib%EF%BC%89">TOC</a></p><h1 id="一、Matplotlib-是专门用于开发2D图表（三层结构）"><a href="#一、Matplotlib-是专门用于开发2D图表（三层结构）" class="headerlink" title="一、Matplotlib 是专门用于开发2D图表（三层结构）"></a>一、Matplotlib 是专门用于开发2D图表（三层结构）</h1><ol><li>容器层</li></ol><ul><li>画板层Canvas</li><li>画布层Figure</li><li>绘图层/坐标系</li></ul><ol start="2"><li>辅助显示层</li><li>图像层</li></ol><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token keyword">import</span> matplotlib <span class="token keyword">as</span> mpl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h1 id="二、通用绘画模板–单折线图"><a href="#二、通用绘画模板–单折线图" class="headerlink" title="二、通用绘画模板–单折线图"></a>二、通用绘画模板–单折线图</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 1.数据准备</span>x <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>y<span class="token operator">=</span> <span class="token punctuation">[</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> x<span class="token punctuation">]</span><span class="token comment"># 2. 中文显示问题</span>plt<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">'font.sans-serif'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'SimHei'</span><span class="token punctuation">]</span>  <span class="token comment"># 用来正常显示中文标签</span>plt<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">'axes.unicode_minus'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token boolean">False</span>   <span class="token comment"># 用来正常显示负号</span><span class="token comment"># 3、创建画布</span>plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>dpi<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token comment"># 4.绘制图像</span>plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>color<span class="token operator">=</span><span class="token string">'r'</span><span class="token punctuation">,</span>linestyle<span class="token operator">=</span><span class="token string">'-.'</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">'上海'</span><span class="token punctuation">)</span><span class="token comment"># 5.显示图例</span>plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment"># 6.修改x y 刻度</span>plt<span class="token punctuation">.</span>yticks<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>xticks<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 7.显示网格</span>plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>linestyle<span class="token operator">=</span><span class="token string">'--'</span><span class="token punctuation">,</span>alpha<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token comment"># 8.添加描述 标题</span>plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'x_label'</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'y_label'</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span><span class="token comment"># 9.显示图像</span>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/b7a72ab7659848678fc4dd8c67ce4e57.png" alt="在这里插入图片描述"></p><p>​    </p><h1 id="三、多坐标系绘图模板（两种形式）"><a href="#三、多坐标系绘图模板（两种形式）" class="headerlink" title="三、多坐标系绘图模板（两种形式）"></a>三、多坐标系绘图模板（两种形式）</h1><h2 id="法一："><a href="#法一：" class="headerlink" title="法一："></a>法一：</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 温度变化折线图</span><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt<span class="token operator">%</span>matplotlib inline<span class="token keyword">import</span> random<span class="token comment"># 1、准备数据</span>x <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>y_shanghai <span class="token operator">=</span> <span class="token punctuation">[</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> x<span class="token punctuation">]</span>y_beijing <span class="token operator">=</span> <span class="token punctuation">[</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> x<span class="token punctuation">]</span><span class="token comment"># 2、创建画布</span><span class="token comment"># plt.figure(figsize=(20,8),dpi=80)</span>figure<span class="token punctuation">,</span> axes <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span>nrows<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>ncols<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>dpi<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token comment"># 3、绘制图像</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y_shanghai<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"r"</span><span class="token punctuation">,</span>linestyle<span class="token operator">=</span><span class="token string">'-.'</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">"上海"</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y_beijing<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"b"</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">"北京"</span><span class="token punctuation">)</span><span class="token comment"># 显示图例</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># plt.legend(loc="lower left")</span><span class="token comment"># plt.legend(loc=4)</span><span class="token comment"># 修改x y刻度</span>x_label <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"11分{}秒"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> x<span class="token punctuation">]</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xticks<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xticklabels<span class="token punctuation">(</span>x_label<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_yticks<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xticks<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xticklabels<span class="token punctuation">(</span>x_label<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_yticks<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 显示网格</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>grid<span class="token punctuation">(</span>linestyle<span class="token operator">=</span><span class="token string">'--'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>grid<span class="token punctuation">(</span>linestyle<span class="token operator">=</span><span class="token string">'--'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token comment"># 添加描述 标题</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">"时间"</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">"温度"</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">"上海11点0分到12点之间的温度变化图示"</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">"时间"</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">"温度"</span><span class="token punctuation">)</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">"北京11点0分到12点之间的温度变化图示"</span><span class="token punctuation">)</span><span class="token comment"># 4、显示图像</span>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="C:\Users\乔彬\AppData\Roaming\Typora\typora-user-images\image-20230323172511455.png" alt="image-20230323172511455"></p><p>​    </p><h2 id="法二："><a href="#法二：" class="headerlink" title="法二："></a>法二：</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 温度变化折线图</span><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt<span class="token operator">%</span>matplotlib inline<span class="token keyword">import</span> random<span class="token comment"># 1、准备数据</span>x <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>y_shanghai <span class="token operator">=</span> <span class="token punctuation">[</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> x<span class="token punctuation">]</span>y_beijing <span class="token operator">=</span> <span class="token punctuation">[</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> x<span class="token punctuation">]</span><span class="token comment"># 2、创建画布</span>plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>dpi<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token comment"># 3、绘制图像1</span>plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y_shanghai<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"r"</span><span class="token punctuation">,</span>linestyle<span class="token operator">=</span><span class="token string">'-.'</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">"上海"</span><span class="token punctuation">)</span><span class="token comment"># 3.1.显示图例</span>plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment"># 3.2 修改x y 刻度</span>plt<span class="token punctuation">.</span>yticks<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>xticks<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 3.3显示网格</span>plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>linestyle<span class="token operator">=</span><span class="token string">'--'</span><span class="token punctuation">,</span>alpha<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token comment"># 3.4添加描述 标题</span>plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'x_label'</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'y_label'</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'上海11点0分到12点之间的温度变化图示'</span><span class="token punctuation">)</span><span class="token comment"># 4、绘制图像2</span>plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y_beijing<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"b"</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">"北京"</span><span class="token punctuation">)</span><span class="token comment"># 4.1.显示图例</span>plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment"># 4.2 修改x y 刻度</span>plt<span class="token punctuation">.</span>yticks<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>xticks<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 4.3显示网格</span>plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>linestyle<span class="token operator">=</span><span class="token string">'--'</span><span class="token punctuation">,</span>alpha<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token comment"># 4.4添加描述 标题</span>plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'x_label'</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'y_label'</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'北京11点0分到12点之间的温度变化图示'</span><span class="token punctuation">)</span><span class="token comment"># 5、显示图像</span>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/da97c610eddd436a9fb86113658dcabb.png" alt="在这里插入图片描述"></p><p>​    </p><p>​    </p><h1 id="四、线属性的设置"><a href="#四、线属性的设置" class="headerlink" title="四、线属性的设置"></a>四、线属性的设置</h1><ol><li>直接在plot（）函数中设置</li><li>获得线属性，使用setp（）函数设置</li></ol><p>其中常用的的参数有：</p><ul><li>xdata:需要绘制的line中点的在x轴上的取值，若忽略，则默认为range(1,len(ydata)+1)</li><li>ydata:需要绘制的line中点的在y轴上的取值</li><li>linewidth:线条的宽度</li><li>linestyle:线型</li><li>color:线条的颜色</li><li>marker:点的标记，详细可参考markers API</li><li>markersize:标记的size</li></ul><h2 id="直接在plot（）函数中设置"><a href="#直接在plot（）函数中设置" class="headerlink" title="直接在plot（）函数中设置"></a>直接在plot（）函数中设置</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python">x <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span>y <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">]</span>plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment"># 设置线的粗细参数为10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="C:\Users\乔彬\AppData\Roaming\Typora\typora-user-images\image-20230323172620869.png" alt="image-20230323172620869"></p><h2 id="获得线属性，使用setp（）函数设置"><a href="#获得线属性，使用setp（）函数设置" class="headerlink" title="获得线属性，使用setp（）函数设置"></a>获得线属性，使用setp（）函数设置</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python">x <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span>y <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">]</span>lines <span class="token operator">=</span> plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>plt<span class="token punctuation">.</span>setp<span class="token punctuation">(</span>lines<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'r'</span><span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>​    <img src="C:\Users\乔彬\AppData\Roaming\Typora\typora-user-images\image-20230323172637726.png" alt="image-20230323172637726"></p><h1 id="五、patches"><a href="#五、patches" class="headerlink" title="五、patches"></a>五、patches</h1><ul><li>matplotlib.patches.Patch类是二维图形类，并且它是众多二维图形的父类</li><li>本小节重点讲述三种最常见的子类，矩形，多边形和楔型。</li></ul><h2 id="Rectangle-矩形"><a href="#Rectangle-矩形" class="headerlink" title="Rectangle-矩形"></a>Rectangle-矩形</h2><h3 id="hist-直方图"><a href="#hist-直方图" class="headerlink" title="hist-直方图"></a>hist-直方图</h3><p>常用的参数：</p><ul><li>x: 数据集，最终的直方图将对数据集进行统计</li><li>bins: 统计的区间分布</li><li>range: tuple, 显示的区间，range在没有给出bins时生效</li><li>density: bool，默认为false，显示的是频数统计结果，为True则显示频率统计结果，这里需要注意，频率统计结果=区间数目/(总数*区间宽度)，和normed效果一致，官方推荐使用density</li><li>histtype: 可选{‘bar’, ‘barstacked’, ‘step’, ‘stepfilled’}之一，默认为bar，推荐使用默认配置，step使用的是梯状，stepfilled则会对梯状内部进行填充，效果与bar类似</li><li>align: 可选{‘left’, ‘mid’, ‘right’}之一，默认为’mid’，控制柱状图的水平分布，left或者right，会有部分空白区域，推荐使用默认</li><li>log: bool，默认False,即y坐标轴是否选择指数刻度</li><li>stacked: bool，默认为False，是否为堆积状图</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 1.准备数据</span>x<span class="token operator">=</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment">#生成[0-100)之间的100个数据,即 数据集 </span>bins<span class="token operator">=</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">#设置连续的边界值，即直方图的分布区间[0,10),[10,20)... </span><span class="token comment"># 2、创建画布</span>plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>dpi<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token comment"># 3.绘制图形</span>plt<span class="token punctuation">.</span>hist<span class="token punctuation">(</span>x<span class="token punctuation">,</span>bins<span class="token punctuation">,</span>color<span class="token operator">=</span><span class="token string">'y'</span><span class="token punctuation">,</span>alpha<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token comment">#alpha设置透明度，0为完全透明 </span><span class="token comment"># 4.修改描述标题</span>plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'scores'</span><span class="token punctuation">)</span> plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">)</span> plt<span class="token punctuation">.</span>xlim<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">#设置x轴分布范围 </span><span class="token comment"># 5.显示图像</span>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="C:\Users\乔彬\AppData\Roaming\Typora\typora-user-images\image-20230323172648966.png" alt="image-20230323172648966"></p><h3 id="bar-柱状图"><a href="#bar-柱状图" class="headerlink" title="bar-柱状图"></a>bar-柱状图</h3><p>常用的参数：</p><ul><li>left：x轴的位置序列，一般采用range函数产生一个序列，但是有时候可以是字符串</li><li>height：y轴的数值序列，也就是柱形图的高度，一般就是我们需要展示的数据；</li><li>alpha：透明度，值越小越透明</li><li>width：为柱形图的宽度，一般这是为0.8即可；</li><li>color或facecolor：柱形图填充的颜色；</li><li>edgecolor：图形边缘颜色</li><li>label：解释每个图像代表的含义，这个参数是为legend()函数做铺垫的，表示该次bar的标签</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 1.准备数据</span>x<span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>y<span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">)</span> <span class="token comment"># 2、创建画布</span>plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>dpi<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token comment"># 3.绘制图形</span>plt<span class="token punctuation">.</span>bar<span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>color<span class="token operator">=</span><span class="token string">'y'</span><span class="token punctuation">,</span> edgecolor<span class="token operator">=</span><span class="token string">'red'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'The First Bar'</span><span class="token punctuation">,</span> lw<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token comment"># 4.修改描述标题</span>plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'scores'</span><span class="token punctuation">)</span> plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">)</span> plt<span class="token punctuation">.</span>xlim<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">#设置x轴分布范围 </span><span class="token comment"># 5.显示图像</span>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="C:\Users\乔彬\AppData\Roaming\Typora\typora-user-images\image-20230323172700361.png" alt="image-20230323172700361"></p><h2 id="Polygon-多边形（填充多边形）"><a href="#Polygon-多边形（填充多边形）" class="headerlink" title="Polygon-多边形（填充多边形）"></a>Polygon-多边形（填充多边形）</h2><p>matplotlib.patches.Polygon类中常用的是fill类，它是基于xy绘制一个填充的多边形，它的定义：</p><p><code>matplotlib.pyplot.fill(args, data=None, *kwargs)</code></p><ul><li>参数说明 : 关于x、y和color的序列，其中color是可选的参数，每个多边形都是由其节点的x和y位置列表定义的，后面可以选择一个颜色说明符。您可以通过提供多个x、y、[颜色]组来绘制多个多边形。</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 用fill来绘制图形</span><span class="token comment"># 1、准备数据</span>x <span class="token operator">=</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>pi<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span> y1 <span class="token operator">=</span> np<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>x<span class="token punctuation">)</span>y2 <span class="token operator">=</span> np<span class="token punctuation">.</span>sin<span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> x<span class="token punctuation">)</span> <span class="token comment"># 2、绘制画布</span>plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dpi<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token comment"># 3、绘制图形</span>plt<span class="token punctuation">.</span>fill<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> color <span class="token operator">=</span> <span class="token string">"g"</span><span class="token punctuation">,</span> alpha <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment"># 4、显示图形</span>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="C:\Users\乔彬\AppData\Roaming\Typora\typora-user-images\image-20230323172710705.png" alt="image-20230323172710705"></p><h2 id="Wedge-契形-饼图）"><a href="#Wedge-契形-饼图）" class="headerlink" title="Wedge-契形(饼图）"></a>Wedge-契形(饼图）</h2><p>wedge中比较常见的是绘制饼状图。<br>制作数据x的饼图，每个楔子的面积用x/sum(x)表示。<br>其中最主要的参数是前4个：</p><ul><li>x：契型的形状，一维数组。</li><li>explode：如果不是等于None，则是一个len(x)数组，它指定用于偏移每个楔形块的半径的分数。</li><li>labels：用于指定每个契型块的标记，取值是列表或为None。</li><li>colors：饼图循环使用的颜色序列。如果取值为None，将使用当前活动循环中的颜色。</li><li>startangle：饼状图开始的绘制的角度。</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 1、准备数据</span>labels<span class="token operator">=</span><span class="token string">"Frogs"</span><span class="token punctuation">,</span><span class="token string">"hogs"</span><span class="token punctuation">,</span><span class="token string">"dogs"</span><span class="token punctuation">,</span><span class="token string">"logs"</span>sizes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">]</span>explode<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment"># 2、准备画布</span>plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>dpi<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token comment"># 3、绘制图形</span>plt<span class="token punctuation">.</span>pie<span class="token punctuation">(</span>sizes<span class="token punctuation">,</span>explode<span class="token operator">=</span>explode<span class="token punctuation">,</span>labels<span class="token operator">=</span>labels<span class="token punctuation">,</span>autopct<span class="token operator">=</span><span class="token string">"%1.1f%%"</span><span class="token punctuation">,</span>shadow<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>startangle<span class="token operator">=</span><span class="token number">90</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'equal'</span><span class="token punctuation">)</span>  <span class="token comment"># 等宽高比确保饼图绘制为圆形</span><span class="token comment"># 4、显示图片</span>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="C:\Users\乔彬\AppData\Roaming\Typora\typora-user-images\image-20230323172722479.png" alt="image-20230323172722479"></p><p>​    </p><h1 id="六、collections（代表：散点图）"><a href="#六、collections（代表：散点图）" class="headerlink" title="六、collections（代表：散点图）"></a>六、collections（代表：散点图）</h1><p>collections类是用来绘制一组对象的集合，collections有许多不同的子类，如RegularPolyCollection, CircleCollection, Pathcollection, 分别对应不同的集合子类型。其中比较常用的就是散点图，它是属于PathCollection子类，scatter方法提供了该类的封装，根据x与y绘制不同大小或颜色标记的散点图。 它的构造方法：</p><p>Axes.scatter(self, x, y, s=None, c=None, marker=None, cmap=None, norm=None, vmin=None, vmax=None, alpha=None, linewidths=None, verts=, edgecolors=None, , plotnonfinite=False, data=None, *kwargs)</p><p>其中最主要的参数是前5个：</p><ul><li>x：数据点x轴的位置</li><li>y：数据点y轴的位置</li><li>s：尺寸大小</li><li>c：可以是单个颜色格式的字符串，也可以是一系列颜色</li><li>marker: 标记的类型</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 1、准备数据</span>x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">]</span> y <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>  l<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span>        <span class="token comment"># 标签（类别）</span>s <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">**</span>n <span class="token keyword">for</span> n <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment"># 2、准备画布</span>plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dpi<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token comment"># 3、绘制散点图</span>plt<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>s<span class="token operator">=</span>s<span class="token punctuation">,</span>c<span class="token operator">=</span>l<span class="token punctuation">,</span>cmap<span class="token operator">=</span>plt<span class="token punctuation">.</span>cm<span class="token punctuation">.</span>rainbow<span class="token punctuation">)</span><span class="token comment"># 4、显示散点图</span>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="C:\Users\乔彬\AppData\Roaming\Typora\typora-user-images\image-20230323172732311.png" alt="image-20230323172732311"></p><h1 id="七、images-代表：热图）"><a href="#七、images-代表：热图）" class="headerlink" title="七、images(代表：热图）"></a>七、images(代表：热图）</h1><p>imshow根据数组绘制图像</p><p><code>matplotlib.pyplot.imshow(X, cmap=None, norm=None, aspect=None, interpolation=None, alpha=None, vmin=None, vmax=None, origin=None, extent=None, shape=, filternorm=1, filterrad=4.0, imlim=, resample=None, url=None, , data=None, *kwargs）</code></p><ul><li>使用imshow画图时首先需要传入一个数组，数组对应的是空间内的像素位置和像素点的值，interpolation参数可以设置不同的差值方法，具体效果如下。</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 1、准备数据</span>methods <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'none'</span><span class="token punctuation">,</span> <span class="token string">'nearest'</span><span class="token punctuation">,</span> <span class="token string">'bilinear'</span><span class="token punctuation">,</span> <span class="token string">'bicubic'</span><span class="token punctuation">,</span> <span class="token string">'spline16'</span><span class="token punctuation">,</span>           <span class="token string">'spline36'</span><span class="token punctuation">,</span> <span class="token string">'hanning'</span><span class="token punctuation">,</span> <span class="token string">'hamming'</span><span class="token punctuation">,</span> <span class="token string">'hermite'</span><span class="token punctuation">,</span> <span class="token string">'kaiser'</span><span class="token punctuation">,</span> <span class="token string">'quadric'</span><span class="token punctuation">,</span>           <span class="token string">'catrom'</span><span class="token punctuation">,</span> <span class="token string">'gaussian'</span><span class="token punctuation">,</span> <span class="token string">'bessel'</span><span class="token punctuation">,</span> <span class="token string">'mitchell'</span><span class="token punctuation">,</span> <span class="token string">'sinc'</span><span class="token punctuation">,</span> <span class="token string">'lanczos'</span><span class="token punctuation">]</span>   <span class="token comment"># 插值方法</span>x<span class="token operator">=</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token comment"># 2、准备画布</span>fig<span class="token punctuation">,</span>axs<span class="token operator">=</span>plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span>nrows<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>ncols<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>dpi<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token comment"># 3、绘制不同插值方法下的热图</span><span class="token keyword">for</span> ax<span class="token punctuation">,</span> method <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>axs<span class="token punctuation">.</span>flat<span class="token punctuation">,</span>methods<span class="token punctuation">)</span><span class="token punctuation">:</span>    ax<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>x<span class="token punctuation">,</span>interpolation<span class="token operator">=</span>method<span class="token punctuation">,</span>cmap<span class="token operator">=</span><span class="token string">'rainbow'</span><span class="token punctuation">)</span>    ax<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 自动调节plt.subplot的间距</span><span class="token comment"># 4、显示热图</span>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>​<br><img src="C:\Users\乔彬\AppData\Roaming\Typora\typora-user-images\image-20230323172741946.png" alt="image-20230323172741946"></p>]]></content>
      
      
      <categories>
          
          <category> 数据分析 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据分析 </tag>
            
            <tag> 数据挖掘 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>爬虫学习</title>
      <link href="/2023/03/23/pa-chong-xue-xi/"/>
      <url>/2023/03/23/pa-chong-xue-xi/</url>
      
        <content type="html"><![CDATA[<h2 id="一、小试牛刀"><a href="#一、小试牛刀" class="headerlink" title="一、小试牛刀"></a>一、小试牛刀</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 用程序模拟浏览器，输入一个网址，从该网址获取资源</span><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>request <span class="token keyword">import</span> urlopenurl<span class="token operator">=</span> <span class="token string">"http://www.baidu.com"</span>resp<span class="token operator">=</span>urlopen<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>         <span class="token comment"># 读取url并解码</span><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"mybaidu.html"</span><span class="token punctuation">,</span>mode<span class="token operator">=</span><span class="token string">"w"</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>resp<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 写入读取的网页源代码,生成html文件</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"over"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="二、web请求过程剖析"><a href="#二、web请求过程剖析" class="headerlink" title="二、web请求过程剖析"></a>二、web请求过程剖析</h2><ol><li>服务器渲染：在服务器那边直接把数据和html整合在一起，统一返回给浏览器。<br>特点：在页面源代码中能看到数据</li><li>客户端渲染：<br>第一次请求只返回一个html框架，第二次请求获取数据，进行数据展示<br>特点：在页面源代码中，看不到数据</li><li>注：要熟练使用浏览器抓包工具（F12）</li></ol><h2 id="三、Http协议（超文本传输协议）"><a href="#三、Http协议（超文本传输协议）" class="headerlink" title="三、Http协议（超文本传输协议）"></a>三、Http协议（超文本传输协议）</h2><p>协议：为了沟通订制的规则，比如上下位机，不同的电脑端<br>Http协议把一条消息分为三大块（请求-3块，响应-3块）<br><strong>请求：</strong><br>请求行 -&gt; 请求方式（get/post）请求url地址协议<br>请求头 -&gt; 放一些服务器要使用的附加信息<br>请求体 -&gt; 一般放一些请求参数<br><strong>响应：</strong><br>状态行 -&gt; 协议 状态码<br>响应头 -&gt; 放一些客户端要使用的一些附加信息<br>响应体 -&gt; 服务器返回的真正客户端要用的内容（json\html)等<br><strong>请求头中最常见的一些重要内容（爬虫需要）：</strong><br>User-Agent:请求载体的身份标识（用啥发送的请求）<br>Referer:防盗链（这个请求从哪里来的）<br>cookie：本地字符串数据信息（用户登录信息、反爬的token）<br><strong>响应头中一些重要内容：</strong><br>cookie：本地字符串信息（用户登录信息、反爬的token）<br>各种神奇的字符串<br><strong>请求方式：</strong><br>GET：显式提交<br>POST:隐式提交</p>]]></content>
      
      
      <categories>
          
          <category> 数据分析 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据分析 </tag>
            
            <tag> 数据挖掘 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>菜鸟NumPy</title>
      <link href="/2023/03/23/cai-niao-numpy/"/>
      <url>/2023/03/23/cai-niao-numpy/</url>
      
        <content type="html"><![CDATA[<h2 id="一、Ndarray对象"><a href="#一、Ndarray对象" class="headerlink" title="一、Ndarray对象"></a>一、Ndarray对象</h2><p><strong>NumPy 最重要的一个特点是其 N 维数组对象 ndarray，它是一系列同类型数据的集合，以 0 下标为开始进行集合中元素的索引。</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token comment"># 语法</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>copy<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>order <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span> subok <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span> ndmin <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment"># 实例</span>a<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># 二维数组</span>b<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ndmin <span class="token operator">=</span>  <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 最小维度[[1 2 3 4 5]]</span>c <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype <span class="token operator">=</span> <span class="token builtin">complex</span><span class="token punctuation">)</span> <span class="token comment"># 数组元素数据类型 [1.+0.j 2.+0.j 3.+0.j]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="二、数组属性"><a href="#二、数组属性" class="headerlink" title="二、数组属性"></a>二、数组属性</h2><p><strong>2.1 Numpy基本类型</strong></p><ul><li>有符号整型 int8、int16、int32、int64</li><li>无符号整型 uint8、uint16、uint32、uint64</li><li>浮点数 float16、float32、float64</li><li>复数 complex64、complex128<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token comment"># 1、ndarray.ndim 用于返回数组的维数</span>a <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span> <span class="token comment"># [0,1,....,23]</span><span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>ndim<span class="token punctuation">)</span>   <span class="token comment"># 维度为1</span><span class="token comment"># 2、ndarray.shape 用于返回数组的形状</span><span class="token keyword">print</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>  <span class="token comment"># (24,1)</span><span class="token comment"># 3、ndarray.itemsize 以字节的形式返回数组中每一个元素的大小。</span><span class="token comment"># 数组的 dtype 为 int8（一个字节）</span>a <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype <span class="token operator">=</span> np<span class="token punctuation">.</span>int8<span class="token punctuation">)</span> <span class="token keyword">print</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>itemsize<span class="token punctuation">)</span> <span class="token comment"># 1</span><span class="token comment"># 3、ndarray.dtype 用于返回数组元素的类型</span><span class="token keyword">print</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>    <span class="token comment"># int8</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="三、创建数组"><a href="#三、创建数组" class="headerlink" title="三、创建数组"></a>三、创建数组</h2><h3 id="3-1-简单创建数组"><a href="#3-1-简单创建数组" class="headerlink" title="3.1 简单创建数组"></a>3.1 简单创建数组</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token comment"># 1、np.empty(object,dtype) 创建一个3行2列随机数组</span>x <span class="token operator">=</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token comment"># [[0, 0],</span><span class="token comment">#  [0, 0],</span><span class="token comment">#  [0, 0]]</span><span class="token comment"># 2、创建指定大小的数组，数组元素以 0 来填充：</span>np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">)</span><span class="token comment"># 3、 创建指定形状的数组，数组元素以 1 来填充</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-2、numpy从已有的数组创建数组"><a href="#3-2、numpy从已有的数组创建数组" class="headerlink" title="3.2、numpy从已有的数组创建数组"></a>3.2、numpy从已有的数组创建数组</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np x <span class="token operator">=</span>  <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">]</span> a <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>x<span class="token punctuation">,</span> dtype <span class="token operator">=</span>  <span class="token builtin">float</span><span class="token punctuation">)</span>  <span class="token keyword">print</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-3、NumPy-从数值范围创建数组"><a href="#3-3、NumPy-从数值范围创建数组" class="headerlink" title="3.3、NumPy 从数值范围创建数组"></a>3.3、NumPy 从数值范围创建数组</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 1、语法：</span>numpy<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>start<span class="token punctuation">,</span> stop<span class="token punctuation">,</span> step<span class="token punctuation">,</span> dtype<span class="token punctuation">)</span><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np x<span class="token operator">=</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># [10  12  14  16  18]</span><span class="token comment"># 2、语法：numpy.linspace 创建等差数列</span>np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span>start<span class="token punctuation">,</span> stop<span class="token punctuation">,</span> num<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>a <span class="token operator">=</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment"># [10. 12. 14. 16. 18.]</span><span class="token comment"># 3、numpy.logspace 函数用于创建一个于等比数列</span>np<span class="token punctuation">.</span>logspace<span class="token punctuation">(</span>start<span class="token punctuation">,</span> stop<span class="token punctuation">,</span> num<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> endpoint<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> base<span class="token operator">=</span><span class="token number">10.0</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>a <span class="token operator">=</span> np<span class="token punctuation">.</span>logspace<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span>  <span class="token number">2.0</span><span class="token punctuation">,</span> num <span class="token operator">=</span>  <span class="token number">10</span><span class="token punctuation">)</span>  <span class="token comment"># [ 10.           12.91549665     16.68100537      21.5443469  27.82559402      </span><span class="token comment">#  35.93813664   46.41588834     59.94842503      77.42636827    100.    ]</span><span class="token comment"># lg10=1,lg100=2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="四、切片和索引"><a href="#四、切片和索引" class="headerlink" title="四、切片和索引"></a>四、切片和索引</h2><ul><li>ndarray对象的内容可以通过索引或切片来访问和修改，与 Python 中 list 的切片操作一样。</li><li>ndarray 数组可以基于 0 - n 的下标进行索引，切片对象可以通过内置的 slice 函数，并设置 start, stop 及 step 参数进行，从原数组中切割出一个新数组。<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token comment"># 基础索引</span>a <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>b <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span>   <span class="token comment"># 从索引 2 开始到索引 7 停止，间隔为 2</span><span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>   <span class="token comment"># 6</span><span class="token comment"># 获取数组中 (0,0)，(1,1) 和 (2,0) 位置处的元素</span>y <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token keyword">print</span> <span class="token punctuation">(</span>y<span class="token punctuation">)</span>   <span class="token comment"># [1,4,4]</span><span class="token comment"># 布尔索引</span>c<span class="token operator">=</span>a<span class="token punctuation">[</span>a<span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token keyword">print</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>  <span class="token comment"># 大于2的元素是[3 3 4 5 4 5 6]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="五、过滤"><a href="#五、过滤" class="headerlink" title="五、过滤"></a>五、过滤</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np <span class="token comment"># 1、过滤 NaN</span>a <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>nan<span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span>nan<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token keyword">print</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>np<span class="token punctuation">.</span>isnan<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>     <span class="token comment"># [nan nan]</span><span class="token keyword">print</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token operator">~</span>np<span class="token punctuation">.</span>isnan<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment"># [ 1.   2.   3.   4.   5.]</span><span class="token comment"># 2、过滤复数元素</span>a <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">2</span><span class="token operator">+</span><span class="token number">6j</span><span class="token punctuation">,</span>  <span class="token number">5</span><span class="token punctuation">,</span>  <span class="token number">3.5</span><span class="token operator">+</span><span class="token number">5j</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token keyword">print</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>np<span class="token punctuation">.</span>iscomplex<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [2.0+6.j  3.5+5.j]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="六、NumPy-广播-Broadcast"><a href="#六、NumPy-广播-Broadcast" class="headerlink" title="六、NumPy 广播(Broadcast)"></a>六、NumPy 广播(Broadcast)</h2><p>对两个数组，分别比较他们的每一个维度</p><ul><li>数组拥有相同形状</li><li>当前维度的值相等，另一维度的值是 1<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 1、两个数组拥有相同形状</span><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np a <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> b <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">)</span> c <span class="token operator">=</span> a <span class="token operator">*</span> b  <span class="token comment">#[10,40,90,160]</span><span class="token keyword">print</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token comment"># 2、当前维度的值相等，另一维度的值是 1</span>a <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> b <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">)</span> c <span class="token operator">=</span> a <span class="token operator">*</span> b <span class="token keyword">print</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>  <span class="token comment">#[[10,40,90,160],[20,60,120,200]]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="七、NumPy-迭代数组"><a href="#七、NumPy-迭代数组" class="headerlink" title="七、NumPy 迭代数组"></a>七、NumPy 迭代数组</h2><p>numpy.nditer 提供了一种灵活访问一个或者多个数组元素的方式。<br>ndarray.flat 是一个数组元素迭代器</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> npa <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token keyword">for</span> x <span class="token keyword">in</span> np<span class="token punctuation">.</span>nditer<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">","</span> <span class="token punctuation">)</span> <span class="token comment"># 0,1,2,3,4,5,</span><span class="token keyword">for</span> element <span class="token keyword">in</span> a<span class="token punctuation">.</span>flat<span class="token punctuation">:</span>    <span class="token keyword">print</span> <span class="token punctuation">(</span>element<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">","</span> <span class="token punctuation">)</span><span class="token comment"># 0,1,2,3,4,5,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="八、Numpy-数组操作"><a href="#八、Numpy-数组操作" class="headerlink" title="八、Numpy 数组操作"></a>八、Numpy 数组操作</h2><h3 id="8-1-修改数组形状"><a href="#8-1-修改数组形状" class="headerlink" title="8.1 修改数组形状"></a>8.1 修改数组形状</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> npa <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token comment"># 1、ndarray.reshape(newshape, order='C')</span>b <span class="token operator">=</span> a<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># 2、ndarray.flatten(order='C') 变平</span>c <span class="token operator">=</span> a<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span>order<span class="token operator">=</span><span class="token string">'C'</span><span class="token punctuation">)</span>  order：<span class="token string">'C'</span> <span class="token operator">-</span><span class="token operator">-</span> 按行，<span class="token string">'F'</span> <span class="token operator">-</span><span class="token operator">-</span> 按列<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="8-2-翻转数组"><a href="#8-2-翻转数组" class="headerlink" title="8.2 翻转数组"></a>8.2 翻转数组</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token comment"># 1、numpy.transpose(arr, axes)</span>a <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 2、ndarray.T </span><span class="token keyword">print</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>T<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="8-3-修改数组维度"><a href="#8-3-修改数组维度" class="headerlink" title="8.3 修改数组维度"></a>8.3 修改数组维度</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> npa <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>   <span class="token comment"># [[0 1 2 3]]</span><span class="token comment"># 1、np.broadcast_to(array, shape) 数组广播到新形状</span>y<span class="token operator">=</span>np<span class="token punctuation">.</span>broadcast_to<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token comment"># 数组广播到新形状</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token comment"># 2、numpy.expand_dims(arr, axis) 扩充形状</span>z <span class="token operator">=</span> np<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>y<span class="token punctuation">,</span> axis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">#shape(1,4,4)</span><span class="token comment"># 3、numpy.squeeze(arr, axis)  删除一维的条目</span>l <span class="token operator">=</span> np<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>z<span class="token punctuation">)</span>  <span class="token comment"># shape(4,4)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="8-4-连接数组"><a href="#8-4-连接数组" class="headerlink" title="8.4 连接数组"></a>8.4 连接数组</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 1、numpy.concatenate((a1, a2, ...), axis)</span><span class="token keyword">import</span> numpy <span class="token keyword">as</span> npa <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment">#(3,2)</span>b <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">#(3,2)</span><span class="token comment"># 沿轴 0 连接两个数组</span>c1 <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">#(6,2)</span><span class="token comment"># 沿轴 1 连接两个数组</span>c2 <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#(3,4)</span><span class="token comment"># 2、numpy.stack(arrays, axis)</span><span class="token comment"># 沿轴 0 堆叠两个数组</span>d1<span class="token operator">=</span>np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">#(2,3,2)</span><span class="token comment"># 沿轴 1 堆叠两个数组</span>d2<span class="token operator">=</span>np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#(3,2,2)</span><span class="token comment"># 3、numpy.vstack(arrays)</span><span class="token comment"># 沿轴 0 连接两个数组(竖直堆叠)</span>e1<span class="token operator">=</span>np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>       <span class="token comment">#(6,2)</span><span class="token comment"># 4、numpy.hstack(arrays)</span><span class="token comment"># 沿轴 1 连接两个数组(水平堆叠)</span>e2<span class="token operator">=</span>np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>       <span class="token comment">#(3,4)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="8-5-分割数组"><a href="#8-5-分割数组" class="headerlink" title="8.5 分割数组"></a>8.5 分割数组</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 1、numpy.split(array, indices_or_sections, axis)</span><span class="token keyword">import</span> numpy <span class="token keyword">as</span> npa<span class="token operator">=</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment"># 沿轴 0 分割一个数组(竖直分割)</span>l1<span class="token punctuation">,</span>l2<span class="token operator">=</span>np<span class="token punctuation">.</span>vsplit<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>       <span class="token comment">#(2,4)</span>b1<span class="token punctuation">,</span>b2<span class="token operator">=</span>np<span class="token punctuation">.</span>split<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">#(2,4)</span><span class="token comment"># 沿轴 1分割一个数组(水平分割)</span>d1<span class="token punctuation">,</span>d2<span class="token operator">=</span>np<span class="token punctuation">.</span>hsplit<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>       <span class="token comment">#(4,2)</span>c1<span class="token punctuation">,</span>c2<span class="token operator">=</span>np<span class="token punctuation">.</span>split<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#(4,2)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="8-6数组元素添加与删除"><a href="#8-6数组元素添加与删除" class="headerlink" title="8.6数组元素添加与删除"></a>8.6数组元素添加与删除</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 1、返回指定形状的新数组-numpy.resize(arr, shape) </span><span class="token keyword">import</span> numpy <span class="token keyword">as</span> npa<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">#(2,3)</span>b1<span class="token operator">=</span>np<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">#(3,2)</span>b2<span class="token operator">=</span>np<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#(3,2)</span><span class="token comment">#[[1,2],[3,4],[5,6]]</span><span class="token comment"># 2、函数在数组的末尾添加值-numpy.append(arr, values, axis=None)</span>c1<span class="token operator">=</span>np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">#[1, 2, 3, 4, 5, 6, 7, 8, 9]</span><span class="token comment"># 沿轴 0 添加元素</span>c2<span class="token operator">=</span>np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">#(1,3)--&gt;(3,3)</span><span class="token comment"># 沿轴 1 添加元素</span>c3<span class="token operator">=</span>np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#(2,1)--&gt;(2,4)</span><span class="token comment"># 3、沿指定轴将值插入到指定下标之前-numpy.insert(arr, obj, values, axis)</span>d1<span class="token operator">=</span>np<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [ 1,  2,  3, 11, 12,  4,  5,  6]</span><span class="token comment"># 沿轴 0 添加元素</span>d2<span class="token operator">=</span>np<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">#(3,3)</span><span class="token comment"># [[ 1,  2,  3],[11, 11, 11],[ 4,  5,  6]]</span><span class="token comment"># 沿轴 1 添加元素</span>d3<span class="token operator">=</span>np<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#(2,4)</span><span class="token comment"># 4、删掉某个轴的子数组，并返回删除后的新数组Numpy.delete(arr, obj, axis)</span>e1<span class="token operator">=</span>np<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>  <span class="token comment"># [1, 2, 3, 4, 6]</span><span class="token comment"># 沿轴 0 删除元素</span>e2<span class="token operator">=</span>np<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">#(1,3) [[1, 2, 3]]</span><span class="token comment"># 沿轴 1 删除元素</span>e3<span class="token operator">=</span>np<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#(2,2) [[1,3],[4,6]]</span><span class="token comment"># 沿切片删除元素</span>e4<span class="token operator">=</span>np<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>a<span class="token punctuation">,</span>np<span class="token punctuation">.</span>s_<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [2, 4, 6]</span><span class="token comment"># 5、去除数组中的重复元素-numpy.unique(arr, return_index, return_inverse, return_counts)</span>a<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">]</span>f1<span class="token operator">=</span>np<span class="token punctuation">.</span>unique<span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment"># [11, 12]</span><span class="token comment"># 得到去重数组的原数组下标</span>f2<span class="token punctuation">,</span>id1<span class="token operator">=</span>np<span class="token punctuation">.</span>unique<span class="token punctuation">(</span>a<span class="token punctuation">,</span>return_index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># [0, 3]</span><span class="token comment"># 得到去重数组后的原数组下标</span>f3<span class="token punctuation">,</span>id2<span class="token operator">=</span>np<span class="token punctuation">.</span>unique<span class="token punctuation">(</span>a<span class="token punctuation">,</span>return_inverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># [0, 0, 0, 1, 1, 1]</span><span class="token comment"># 使用下标重构原数组</span>a1<span class="token operator">=</span>f3<span class="token punctuation">[</span>id2<span class="token punctuation">]</span> <span class="token comment"># [11, 11, 11, 12, 12, 12]</span><span class="token comment"># 返回去重元素的重复数量</span>f4<span class="token punctuation">,</span>id3<span class="token operator">=</span>np<span class="token punctuation">.</span>unique<span class="token punctuation">(</span>a<span class="token punctuation">,</span>return_counts<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># [11, 12] --&gt; [3, 3]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 数据分析 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据分析 </tag>
            
            <tag> 数据挖掘 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pytorch实现的loss function</title>
      <link href="/2023/03/21/pytorch-shi-xian-de-loss-function/"/>
      <url>/2023/03/21/pytorch-shi-xian-de-loss-function/</url>
      
        <content type="html"><![CDATA[<p>神经网络主要实现<strong>分类以及回归预测</strong>两类问题</p><p>对于分类，主要讲述<strong>二分类交叉熵和多分类交叉熵函数</strong>,对于回归问题，主要讲述<strong>均方损失函数</strong>，而对于一些回归问题，需要根据特殊情况<strong>自定义损失函数</strong>。</p><p>1、所有的loss的基类是Module，所以使用loss的方法是：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 1. 创建损失函数对象,并指定返回结果，默认为：平均值 以MSE为例</span>criterion <span class="token operator">=</span> MSELoss<span class="token punctuation">(</span>reduction<span class="token operator">=</span><span class="token string">'...'</span><span class="token punctuation">)</span><span class="token comment"># 2.  定义input x, traget y</span>x <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> y <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token comment"># 计算损失函数</span>loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>参数：</strong></p><p>reduction (string, optional）</p><ul><li>‘none’: 不进行数据降维，输出为向量</li><li>‘elementwise_mean’： 将向量中的数累加求和，然后除以元素数量，返回<strong>误差的平均值</strong></li><li>‘sum’： 返回向量的<strong>误差值的和</strong></li></ul><h2 id="1-均方损失函数"><a href="#1-均方损失函数" class="headerlink" title="1.均方损失函数"></a>1.均方损失函数</h2><p> <code>1、class torch.nn.MSELoss(reduction='elementwise_mean') </code> 默认返回<strong>误差的平均值</strong></p><p>计算输入x和标签y，n个元素平均平方误差（mean square error），x和y具有相同的Size，<strong>损失函数</strong>如下定义：<br><img src="https://img-blog.csdnimg.cn/9439f3310e084e338390d3606bbafbc1.png" alt="在这里插入图片描述"><br>如果reduction != ‘none’:<br><img src="https://img-blog.csdnimg.cn/3d65830d99214cbdbfbf79441b6a78ca.png" alt="在这里插入图片描述"></p><p>通过代码来看一基本用法，以及reduction参数对返回结果的影响：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token keyword">from</span> torch <span class="token keyword">import</span> nncriterion_none <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span> reduction<span class="token operator">=</span><span class="token string">'none'</span><span class="token punctuation">)</span>criterion_elementwise_mean <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span>reduction<span class="token operator">=</span><span class="token string">'elementwise_mean'</span><span class="token punctuation">)</span> criterion_sum <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span>reduction<span class="token operator">=</span><span class="token string">'sum'</span><span class="token punctuation">)</span>x <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>y <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>loss_none <span class="token operator">=</span> criterion_none<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>loss_elementwise_mean <span class="token operator">=</span> criterion_elementwise_mean<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>loss_sum <span class="token operator">=</span> criterion_sum<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y <span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'reduction={}:   {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">'none'</span><span class="token punctuation">,</span> loss_none<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'reduction={}:   {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">'elementwise_mean'</span><span class="token punctuation">,</span> loss_elementwise_mean<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'reduction={}:   {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">'sum'</span><span class="token punctuation">,</span> loss_sum<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#%% 结果</span>reduction<span class="token operator">=</span>none<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0.02320575</span> <span class="token number">0.30483633</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0.04768182</span> <span class="token number">0.4319028</span> <span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3.11864</span> <span class="token number">7.9872203</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>reduction<span class="token operator">=</span>elementwise_mean<span class="token punctuation">:</span> <span class="token number">1.9855811595916748</span> <span class="token comment"># 1.9 * 6 = 11.4</span>reduction<span class="token operator">=</span><span class="token builtin">sum</span><span class="token punctuation">:</span> <span class="token number">11.913487434387207</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-交叉熵损失函数"><a href="#2-交叉熵损失函数" class="headerlink" title="2. 交叉熵损失函数"></a>2. 交叉熵损失函数</h2><p><strong>如果目标值是onehot形式，那该函数之前先计算Sigmoid值\softmax值</strong></p><p><img src="https://img-blog.csdnimg.cn/7b0c2ed5a71c4f06896a3d9d90b89b7a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP55m95a2m5Lmg6K6w5b2V,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p><p>该博客讲述了交叉熵的定义以及为何使用交叉熵，对交叉熵不是很了解的可以看一下：<br><a href="http://jackon.me/posts/why-use-cross-entropy-error-for-loss-function/">http://jackon.me/posts/why-use-cross-entropy-error-for-loss-function/</a></p><p><code>2、class torch.nn.BCELoss(weight=None, reduction='elementwise_mean')</code></p><ul><li><p>shape: N 为一批数据的数量</p></li><li><p>input： ( N , ∗ ),  意味着任何数量的附加维度<br>Target: (N,∗), shape与input相同</p></li></ul><p>二分类的交叉熵函数。<strong>使用该函数之前先计算Sigmoid值</strong>。</p><p>损失函数表达式如下：<br><img src="https://img-blog.csdnimg.cn/8ad0481e102c49a4a3371c21282f4f52.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP55m95a2m5Lmg6K6w5b2V,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token keyword">from</span> torch <span class="token keyword">import</span> nnm <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>BCELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>x <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token comment"># random_(from=0, to): 按均匀分布从[from, to -1]内去出离散整数值</span><span class="token comment"># 将y取0或1</span>y <span class="token operator">=</span> torch<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>random_<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token comment"># 在计算前线计算x的sigmoid值</span>loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>m<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#%% result</span><span class="token number">0.8146645426750183</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> <code>3、class torch.nn.CrossEntropyLoss(weight=None, size_average=None, ignore_index=-100, reduce=None, reduction='elementwise_mean')</code></p><p><strong>在使用该函数前不需要经过softmax计算， target不是one_hot编码格式</strong></p><ul><li><p>shape: N是一批数据的数量</p></li><li><p>input: (N, C): C是类的数量<br>(N,C,d1,d2,…,dK) with K≥2 in the case of K-dimensional loss.<br>Target： (N), 0≤targets[i]≤C−1,为每个样本的类别。<br>(N,d1,d2,…,dK) with K≥2 in the case of K-dimensional loss<br>Output: (N), (N, d1,d2,…,dK)</p></li></ul><p>loss表达式：<br><img src="https://img-blog.csdnimg.cn/6607eaf5ed9d4316b2d5eb2972264720.png" alt="在这里插入图片描述"></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token keyword">from</span> torch <span class="token keyword">import</span> nncriterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>x <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token comment"># random_(from=0, to): 按均匀分布从[from, to -1]内去出离散整数值</span><span class="token comment"># 将y取0或1</span>y <span class="token operator">=</span> torch<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span><span class="token punctuation">.</span>random_<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token comment"># 在计算前线计算x的sigmoid值</span>loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#%% result</span><span class="token number">1.887318730354309</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果传给target是one_hot编码格式</p><p>多类的cross-entropy:<br>[0.1, 0.2, 0.7] (prediction) —————— [1.0, 0.0, 0.0] (target)</p><p>则损失函数为： - (1.0 * log(0.1) + 0.0 * log(0.2) + 0.0 * log(0.7))</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn<span class="token keyword">from</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">import</span> functional <span class="token keyword">as</span> Fx <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token comment"># random_(from=0, to): 按均匀分布从[from, to -1]内去出离散整数值</span><span class="token comment"># 将y取0或1</span>y <span class="token operator">=</span> torch<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span><span class="token punctuation">.</span>random_<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">one_hot</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''    y: (N)的一维tensor，值为每个样本的类别    out:         y_onehot: 转换为one_hot 编码格式     '''</span>    y <span class="token operator">=</span> y<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    y_onehot <span class="token operator">=</span> torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>        <span class="token comment"># In your for loop</span>    y_onehot<span class="token punctuation">.</span>zero_<span class="token punctuation">(</span><span class="token punctuation">)</span>    y_onehot<span class="token punctuation">.</span>scatter_<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> y_onehot<span class="token comment"># 1. 自带的函数</span>criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 2.将one_hot解码后使用pytorch自带的cross_entropy</span><span class="token keyword">def</span> <span class="token function">cross_entropy_one_hot</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>    _<span class="token punctuation">,</span> labels <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> F<span class="token punctuation">.</span>cross_entropy<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> labels<span class="token punctuation">)</span>      <span class="token comment"># 也可以使用以下语句</span>    <span class="token comment"># return nn.CrossEntropyLoss()(input, labels)</span><span class="token comment"># 3. 自定义交叉熵函数</span><span class="token keyword">def</span> <span class="token function">cross_entropy</span><span class="token punctuation">(</span>input_<span class="token punctuation">,</span> target<span class="token punctuation">,</span> reduction<span class="token operator">=</span><span class="token string">'elementwise_mean'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">""" Cross entropy that accepts soft targets    Args:         pred: predictions for neural network         targets: targets, can be soft         size_average: if false, sum is returned instead of mean    Examples::        input = torch.FloatTensor([[1.1, 2.8, 1.3], [1.1, 2.1, 4.8]])        input = torch.autograd.Variable(out, requires_grad=True)        target = torch.FloatTensor([[0.05, 0.9, 0.05], [0.05, 0.05, 0.9]])        target = torch.autograd.Variable(y1)        loss = cross_entropy(input, target)        loss.backward()    """</span>    logsoftmax <span class="token operator">=</span> nn<span class="token punctuation">.</span>LogSoftmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>    res  <span class="token operator">=</span><span class="token operator">-</span>target <span class="token operator">*</span> logsoftmax<span class="token punctuation">(</span>input_<span class="token punctuation">)</span>    <span class="token keyword">if</span> reduction <span class="token operator">==</span> <span class="token string">'elementwise_mean'</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">elif</span> reduction <span class="token operator">==</span> <span class="token string">'sum'</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> resloss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"loss"</span><span class="token punctuation">,</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>loss_1 <span class="token operator">=</span> cross_entropy_one_hot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> one_hot<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"loss_one_hot"</span><span class="token punctuation">,</span> loss_1<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>loss_2 <span class="token operator">=</span> cross_entropy<span class="token punctuation">(</span>x<span class="token punctuation">,</span> one_hot<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"loss_custom"</span><span class="token punctuation">,</span> loss_2<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#%%result</span>loss <span class="token number">3.0437448024749756</span>loss_one_hot <span class="token number">3.0437448024749756</span>loss_custom <span class="token number">3.0437448024749756</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3、自定义损失函数"><a href="#3、自定义损失函数" class="headerlink" title="3、自定义损失函数"></a>3、自定义损失函数</h2><h3 id="1、关于nn-Module与nn-Functional的区别"><a href="#1、关于nn-Module与nn-Functional的区别" class="headerlink" title="1、关于nn.Module与nn.Functional的区别"></a>1、关于nn.Module与nn.Functional的区别</h3><p><strong>总结：</strong>简答的说就是， nn.Module是一个包装好的类，具体定义了一个网络层，可以维护状态和存储参数信息；而nn.Functional仅仅提供了一个计算，不会维护状态信息和存储参数。</p><p>对于activation函数，比如（relu， sigmoid等），dropout，pooling等没有训练参数，可以使用functional模块。<strong>两者的相同之处</strong>：</p><ul><li><code>nn.Xxx</code>和<code>nn.functional.xxx</code>的实际功能是相同的，即<code>nn.Conv2d</code>和<code>nn.functional.conv2d</code> 都是进行卷积，<code>nn.Dropout</code> 和<code>nn.functional.dropout</code>都是进行dropout，。。。。。； </li><li>运行效率也是近乎相同。</li></ul><p><strong>两者的不同之处：</strong></p><ul><li><p><code>nn.functional.xxx</code>是函数接口，而<code>nn.Xxx</code>是<code>nn.functional.xxx</code>的类封装，并且**<code>nn.Xxx</code>都继承于一个共同祖先<code>nn.Module</code>。**这一点导致<code>nn.Xxx</code>除了具有<code>nn.functional.xxx</code>功能之外，内部附带了<code>nn.Module</code>相关的属性和方法，例如<code>train(), eval(),load_state_dict, state_dict </code>等。</p></li><li><p><strong>两者的调用方式不同</strong></p><p><code>nn.Xxx</code> 需要先实例化并传入参数，然后以函数调用的方式调用实例化的对象并传入输入数据。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">inputs <span class="token operator">=</span> torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">244</span><span class="token punctuation">,</span> <span class="token number">244</span><span class="token punctuation">)</span>conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>out <span class="token operator">=</span> conv<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><code>nn.functional.xxx</code>同时传入输入数据和weight, bias等其他参数。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">weight <span class="token operator">=</span> torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>bias <span class="token operator">=</span> torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> out <span class="token operator">=</span> nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>conv2d<span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> weight<span class="token punctuation">,</span> bias<span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong><code>nn.Xxx</code>继承于<code>nn.Module</code>， 能够很好的与<code>nn.Sequential</code>结合使用， 而<code>nn.functional.xxx</code>无法与<code>nn.Sequential</code>结合使用。</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python">fm_layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>num_features<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong><code>nn.Xxx</code>不需要你自己定义和管理weight；而<code>nn.functional.xxx</code>需要你自己定义weight，每次调用的时候都需要手动传入weight, 不利于代码复用。</strong></p></li></ul><p>使用<code>nn.Xxx</code>定义一个CNN 。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">CNN</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>CNN<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>cnn1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>  out_channels<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>relu1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>maxpool1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>cnn2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>  padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>relu2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>maxpool2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>linear1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>            <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        out <span class="token operator">=</span> self<span class="token punctuation">.</span>maxpool1<span class="token punctuation">(</span>self<span class="token punctuation">.</span>relu1<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cnn1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        out <span class="token operator">=</span> self<span class="token punctuation">.</span>maxpool2<span class="token punctuation">(</span>self<span class="token punctuation">.</span>relu2<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cnn2<span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        out <span class="token operator">=</span> self<span class="token punctuation">.</span>linear1<span class="token punctuation">(</span>out<span class="token punctuation">.</span>view<span class="token punctuation">(</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> out<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用<code>nn.function.xxx</code>定义一个与上面相同的CNN。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">CNN</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>CNN<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>cnn1_weight <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>bias1_weight <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>cnn2_weight <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>bias2_weight <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>linear1_weight <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>bias3_weight <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        out <span class="token operator">=</span> F<span class="token punctuation">.</span>conv2d<span class="token punctuation">(</span>x<span class="token punctuation">,</span> self<span class="token punctuation">.</span>cnn1_weight<span class="token punctuation">,</span> self<span class="token punctuation">.</span>bias1_weight<span class="token punctuation">)</span>        out <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>out<span class="token punctuation">)</span>        out <span class="token operator">=</span> F<span class="token punctuation">.</span>max_pool2d<span class="token punctuation">(</span>out<span class="token punctuation">)</span>                out <span class="token operator">=</span> F<span class="token punctuation">.</span>conv2d<span class="token punctuation">(</span>x<span class="token punctuation">,</span> self<span class="token punctuation">.</span>cnn2_weight<span class="token punctuation">,</span> self<span class="token punctuation">.</span>bias2_weight<span class="token punctuation">)</span>        out <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>out<span class="token punctuation">)</span>        out <span class="token operator">=</span> F<span class="token punctuation">.</span>max_pool2d<span class="token punctuation">(</span>out<span class="token punctuation">)</span>                out <span class="token operator">=</span> F<span class="token punctuation">.</span>linear<span class="token punctuation">(</span>x<span class="token punctuation">,</span> self<span class="token punctuation">.</span>linear1_weight<span class="token punctuation">,</span> self<span class="token punctuation">.</span>bias3_weight<span class="token punctuation">)</span>        <span class="token keyword">return</span> out<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>关于<strong>dropout</strong>，个人强烈推荐使用<code>nn.Xxx</code>方式，因为一般情况下只有训练阶段才进行dropout，在eval阶段都不会进行dropout。使用<code>nn.Xxx</code>方式定义dropout，在调用<code>model.eval()</code>之后，model中所有的dropout layer都关闭，但以<code>nn.function.dropout</code>方式定义dropout，在调用<code>model.eval()</code>之后并不能关闭dropout。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Model1</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Model1<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>dropout <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>            <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        <span class="token keyword">class</span> <span class="token class-name">Model2</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Model2<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> F<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>x<span class="token punctuation">)</span>    m1 <span class="token operator">=</span> Model1<span class="token punctuation">(</span><span class="token punctuation">)</span>m2 <span class="token operator">=</span> Model2<span class="token punctuation">(</span><span class="token punctuation">)</span>inputs <span class="token operator">=</span> torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>m1<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>m2<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">20</span> <span class="token operator">*</span> <span class="token string">'-'</span> <span class="token operator">+</span> <span class="token string">"eval model:"</span> <span class="token operator">+</span> <span class="token number">20</span> <span class="token operator">*</span> <span class="token string">'-'</span> <span class="token operator">+</span> <span class="token string">'\r\n'</span><span class="token punctuation">)</span>m1<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>m2<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>m1<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>m2<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#%%result</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/79f6c1404e274340a8675bbf4497ffa3.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP55m95a2m5Lmg6K6w5b2V,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p><p><strong>从上面输出可以看出<code>m2</code>调用了<code>eval</code>之后，dropout照样还在正常工作。</strong></p><h3 id="2、自定义损失函数"><a href="#2、自定义损失函数" class="headerlink" title="2、自定义损失函数"></a>2、自定义损失函数</h3><p>只要Tensor算数操作（+， -，*， %，求导等）中，有一个Tesor<br>的resquire_grad=True,则该操作得到的Tensor具有反向传播，自动求导的功能。</p><p>因而只要自己实现的loss使用tensor提供的math operation就可以。</p><p>所以第一种自定义loss函数的方法就是使用tensor的math operation实现loss定义<br>继承于nn.Module<br>在forward中实现loss定义，注意：</p><p>所有的数学操作使用tensor提供的math operation<br>返回的tensor是0-dim的scalar<br>有可能会用到nn.functional中的一些操作<a href="https://www.zhihu.com/question/66988664">https://www.zhihu.com/question/66988664</a></p><p>自定义MSEloss实现：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">My_loss</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">pow</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">-</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 使用</span>criterion <span class="token operator">=</span> My_loss<span class="token punctuation">(</span><span class="token punctuation">)</span>loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>自定义entropyloss实现：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 3. 自定义交叉熵函数</span><span class="token keyword">def</span> <span class="token function">cross_entropy</span><span class="token punctuation">(</span>input_<span class="token punctuation">,</span> target<span class="token punctuation">,</span> reduction<span class="token operator">=</span><span class="token string">'elementwise_mean'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>       logsoftmax <span class="token operator">=</span> nn<span class="token punctuation">.</span>LogSoftmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>    res  <span class="token operator">=</span><span class="token operator">-</span>target <span class="token operator">*</span> logsoftmax<span class="token punctuation">(</span>input_<span class="token punctuation">)</span>    <span class="token keyword">if</span> reduction <span class="token operator">==</span> <span class="token string">'elementwise_mean'</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">elif</span> reduction <span class="token operator">==</span> <span class="token string">'sum'</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> res    <span class="token triple-quoted-string string">""" Cross entropy that accepts soft targets    Args:         pred: predictions for neural network         targets: targets, can be soft         size_average: if false, sum is returned instead of mean    Examples::        input = torch.FloatTensor([[1.1, 2.8, 1.3], [1.1, 2.1, 4.8]])        input = torch.autograd.Variable(out, requires_grad=True)        target = torch.FloatTensor([[0.05, 0.9, 0.05], [0.05, 0.05, 0.9]])        target = torch.autograd.Variable(y1)        loss = cross_entropy(input, target)        loss.backward()    """</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 深度学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pytorch </tag>
            
            <tag> 神经网络 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
